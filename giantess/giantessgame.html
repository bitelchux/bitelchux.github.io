<?xml version="1.0"  encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<html>
<head>
<title>Giantess</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link type="text/css" href="//dl.dropboxusercontent.com/u/6932226/jqui.css" rel="Stylesheet" /> 
<link type="text/css" href="//dl.dropboxusercontent.com/u/6932226/styles.css" rel="Stylesheet" />
<script src="//dl.dropboxusercontent.com/u/6932226/jq.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/cocoon.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/formaciones.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/audio.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/tools.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/sprites.js"></script>
<script src="//dl.dropboxusercontent.com/u/6932226/playerandenemies.js"></script> 
<script src="//dl.dropboxusercontent.com/u/6932226/scroll.js"></script> 	
<meta name="viewport" content="target-densitydpi=medium-dpi,width=device-width,initial-scale=1,user-scalable=no" />  
<script>
var ZIGZAG=3;
var INMOVIL=0;
var MOVIL=1;
function tictac(){
	window.requestAnimationFrame(tictac);
	
	  // Clear the canvas
	if (Game.playing){
		if (Game.vida<=0){
			Game.playing=false;
			Game.gameOver=true;
			showGameOver();
		}
		t.clearCanvas();	
		scroll(); //fondo
		drawUI();
	//	spawnSoldier();
		
		//spawnBatch();
		p.tictac();
		
		for (var idx in e) {
			var enemy=e[idx];
			enemy.comun.tictac();
			if (p.disparando){
				if (enemy.comun.x<t.cursorX && t.cursorX<enemy.comun.x+enemy.comun.w*t.scalefactor){
					if (enemy.comun.y<t.cursorY && t.cursorY<enemy.comun.y+enemy.comun.h*t.scalefactor){					
						enemy.comun.impactar(100);
					}
				}
			}
			if (enemy.comun.y>t.c.height-bodyimg.height/2*t.scalefactor+bodyy){					
					enemy.comun.tetazo();					
			}
			if( enemy.comun.tipoEne=="Soldier"){					
				var crushed=false;
				if ((enemy.comun.y>t.c.height-p2img.height*t.scalefactor/1.8+p2y && enemy.comun.x<p2img.width*t.scalefactor && enemy.comun.x>p2x))
					crushed=true;
				if ((enemy.comun.y>t.c.height-p1img.height*t.scalefactor/1.8+p1y && enemy.comun.x<p1img.width*t.scalefactor && enemy.comun.x>p1x))
					crushed=true;
				if (crushed)
					enemy.comun.tetazo();					
			}
		}
		animateGiantess();
		var thisFrameFPS = 1000 / ((now=new Date) - lastUpdate);
		if (now!=lastUpdate){
			fps += (thisFrameFPS - fps) / fpsFilter;
			lastUpdate = now;
		}	
	}
	
}
function start(){
	$("#menu").fadeOut("slow");
	$("#main").fadeIn("slow");
	Game.menu=false;
	Game.playing=true;
	weaver = window.setInterval(nextWave, 1000);
}
function restart(){
	location.reload();
}
function exit(){
Cocoon.App.exit()
}
function showGameOver(){	
  $("#main").fadeOut( "slow", function() {
    // Animation complete
	var crushed = Game.crushed
	localStorage.setItem('crushed',crushed);
	if (crushed!=null){
		$("#gameOverScore").html("<p>Score:"+ crushed +" crushed humans!!!</p>");
	}
	$("#gameOver").fadeIn("slow");
  });
}
function redim(){
	 var w = $(window).width(); // New width
	 var h = $(window).height(); // New width
	 t.w=w;
	 t.h=h;
	 t.redim();
	 
}
$(window).on('resize', function(){
	redim()
});


function now() {
  return ((new Date()).getTime());
}

function tick() {
}
</script>
</head>
<body>
	<div id="loading">
	Loading
	</div>
	<div id="menu">
		<h1>Giantess</h1>
		<div class="boton" onclick="start()">Play</div>
		<!---
		<br/>
		<div class="boton" onclick="history()">History mode</div>
		--->
		<br/>
		<script>
		var crushed = localStorage.getItem('crushed');
		if (crushed!=null){
			document.writeln("High Score:"+ crushed +" crushed humans");
		}
		if (getURLParameter("apk")!=null){
			document.writeln("<div class='boton inapk' onclick='exit()'>Exit</div>");
		}
		</script>
	</div>
	<div id="gameOver" style="position:absolute;display:none;top:0px;left:0px;border:1px solid black">	
		<h1>GameOver</h1>
		
		<div id="gameOverScore"></div>
		<div class="boton" onclick="restart()">Main Menu</div>
		<script>
		if (getURLParameter("apk")!=null){
			document.writeln("<div class='boton inapk' onclick='exit()'>Exit</div>");
		}
		</script>
	</div>
	<div id="main" style="position:absolute;display:none;top:0px;left:0px;border:1px solid black">	
	<!---
		<div id="gamesprite"  style="position:absolute;display:none;bottom:0px;left:0px;z-index:666;"><img id="mainsprite" src="busto.png" width="100%"></div>
		<div id="gamespritepie1"  style="position:absolute;bottom:0px;display:none;left:10%;z-index:665;"><img id="mainspritepie1" src="pie.png" width="100%"></div>
		<div id="gamespritepie2"  style="position:absolute;bottom:0px;display:none;right:10%;z-index:665;"><img id="mainspritepie2" src="pie.png" width="100%"></div>
		--->
		<canvas id="gamemain"  style="position:absolute;top:0px;left:0px;z-index:666;"></canvas>	
		<canvas id="gamebackground"   style="position:absolute;top:0px;left:0px"></canvas>
		
	</div>
	<!--
	<img src="tank1.png" id="scrollimg" width="10" height="10" onLoad="alert(1);scrollLoaded()"/>
	-->
<div id="debug" style="position:absolute;color:red;bottom:0px;left:0px;z-index:1000">
dbug
</div>
<div id="fps" style="position:absolute;color:red;bottom:0px;right:0px;z-index:1000">
fps
</div>
<script>
var waves=1;
var timeinseconds=0;
var fpsOut = document.getElementById('fps');
var weaver;
function nextWave(){
  if (Game.playing){
	  //fpsOut.innerHTML = parseInt(fps) + "fps time:" + timeinseconds;
	  timeinseconds++;
	  if (timeinseconds%5==0)
		spawnFormacion(timeinseconds,waves++);	
	  if (timeinseconds%2==0)
		spawnSoldado();
	}
}    
$(document).ready(function(){
	$("#loading").hide();
	$("#main").hide();
	initScroll();
	t=new Tools();
	
	document.body.onmousedown = function() { 
		t.mouseDown = 1;
	}
	document.body.onmouseup = function() {
		t.mouseDown = 0;
	}
	
	
	
	if ('ontouchstart' in document.documentElement) {	
		document.getElementById("gamemain").addEventListener("touchstart", tap,false);
		document.getElementById("gamemain").addEventListener("touchend", untap,false);
	  //document.getElementById("gamemain").addEventListener("touchmove", tap,false);	
	}else{
		document.getElementById("gamemain").addEventListener("mousedown", tap,false);		
		document.getElementById("gamemain").addEventListener("mouseup", untap,false);	
		//document.getElementById("gamemain").addEventListener("mousemove", tap,false);		
	}
	redim();
	initSprites();
	p=new Player();
	e=new Array();	
	tictac();	
	
/*
	window.addEventListener('touchmove', function(e) {	
		e.preventDefault();
		console.log("tm");
	}, false);
	window.addEventListener('touchend', function(e) {
		
		e.preventDefault();
		console.log("te");
	}, false);
	window.addEventListener('mousemove', function(e) {
		e.preventDefault();
		console.log("mm");
	}, false);
	window.addEventListener('mousedown', function(e) {
		e.preventDefault();
		console.log("md");
	}, false);
	*/

});
</script>
	<iframe frameborder="no" src="http://contador.elracano.com/giantessgame" width="10" height="10"></iframe>

</body>