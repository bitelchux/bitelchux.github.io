/*
 MelonJS Game Engine
 @copyright (C) 2011 - 2014 Olivier Biot, Jason Oster, Aaron McLeod
 http://www.melonjs.org

 melonJS is licensed under the MIT License.
 http://www.opensource.org/licenses/mit-license.php
 Tween JS
 https://github.com/sole/Tween.js
 MinPubSub
 a micro publish/subscribe messaging framework
 @see https://github.com/daniellmb/MinPubSub
 @author Daniel Lamb <daniellmb.com>

 Released under the MIT License
*/
(function(){function a(){if(!c){if(!document.body)return setTimeout(a,13);document.removeEventListener?document.removeEventListener("DOMContentLoaded",a,!1):window.removeEventListener("load",a,!1);c=!0;for(var b=0;b<d.length;b++)d[b].call(window,[]);d.length=0;"function"===typeof define&&define.amd&&define("me",[],function(){return me})}}window.me=window.me||{};var b=!1,c=!1,d=[];window.onReady=function(e){b||(b=!0,"complete"===document.readyState?a():(document.addEventListener&&document.addEventListener("DOMContentLoaded",
a,!1),window.addEventListener("load",a,!1)));c?e.call(window,[]):d.push(function(){return e.call(window,[])});return this};if(!0!==me.skipAutoInit)window.onReady(function(){me.boot()});else me.init=function(){me.boot();a()};window.throttle||(window.throttle=function(a,b,c){var d=window.performance.now(),k;"boolean"!==typeof b&&(b=!1);return function(){var l=window.performance.now(),m=l-d,q=arguments;if(m<a)!1===b&&(clearTimeout(k),k=setTimeout(function(){d=l;return c.apply(null,q)},m));else return d=
l,c.apply(null,q)}});"undefined"===typeof console&&(console={log:function(){},info:function(){},error:function(){alert(Array.prototype.slice.call(arguments).join(", "))}})})();Object.defineProperty||(Object.defineProperty=function(a,b,c){if(a.__defineGetter__)c.get&&a.__defineGetter__(b,c.get),c.set&&a.__defineSetter__(b,c.set);else throw new TypeError("Object.defineProperty not supported");});"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;return new b});
if(!Function.prototype.bind){var Empty=function(){};Function.prototype.bind=function(a){var b=this;if("function"!==typeof b)throw new TypeError("Function.prototype.bind called on incompatible "+b);var c=Array.prototype.slice.call(arguments,1),d=function(){if(this instanceof d){var e=b.apply(this,c.concat(Array.prototype.slice.call(arguments)));return Object(e)===e?e:this}return b.apply(a,c.concat(Array.prototype.slice.call(arguments)))};b.prototype&&(Empty.prototype=b.prototype,d.prototype=new Empty,
Empty.prototype=null);return d}}
(function(){function a(a,b,e){Object.keys(e).forEach(function(f){b[f]=e[f];if("function"!==typeof e[f])throw new TypeError("extend: Method `"+f+"` is not a function");Object.defineProperty(a.prototype,f,{configurable:!0,value:e[f]})})}function b(a,b,e){return a.prototype[b].apply(this,e)}Object.defineProperty(Object.prototype,"extend",{value:function(){function c(){this.init.apply(this,arguments);return this}var d={},e=Array.prototype.slice.call(arguments,0);c.prototype=Object.create(this.prototype);
e.forEach(function(b){a(c,d,b.__methods__||b)});if(!("init"in c.prototype))throw new TypeError("extend: Class is missing a constructor named `init`");Object.defineProperty(c.prototype,"_super",{value:b});Object.defineProperty(c,"__methods__",{value:d});return c}})})();me.Error=Error.extend({init:function(a){this.name="me.Error";this.message=a}});Function.prototype.defer=function(){return setTimeout(this.bind.apply(this,arguments),0.01)};
Number.prototype.clamp=function(a,b){return this<a?a:this>b?b:+this};Number.prototype.random=function(a,b){b||(b=a,a=this);return~~(Math.random()*(b-a))+a};Number.prototype.randomFloat=function(a,b){b||(b=a,a=this);return Math.random()*(b-a)+a};Number.prototype.weightedRandom=function(a,b){b||(b=a,a=this);return~~(Math.pow(Math.random(),2)*(b-a))+a};Number.prototype.round=function(a,b){a=2>arguments.length?this:a;var c=Math.pow(10,b||a||0);return~~(0.5+a*c)/c};
Number.prototype.toHex=function(){return"0123456789ABCDEF".charAt(this-this%16>>4)+"0123456789ABCDEF".charAt(this%16)};Number.prototype.sign=function(){return 0>this?-1:0<this?1:0};Number.prototype.degToRad=function(a){return(a||this)/180*Math.PI};Number.prototype.radToDeg=function(a){return(a||this)*(180/Math.PI)};String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")});
String.prototype.trimLeft||(String.prototype.trimLeft=function(){return this.replace(/^\s+/,"")});String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")});String.prototype.isNumeric=function(){return!isNaN(this)&&""!==this.trim()};String.prototype.isBoolean=function(){var a=this.trim();return"true"===a||"false"===a};String.prototype.contains||(String.prototype.contains=function(a,b){return-1!==String.prototype.indexOf.call(this,a,b)});
String.prototype.toHex=function(){for(var a="",b=0;b<this.length;)a+=this.charCodeAt(b++).toString(16);return a};Array.prototype.remove=function(a){a=Array.prototype.indexOf.call(this,a);-1!==a&&Array.prototype.splice.call(this,a,1);return this};Array.prototype.forEach||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d--;c++)a.call(b||this,this[c],c,this)});Array.isArray||(Array.isArray=function(a){return a instanceof Array});Array.prototype.random=function(a){return a[(0).random(a.length)]};
Array.prototype.weightedRandom=function(a){return a[(0).weightedRandom(a.length)]};me.TypedArray=function(a){var b=0;if(Array.isArray(a))for(b=0;b<a.length;b++)this.push(a[b]);else if(1===arguments.length&&"number"===typeof a)for(b=0;b<a;b++)this.push(0);else throw new me.Error("TypedArray polyfill: Unsupported constructor arguments",arguments);};me.TypedArray.prototype=Array.prototype;window.Float32Array=window.Float32Array||me.TypedArray;window.Uint16Array=window.Uint16Array||me.TypedArray;
window.Uint32Array=window.Uint32Array||me.TypedArray;"undefined"===typeof window.performance&&(window.performance={});"undefined"===typeof Date.now&&(Date.now=function(){return(new Date).getTime()});if(!window.performance.now){var timeOffset=Date.now();window.performance.timing&&window.performance.timing.navigationStart&&(timeOffset=window.performance.timing.navigationStart);window.performance.now=function(){return Date.now()-timeOffset}}
(function(){me.mod="melonJS";me.version="2.0.2";me.sys={fps:60,interpolation:!1,scale:null,scalingInterpolation:!1,gravity:void 0,stopOnAudioError:!0,pauseOnBlur:!0,resumeOnFocus:!0,stopOnBlur:!1,preRender:!1,checkVersion:function(a,c){c=c||me.version;for(var d=a.split("."),e=c.split("."),f=Math.min(d.length,e.length),h=0,g=0;g<f&&!(h=+d[g]-+e[g]);g++);return h?h:d.length-e.length}};var a=!1;Object.defineProperty(me,"initialized",{get:function(){return a}});me.boot=function(){a||(me.device._check(),
me.save._init(),me.loader.setNocache(document.location.href.match(/\?nocache/)||!1),me.timer.init(),me.mapReader=new me.TMXMapReader,me.state.init(),me.pool.init(),!1===me.device.isMobile&&me.input._enableKeyboardEvent(),me.levelDirector.reset(),a=!0)}})();
(function(){me.game=function(){var a={},b=!1,c=!0,d=0,e=1,f=null;a.viewport=null;a.currentLevel=null;a.world=null;a.mergeGroup=!0;a.sortOn="z";a.tmxRenderer=null;a.onLevelLoaded=null;a.init=function(d,e){b||(d=d||me.video.renderer.getWidth(),e=e||me.video.renderer.getHeight(),a.viewport=new me.Viewport(0,0,d,e),a.world=new me.Container(0,0,d,e),a.world.name="rootContainer",me.collision.init(),f=me.video.renderer,me.event.publish(me.event.GAME_INIT),me.input._translatePointerEvents(),c=!0,a.currentLevel=
{pos:{x:0,y:0}},b=!0)};a.reset=function(){me.collision.quadTree.clear();a.world.destroy();a.viewport&&a.viewport.reset();a.currentLevel={pos:{x:0,y:0}};f.resetTransform();d=0;e=~~(0.5+60/me.sys.fps)};a.getParentContainer=function(a){return a.ancestor};a.repaint=function(){c=!0};a.update=function(b){0===++d%e&&(d=0,me.timer.update(b),me.collision.quadTree.clear(),me.collision.quadTree.insertContainer(a.world),c=a.world.update(me.timer.getDelta())||c,c=a.viewport.update(me.timer.getDelta())||c)};a.draw=
function(){if(c){var b=a.viewport.pos.x+~~a.viewport.offset.x,d=a.viewport.pos.y+~~a.viewport.offset.y;a.world.transform.translate(-b,-d);a.viewport.screenX=b-a.currentLevel.pos.x;a.viewport.screenY=d-a.currentLevel.pos.y;a.world.draw(f,a.viewport);a.world.transform.translate(b,d);a.viewport.draw(f)}c=!1;me.video.renderer.blitSurface()};return a}()})();
(function(){me.agent=function(){var a={},b=["ms","MS","moz","webkit","o"];a.prefixed=function(a,d){d=d||window;if(a in d)return d[a];var e=a.substring(0,1).toUpperCase()+a.substring(1,a.length),f;b.some(function(a){a+=e;return f=a in d?d[a]:void 0});return f};a.setPrefixed=function(a,d,e){e=e||window;if(a in e)e[a]=d;else{var f=a.substring(0,1).toUpperCase()+a.substring(1,a.length);b.some(function(a){a+=f;return a in e?(e[a]=d,!0):!1})}};return a}()})();
(function(){me.device=function(){function a(a){a.reading?(c.accelerationX=a.reading.accelerationX,c.accelerationY=a.reading.accelerationY,c.accelerationZ=a.reading.accelerationZ):(c.accelerationX=a.accelerationIncludingGravity.x,c.accelerationY=a.accelerationIncludingGravity.y,c.accelerationZ=a.accelerationIncludingGravity.z)}function b(a){c.gamma=a.gamma;c.beta=a.beta;c.alpha=a.alpha}var c={},d=!1,e=!1,f=null;c._check=function(){me.device._detectDevice();me.device.pointerEnabled=me.agent.prefixed("pointerEnabled",
navigator);navigator.maxTouchPoints=me.agent.prefixed("maxTouchPoints",navigator)||0;window.gesture=me.agent.prefixed("gesture");me.device.touch="createTouch"in document||"ontouchstart"in window||navigator.isCocoonJS||me.device.pointerEnabled&&0<navigator.maxTouchPoints;me.device.hasAccelerometer="undefined"!==typeof window.DeviceMotionEvent||"undefined"!==typeof window.Windows&&"function"===typeof Windows.Devices.Sensors.Accelerometer;if(this.hasPointerLockSupport=me.agent.prefixed("pointerLockElement",
document))document.exitPointerLock=me.agent.prefixed("exitPointerLock",document);window.DeviceOrientationEvent&&(me.device.hasDeviceOrientation=!0);this.hasFullscreenSupport=me.agent.prefixed("fullscreenEnabled",document)||document.mozFullScreenEnabled;document.exitFullscreen=me.agent.prefixed("cancelFullScreen",document)||me.agent.prefixed("exitFullscreen",document);navigator.vibrate=me.agent.prefixed("vibrate",navigator);try{c.localStorage=!!window.localStorage}catch(a){c.localStorage=!1}window.addEventListener("blur",
function(){me.sys.stopOnBlur&&me.state.stop(!0);me.sys.pauseOnBlur&&me.state.pause(!0)},!1);window.addEventListener("focus",function(){me.sys.stopOnBlur&&me.state.restart(!0);me.sys.resumeOnFocus&&me.state.resume(!0)},!1);var b,d;"undefined"!==typeof document.hidden?(b="hidden",d="visibilitychange"):"undefined"!==typeof document.mozHidden?(b="mozHidden",d="mozvisibilitychange"):"undefined"!==typeof document.msHidden?(b="msHidden",d="msvisibilitychange"):"undefined"!==typeof document.webkitHidden&&
(b="webkitHidden",d="webkitvisibilitychange");"string"===typeof d&&document.addEventListener(d,function(){document[b]?(me.sys.stopOnBlur&&me.state.stop(!0),me.sys.pauseOnBlur&&me.state.pause(!0)):(me.sys.stopOnBlur&&me.state.restart(!0),me.sys.resumeOnFocus&&me.state.resume(!0))},!1)};c._detectDevice=function(){me.device.iOS=me.device.ua.match(/iPhone|iPad|iPod/i)||!1;me.device.android=me.device.ua.match(/Android/i)||!1;me.device.android2=me.device.ua.match(/Android 2/i)||!1;me.device.wp=me.device.ua.match(/Windows Phone/i)||
!1;me.device.BlackBerry=me.device.ua.match(/BlackBerry/i)||!1;me.device.Kindle=me.device.ua.match(/Kindle|Silk.*Mobile Safari/i)||!1;me.device.isMobile=me.device.ua.match(/Mobi/i)||me.device.iOS||me.device.android||me.device.wp||me.device.BlackBerry||me.device.Kindle||me.device.iOS||!1};c.ua=navigator.userAgent;c.localStorage=!1;c.hasAccelerometer=!1;c.hasDeviceOrientation=!1;c.hasFullscreenSupport=!1;c.hasPointerLockSupport=!1;c.nativeBase64="function"===typeof window.atob;c.touch=!1;c.isMobile=
!1;c.iOS=!1;c.android=!1;c.android2=!1;c.wp=!1;c.BlackBerry=!1;c.Kindle=!1;c.orientation=0;c.accelerationX=0;c.accelerationY=0;c.accelerationZ=0;c.gamma=0;c.beta=0;c.alpha=0;c.requestFullscreen=function(a){this.hasFullscreenSupport&&(a=a||me.video.getWrapper(),a.requestFullscreen=me.agent.prefixed("requestFullscreen",a)||a.mozRequestFullScreen,a.requestFullscreen())};c.exitFullscreen=function(){this.hasFullscreenSupport&&document.exitFullscreen()};c.getPixelRatio=function(){if(null===f){var a;a="undefined"!==
typeof me.video.renderer?me.video.renderer.getScreenContext():me.CanvasRenderer.getContext2d(document.createElement("canvas"));var b=window.devicePixelRatio||1;a=me.agent.prefixed("backingStorePixelRatio",a)||1;f=b/a}return f};c.getStorage=function(a){a=a||"local";switch(a){case "local":return me.save;default:throw new me.Error("storage type "+a+" not supported");}};c.turnOnPointerLock=function(){if(this.hasPointerLockSupport){var a=me.video.getWrapper();if(me.device.ua.match(/Firefox/i)){var b=function(){(me.agent.prefixed("fullscreenElement",
document)||document.mozFullScreenElement)===a&&(document.removeEventListener("fullscreenchange",b),document.removeEventListener("mozfullscreenchange",b),a.requestPointerLock=me.agent.prefixed("requestPointerLock",a),a.requestPointerLock())};document.addEventListener("fullscreenchange",b,!1);document.addEventListener("mozfullscreenchange",b,!1);me.device.requestFullscreen()}else a.requestPointerLock()}};c.turnOffPointerLock=function(){this.hasPointerLockSupport&&document.exitPointerLock()};c.watchAccelerometer=
function(){if(me.device.hasAccelerometer){if(!d){if("undefined"===typeof Windows)window.addEventListener("devicemotion",a,!1);else{var b=Windows.Devices.Sensors.Accelerometer.getDefault();if(b){var c=b.minimumReportInterval;b.reportInterval=16<=c?c:25;b.addEventListener("readingchanged",a,!1)}}d=!0}return!0}return!1};c.unwatchAccelerometer=function(){d&&("undefined"===typeof Windows?window.removeEventListener("devicemotion",a,!1):Windows.Device.Sensors.Accelerometer.getDefault().removeEventListener("readingchanged",
a,!1),d=!1)};c.watchDeviceOrientation=function(){me.device.hasDeviceOrientation&&!e&&(window.addEventListener("deviceorientation",b,!1),e=!0);return!1};c.unwatchDeviceOrientation=function(){e&&(window.removeEventListener("deviceorientation",b,!1),e=!1)};c.vibrate=function(a){navigator.vibrate&&navigator.vibrate(a)};return c}();Object.defineProperty(me.device,"isFullscreen",{get:function(){return me.device.hasFullscreenSupport?(me.agent.prefixed("fullscreenElement",document)||document.mozFullScreenElement)===
me.video.getWrapper():!1}});Object.defineProperty(me.device,"sound",{get:function(){return!Howler.noAudio}})})();
(function(){me.timer=function(){var a={},b=0,c=0,d=0,e=0,f=0,h=Math.ceil(1E3/me.sys.fps),g=1.25*(1E3/me.sys.fps),k=[],l=0,m=function(a){for(var b=0,c=k.length;b<c;b++)if(k[b].timerId===a){k.splice(b,1);break}},q=function(a){for(var b=0,c=k.length;b<c;b++){var d=k[b];d.pauseable&&me.state.isPaused()||(d.elapsed+=a);d.elapsed>=d.delay&&(d.func.apply(this),!0===d.repeat?d.elapsed-=d.delay:me.timer.clearTimeout(d.timerId))}};a.tick=1;a.fps=0;a.init=function(){a.reset();e=d=0};a.reset=function(){d=e=window.performance.now();
b=c=f=0};a.setTimeout=function(a,b,c){k.push({func:a,delay:b,elapsed:0,repeat:!1,timerId:++l,pauseable:!0===c||!0});return l};a.setInterval=function(a,b,c){k.push({func:a,delay:b,elapsed:0,repeat:!0,timerId:++l,pauseable:!0===c||!0});return l};a.clearTimeout=function(a){m.defer(this,a)};a.clearInterval=function(a){m.defer(this,a)};a.getTime=function(){return e};a.getDelta=function(){return f};a.countFPS=function(){b++;c+=f;0===b%10&&(this.fps=(~~(1E3*b/c)).clamp(0,me.sys.fps),b=c=0)};a.update=function(b){d=
e;e=b;f=e-d;a.tick=f>g&&me.sys.interpolation?f/h:1;q(f);return f};return a}()})();
(function(){me.pool=function(){var a={},b={};a.init=function(){a.register("me.Entity",me.Entity);a.register("me.CollectableEntity",me.CollectableEntity);a.register("me.LevelEntity",me.LevelEntity);a.register("TileObject",me.Sprite);a.register("me.Tween",me.Tween,!0);a.register("me.Color",me.Color,!0);a.register("me.Particle",me.Particle,!0)};a.register=function(a,d,e){e?b[a.toLowerCase()]={"class":d,pool:[]}:b[a.toLowerCase()]={"class":d,pool:void 0}};a.pull=function(a){var d="string"===typeof a?
a.toLowerCase():void 0,e=Array.prototype.slice.call(arguments);if(d&&b[d]){var f;if(!b[d].pool)return f=b[d]["class"],e[0]=f,new (f.bind.apply(f,e));var h=b[d];f=h["class"];0<h.pool.length?(f=h.pool.pop(),"function"===typeof f.init&&f.init.apply(f,e.slice(1)),"function"===typeof f.onResetEvent&&f.onResetEvent.apply(f,e.slice(1))):(e[0]=f,f=new (f.bind.apply(f,e)),f.className=d);return f}d&&console.error("Cannot instantiate entity of type '"+a+"': Class not found!");return null};a.purge=function(){for(var a in b)b.hasOwnProperty(a)&&
(b[a].pool=[])};a.push=function(a){var d=a.className;"undefined"!==typeof d&&b[d]&&b[d].pool.push(a)};return a}()})();
(function(){me.Vector2d=Object.extend({init:function(a,b){return this.set(a||0,b||0)},set:function(a,b){if(a!==+a||b!==+b)throw new me.Vector2d.Error("invalid x,y parameters (not a number)");this.x=a;this.y=b;return this},setZero:function(){return this.set(0,0)},setV:function(a){this.x=a.x;this.y=a.y;return this},add:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},scale:function(a,b){this.x*=a;this.y*="undefined"!==typeof b?b:a;return this},scaleV:function(a){this.x*=
a.x;this.y*=a.y;return this},div:function(a){this.x/=a;this.y/=a;return this},abs:function(){0>this.x&&(this.x=-this.x);0>this.y&&(this.y=-this.y);return this},clamp:function(a,b){return new me.Vector2d(this.x.clamp(a,b),this.y.clamp(a,b))},clampSelf:function(a,b){this.x=this.x.clamp(a,b);this.y=this.y.clamp(a,b);return this},minV:function(a){this.x=this.x<a.x?this.x:a.x;this.y=this.y<a.y?this.y:a.y;return this},maxV:function(a){this.x=this.x>a.x?this.x:a.x;this.y=this.y>a.y?this.y:a.y;return this},
floor:function(){return new me.Vector2d(~~this.x,~~this.y)},floorSelf:function(){this.x=~~this.x;this.y=~~this.y;return this},ceil:function(){return new me.Vector2d(Math.ceil(this.x),Math.ceil(this.y))},ceilSelf:function(){this.x=Math.ceil(this.x);this.y=Math.ceil(this.y);return this},negate:function(){return new me.Vector2d(-this.x,-this.y)},negateSelf:function(){this.x=-this.x;this.y=-this.y;return this},copy:function(a){this.x=a.x;this.y=a.y;return this},equals:function(a){return this.x===a.x&&
this.y===a.y},normalize:function(){var a=this.length();0<a&&(this.x/=a,this.y/=a);return this},perp:function(){var a=this.x;this.x=this.y;this.y=-a;return this},rotate:function(a){var b=this.x,c=this.y;this.x=b*Math.cos(a)-c*Math.sin(a);this.y=b*Math.sin(a)+c*Math.cos(a);return this},reverse:function(){this.x=-this.x;this.y=-this.y;return this},dotProduct:function(a){return this.x*a.x+this.y*a.y},length2:function(){return this.dotProduct(this)},length:function(){return Math.sqrt(this.length2())},
distance:function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))},angle:function(a){return Math.atan2(a.y-this.y,a.x-this.x)},project:function(a){var b=this.dotProduct(a)/a.length2();this.x=b*a.x;this.y=b*a.y;return this},projectN:function(a){var b=this.dotProduct(a);this.x=b*a.x;this.y=b*a.y;return this},reflect:function(a){var b=this.x,c=this.y;this.project(a).scale(2);this.x-=b;this.y-=c;return this},reflectN:function(a){var b=this.x,c=this.y;this.projectN(a).scale(2);
this.x-=b;this.y-=c;return this},clone:function(){return new me.Vector2d(this.x,this.y)},toString:function(){return"x:"+this.x+",y:"+this.y}});me.Vector2d.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Vector2d.Error"}})})();
(function(){me.Rect=Object.extend({init:function(a,b,c,d){this.pos=new me.Vector2d(a,b);this.width=c;this.height=d;this.shapeType="Rectangle"},setShape:function(a,b,c,d){this.pos.set(a,b);this.resize(c,d);return this},resize:function(a,b){this.width=a;this.height=b;return this},getBounds:function(){return this},updateBounds:function(){return this},clone:function(){return new me.Rect(this.pos.x,this.pos.y,this.width,this.height)},copy:function(a){return this.setShape(a.pos.x,a.pos.y,a.width,a.height)},
translate:function(a,b){this.pos.x+=a;this.pos.y+=b;return this},translateV:function(a){return this.translate(a.x,a.y)},union:function(a){var b=Math.min(this.left,a.left),c=Math.min(this.top,a.top);this.resize(Math.max(this.right,a.right)-b,Math.max(this.bottom,a.bottom)-c);this.pos.set(b,c);return this},overlaps:function(a){return this.left<a.right&&a.left<this.right&&this.top<a.bottom&&a.top<this.bottom},contains:function(a){return a.left>=this.left&&a.right<=this.right&&a.top>=this.top&&a.bottom<=
this.bottom},containsPointV:function(a){return this.containsPoint(a.x,a.y)},containsPoint:function(a,b){return a>=this.left&&a<=this.right&&b>=this.top&&b<=this.bottom},toPolygon:function(){var a=this.pos,b=this.width,c=this.height;return new me.Polygon(a.x,a.y,[new me.Vector2d,new me.Vector2d(b,0),new me.Vector2d(b,c),new me.Vector2d(0,c)])}});Object.defineProperty(me.Rect.prototype,"left",{get:function(){return this.pos.x},configurable:!0});Object.defineProperty(me.Rect.prototype,"right",{get:function(){return this.pos.x+
this.width||this.width},configurable:!0});Object.defineProperty(me.Rect.prototype,"top",{get:function(){return this.pos.y},configurable:!0});Object.defineProperty(me.Rect.prototype,"bottom",{get:function(){return this.pos.y+this.height||this.height},configurable:!0})})();
(function(){me.Ellipse=Object.extend({init:function(a,b,c,d){this.pos=new me.Vector2d;this.bounds=void 0;this.radius=NaN;this.radiusV=new me.Vector2d;this.radiusSq=new me.Vector2d;this.ratio=new me.Vector2d;this.shapeType="Ellipse";this.setShape(a,b,c,d)},setShape:function(a,b,c,d){c/=2;d/=2;this.pos.set(a,b);this.radius=Math.max(c,d);this.ratio.set(c/this.radius,d/this.radius);this.radiusV.set(this.radius,this.radius).scaleV(this.ratio);a=this.radius*this.radius;this.radiusSq.set(a,a).scaleV(this.ratio);
this.updateBounds();return this},rotate:function(){return this},scale:function(a,b){return this.setShape(this.pos.x,this.pos.y,2*this.radiusV.x*a,2*this.radiusV.y*("undefined"!==typeof b?b:a))},scaleV:function(a){return this.scale(a.x,a.y)},translate:function(a,b){this.pos.x+=a;this.pos.y+=b;this.bounds.translate(a,b);return this},translateV:function(a){this.pos.add(a);this.bounds.translateV(a);return this},containsPointV:function(a){return this.containsPoint(a.x,a.y)},containsPoint:function(a,b){a-=
this.pos.x;b-=this.pos.y;return 1>=a*a/this.radiusSq.x+b*b/this.radiusSq.y},getBounds:function(){return this.bounds},updateBounds:function(){var a=this.radiusV.x,b=this.radiusV.y,c=this.pos.x-a,d=this.pos.y-b,a=2*a,b=2*b;this.bounds?this.bounds.setShape(c,d,a,b):this.bounds=new me.Rect(c,d,a,b);return this.bounds},clone:function(){return new me.Ellipse(this.pos.x,this.pos.y,2*this.radiusV.x,2*this.radiusV.y)}})})();
(function(){me.Polygon=Object.extend({init:function(a,b,c){this.pos=new me.Vector2d;this.bounds=void 0;this.points=null;this.shapeType="Polygon";this.setShape(a,b,c)},setShape:function(a,b,c){this.pos.set(a,b);this.points=c;this.recalc();this.updateBounds();return this},rotate:function(a){if(0!==a){for(var b=this.points,c=b.length,d=0;d<c;d++)b[d].rotate(a);this.recalc();this.updateBounds()}return this},scale:function(a,b){b="undefined"!==typeof b?b:a;for(var c=this.points,d=c.length,e=0;e<d;e++)c[e].scale(a,
b);this.recalc();this.updateBounds();return this},scaleV:function(a){return this.scale(a.x,a.y)},recalc:function(){var a,b=this.edges=[],c=this.normals=[],d=this.points,e=d.length;if(3>e)throw new me.Polygon.Error("Requires at least 3 points");for(a=0;a<e;a++){var f=(new me.Vector2d).copy(d[(a+1)%e]).sub(d[a]);b.push(f);c.push((new me.Vector2d).copy(f).perp().normalize())}return this},translate:function(a,b){this.pos.x+=a;this.pos.y+=b;this.bounds.translate(a,b);return this},translateV:function(a){this.pos.add(a);
this.bounds.translateV(a);return this},containsPointV:function(a){return this.containsPoint(a.x,a.y)},containsPoint:function(a,b){for(var c=!1,d=this.pos.x,e=this.pos.y,f=this.points,h=f.length,g=0,k=h-1;g<h;k=g++){var l=f[g].y+e,m=f[g].x+d,q=f[k].y+e,k=f[k].x+d;l>b!==q>b&&a<(k-m)*(b-l)/(q-l)+m&&(c=!c)}return c},getBounds:function(){return this.bounds},updateBounds:function(){var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity;this.points.forEach(function(e){a=Math.min(a,e.x);b=Math.min(b,e.y);c=Math.max(c,
e.x);d=Math.max(d,e.y)});this.bounds?this.bounds.setShape(a,b,c-a,d-b):this.bounds=new me.Rect(a,b,c-a,d-b);return this.bounds.translateV(this.pos)},clone:function(){var a=[];this.points.forEach(function(b){a.push(new me.Vector2d(b.x,b.y))});return new me.Polygon(this.pos.x,this.pos.y,a)}});me.Polygon.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Polygon.Error"}})})();
(function(){me.Line=me.Polygon.extend({containsPointV:function(a){return this.containsPoint(a.x,a.y)},containsPoint:function(a,b){a-=this.pos.x;b-=this.pos.y;var c=this.points[0],d=this.points[1];return(b-c.y)*(d.x-c.x)===(d.y-c.y)*(a-c.x)},recalc:function(){var a=this.edges=[],b=this.normals=[],c=this.points;if(2!==c.length)throw new me.Line.Error("Requires exactly 2 points");c=(new me.Vector2d).copy(c[1]).sub(c[0]);a.push(c);b.push((new me.Vector2d).copy(c).perp().normalize());return this}});me.Line.Error=
me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Line.Error"}})})();
(function(){me.Matrix2d=Object.extend({init:function(a){this.val=new Float32Array(6);a?this.copy(a):this.identity()},identity:function(){this.set(1,0,0,1,0,0);return this},set:function(a,b,c,d,e,f){var h=this.val;h[0]=a;h[1]=b;h[2]=c;h[3]=d;h[4]=e;h[5]=f;return this},multiply:function(a){var b=this.val,c=a.val;a=b[0];var d=b[1],e=b[2],f=b[3],h=b[4],g=b[5],k=c[0],l=c[1],m=c[2],q=c[3],r=c[4],c=c[5];b[0]=a*k+e*l;b[1]=d*k+f*l;b[2]=a*m+e*q;b[3]=d*m+f*q;b[4]=a*r+e*c+h;b[5]=d*r+f*c+g;return this},scale:function(a,
b){var c=this.val;c[0]*=a;c[1]*=a;c[2]*=b;c[3]*=b;return this},rotate:function(a){if(0!==a){var b=this.val,c=b[0],d=b[1],e=b[2],f=b[3],h=Math.sin(a);a=Math.cos(a);b[0]=c*a+e*h;b[1]=d*a+f*h;b[2]=c*-h+e*a;b[3]=d*-h+f*a}return this},translate:function(a,b){var c=this.val;c[4]+=a;c[5]+=b;return this},translateV:function(a){return this.translate(a.x,a.y)},isIdentity:function(){var a=this.val;return 1===a[0]&&0===a[1]&&0===a[2]&&1===a[3]&&0===a[4]&&0===a[5]},clone:function(){return new me.Matrix2d(this)},
toString:function(){var a=this.val;return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"}})})();
(function(){me.Matrix3d=Object.extend({init:function(a){this.val=new Float32Array(9);a?this.copy(a):this.identity()},adjoint:function(){var a=this.val,b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],h=a[5],g=a[6],k=a[7],l=a[8];a[0]=f*l-h*k;a[1]=d*k-c*l;a[2]=c*h-d*f;a[3]=h*g-e*l;a[4]=b*l-d*g;a[5]=d*e-b*h;a[6]=e*k-f*g;a[7]=c*g-b*k;a[8]=b*f-c*e;return this},isIdentity:function(){var a=this.val;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},clone:function(){return new me.Matrix3d(this)},
copy:function(a){var b=this.val;a=a.val;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},determinant:function(){var a=this.val,b=a[3],c=a[4],d=a[5],e=a[6],f=a[7],h=a[8];return a[0]*(h*c-d*f)+a[1]*(-h*b+d*e)+a[2]*(f*b-c*e)},identity:function(){var a=this.val;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},invert:function(){var a=this.val,b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],h=a[5],g=a[6],k=a[7],l=a[8],m=l*f-h*k,q=-l*e+
h*g,r=k*e-f*g,n=b*m+c*q+d*r;if(!n)return null;n=1/n;a[0]=m*n;a[1]=(-l*c+d*k)*n;a[2]=(h*c-d*f)*n;a[3]=q*n;a[4]=(l*b-d*g)*n;a[5]=(-h*b+d*e)*n;a[6]=r*n;a[7]=(-k*b+c*g)*n;a[8]=(f*b-c*e)*n;return this},multiply:function(a){return this.multiplyArray(a.val)},multiplyArray:function(a){var b=this.val,c=b[0],d=b[1],e=b[2],f=b[3],h=b[4],g=b[5],k=b[6],l=b[7],m=b[8],q=a[0],r=a[1],n=a[2],v=a[3],p=a[4],s=a[5],t=a[6],w=a[7];a=a[8];b[0]=q*c+r*f+n*k;b[1]=q*d+r*h+n*l;b[2]=q*e+r*g+n*m;b[3]=v*c+p*f+s*k;b[4]=v*d+p*h+s*
l;b[5]=v*e+p*g+s*m;b[6]=t*c+w*f+a*k;b[7]=t*d+w*h+a*l;b[8]=t*e+w*g+a*m;return this},rotate:function(a){var b=this.val,c=b[0],d=b[1],e=b[2],f=b[3],h=b[4],g=b[5],k=Math.sin(a);a=Math.cos(a);b[0]=a*c+k*f;b[1]=a*d+k*h;b[2]=a*e+k*g;b[3]=a*f-k*c;b[4]=a*h-k*d;b[5]=a*g-k*e;return this},scale:function(a,b){var c=this.val;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=b;c[4]*=b;c[5]*=b;return this},set:function(a,b,c,d,e,f,h,g,k){var l=this.val;l[0]=a;l[1]=b;l[2]=c;l[3]=d;l[4]=e;l[5]=f;l[6]=h;l[7]=g;l[8]=k;return this},translate:function(a,
b){var c=this.val;c[6]=a*c[0]+b*c[3]+c[6];c[7]=a*c[1]+b*c[4]+c[7];c[8]=a*c[2]+b*c[5]+c[8];return this},translateV:function(a){return this.translate(a.x,a.y)},transform:function(a,b,c,d,e,f){var h=this.val;h[0]=a;h[1]=c;h[2]=e;h[3]=b;h[4]=d;h[5]=f;h[6]=0;h[7]=0;h[8]=1;return this},transpose:function(){var a=this.val,b=a[1],c=a[2],d=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=c;a[7]=d;return this},toString:function(){var a=this.val;return"mat3d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+
a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"}})})();
(function(){me.Body=me.Rect.extend({init:function(a,b){this.entity=a;this.shapes=b||[];this.collisionMask=me.collision.types.ALL_OBJECT;this.collisionType=me.collision.types.ENEMY_OBJECT;"undefined"===typeof this.vel&&(this.vel=new me.Vector2d);this.vel.set(0,0);"undefined"===typeof this.accel&&(this.accel=new me.Vector2d);this.accel.set(0,0);"undefined"===typeof this.friction&&(this.friction=new me.Vector2d);this.friction.set(0,0);"undefined"===typeof this.maxVel&&(this.maxVel=new me.Vector2d);this.maxVel.set(1E3,
1E3);this.gravity="undefined"!==typeof me.sys.gravity?me.sys.gravity:0.98;this.falling=!1;this.jumping=!0;this._super(me.Rect,"init",[0,0,a.width,a.height])},addShape:function(a){"Rectangle"===a.shapeType?this.shapes.push(a.toPolygon()):this.shapes.push(a);this.updateBounds();return this.shapes.length},getShape:function(a){return this.shapes[a||0]},removeShape:function(a){this.shapes.remove(a);this.updateBounds();return this.shapes.length},removeShapeAt:function(a){return this.removeShape(this.getShape(a))},
setCollisionMask:function(a){this.collisionMask=a},respondToCollision:function(a){a=a.overlapV;this.entity.pos.sub(a);0!==a.x&&(this.vel.x=~~(0.5+this.vel.x-a.x)||0);0!==a.y&&(this.vel.y=~~(0.5+this.vel.y-a.y)||0,this.falling=1<=a.y,this.jumping=-1>=a.y);this.entity.updateBounds()},updateBounds:function(){if(0<this.shapes.length){var a=this.shapes[0].getBounds();this.pos.setV(a.pos);this.resize(a.width,a.height);for(a=1;a<this.shapes.length;a++)this.union(this.shapes[a].getBounds())}this.entity.updateBounds();
return this},setVelocity:function(a,b){this.accel.x=0!==a?a:this.accel.x;this.accel.y=0!==b?b:this.accel.y;this.setMaxVelocity(a,b)},setMaxVelocity:function(a,b){this.maxVel.x=a;this.maxVel.y=b},setFriction:function(a,b){this.friction.x=a||0;this.friction.y=b||0},computeVelocity:function(a){this.gravity&&(a.y+=this.gravity*me.timer.tick,this.jumping=(this.falling=0<a.y)?!1:this.jumping);this.friction.x&&(a.x=me.utils.applyFriction(a.x,this.friction.x));this.friction.y&&(a.y=me.utils.applyFriction(a.y,
this.friction.y));0!==a.y&&(a.y=a.y.clamp(-this.maxVel.y,this.maxVel.y));0!==a.x&&(a.x=a.x.clamp(-this.maxVel.x,this.maxVel.x))},update:function(){this.computeVelocity(this.vel);this.entity.pos.add(this.vel);this.entity.updateBounds();return 0!==this.vel.x||0!==this.vel.y},destroy:function(){this.entity=null;this.shapes=[]}});me.Body.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Body.Error"}})})();
(function(){function a(a,b,c,h){this.max_objects=b||4;this.max_levels=c||4;this.level=h||0;this.bounds=a;this.objects=[];this.nodes=[]}var b=[],c=function(a,c,f,h){if(0<b.length){var g=b.pop();g.bounds=a;g.max_objects=c||4;g.max_levels=f||4;g.level=h||0;return g}return new me.QuadTree(a,c,f,h)};a.prototype.split=function(){var a=this.level+1,b=~~(0.5+this.bounds.width/2),f=~~(0.5+this.bounds.height/2),h=~~(0.5+this.bounds.pos.x),g=~~(0.5+this.bounds.pos.y);this.nodes[0]=c({pos:{x:h+b,y:g},width:b,
height:f},this.max_objects,this.max_levels,a);this.nodes[1]=c({pos:{x:h,y:g},width:b,height:f},this.max_objects,this.max_levels,a);this.nodes[2]=c({pos:{x:h,y:g+f},width:b,height:f},this.max_objects,this.max_levels,a);this.nodes[3]=c({pos:{x:h+b,y:g+f},width:b,height:f},this.max_objects,this.max_levels,a)};a.prototype.getIndex=function(a){var b=-1,c=this.bounds.pos.x+this.bounds.width/2,h=this.bounds.pos.y+this.bounds.height/2,g=a.pos.y<h&&a.pos.y+a.height<h,h=a.pos.y>h;a.pos.x<c&&a.pos.x+a.width<
c?g?b=1:h&&(b=2):a.pos.x>c&&(g?b=0:h&&(b=3));return b};a.prototype.insertContainer=function(a){for(var b=a.children.length,c;b--,c=a.children[b];)c instanceof me.Container?this.insertContainer(c):"undefined"!==typeof c.body&&this.insert(c)};a.prototype.insert=function(a){var b=-1;if(0<this.nodes.length&&(b=this.getIndex(a.getBounds()),-1!==b)){this.nodes[b].insert(a);return}this.objects.push(a);if(this.objects.length>this.max_objects&&this.level<this.max_levels)for(0===this.nodes.length&&this.split(),
a=0;a<this.objects.length;)b=this.getIndex(this.objects[a].getBounds()),-1!==b?this.nodes[b].insert(this.objects.splice(a,1)[0]):a+=1};a.prototype.retrieve=function(a){var b=this.objects;if(0<this.nodes.length){var c=this.getIndex(a.getBounds());if(-1!==c)b=b.concat(this.nodes[c].retrieve(a));else for(c=0;c<this.nodes.length;c+=1)b=b.concat(this.nodes[c].retrieve(a))}return b};a.prototype.clear=function(a){this.objects=[];for(var c=0;c<this.nodes.length;c+=1)this.nodes[c].clear(a),b.push(this.nodes[c]);
this.nodes=[];"undefined"!==typeof a&&(this.bounds.pos.x=a.pos.x,this.bounds.pos.y=a.pos.y,this.bounds.width=a.width,this.bounds.height=a.height)};me.QuadTree=a})();
(function(){function a(a,b,c){for(var d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=a.length,p=0;p<f;p++){var g=a[p].dotProduct(b);g<d&&(d=g);g>e&&(e=g)}c[0]=d;c[1]=e}function b(b,c,d,e,f,g){var p=k.pop(),s=k.pop();b=h.pop().copy(c).sub(b);c=b.dotProduct(f);a(d,f,p);a(e,f,s);s[0]+=c;s[1]+=c;if(p[0]>s[1]||s[0]>p[1])return h.push(b),k.push(p),k.push(s),!0;g&&(d=0,p[0]<s[0]?(g.aInB=!1,p[1]<s[1]?(d=p[1]-s[0],g.bInA=!1):(d=p[1]-s[0],e=s[1]-p[0],d=d<e?d:-e)):(g.bInA=!1,p[1]>s[1]?(d=p[0]-s[1],g.aInB=!1):(d=p[1]-
s[0],e=s[1]-p[0],d=d<e?d:-e)),e=Math.abs(d),e<g.overlap&&(g.overlap=e,g.overlapN.copy(f),0>d&&g.overlapN.reverse()));h.push(b);k.push(p);k.push(s);return!1}function c(a,b){var c=a.length2(),g=b.dotProduct(a);return 0>g?d:g>c?f:e}for(var d=-1,e=0,f=1,h=[],g=0;10>g;g++)h.push(new me.Vector2d);for(var k=[],g=0;5>g;g++)k.push([]);me.collision=function(){var a={quadTree:null,maxDepth:4,maxChildren:8,bounds:null,types:{NO_OBJECT:0,PLAYER_OBJECT:1,NPC_OBJECT:2,ENEMY_OBJECT:4,COLLECTABLE_OBJECT:8,ACTION_OBJECT:16,
PROJECTILE_OBJECT:32,WORLD_SHAPE:64,ALL_OBJECT:4294967295},init:function(){a.bounds=me.game.viewport.clone();a.quadTree=new me.QuadTree(a.bounds,a.maxChildren,a.maxDepth);me.event.subscribe(me.event.LEVEL_LOADED,function(){me.collision.bounds=me.game.world.clone();me.collision.quadTree.clear(me.collision.bounds)})},ResponseObject:function(){this.b=this.a=null;this.overlapN=new me.Vector2d;this.overlapV=new me.Vector2d;this.bInA=this.aInB=!0;this.indexShapeB=this.indexShapeA=-1;this.overlap=Number.MAX_VALUE}};
a.ResponseObject.prototype.clear=function(){this.bInA=this.aInB=!0;this.overlap=Number.MAX_VALUE;this.indexShapeB=this.indexShapeA=-1;return this};a.response=new a.ResponseObject;a.shouldCollide=function(a,b){return a.body&&b.body&&0!==(a.body.collisionMask&b.body.collisionType)&&0!==(a.body.collisionType&b.body.collisionMask)};a.check=function(b,c){for(var d=0,e=c||a.response,f=a.quadTree.retrieve(b),g=f.length,h;g--,h=f[g];)if(h!==b&&a.shouldCollide(b,h)&&b.getBounds().overlaps(h.getBounds())){var k=
b.body.shapes.length,w=h.body.shapes.length;if(0!==k&&0!==w){var A=0;do{var x=b.body.getShape(A),z=0;do{var u=h.body.getShape(z);!0===a["test"+x.shapeType+u.shapeType].call(this,b,x,h,u,e.clear())&&(d++,e.indexShapeA=A,e.indexShapeB=z,!1!==b.onCollision(e,h)&&b.body.respondToCollision.call(b.body,e),!1!==h.onCollision(e,b)&&h.body.respondToCollision.call(h.body,e));z++}while(z<w);A++}while(A<k)}}return 0<d};a.testPolygonPolygon=function(a,c,d,e,f){var g=c.points,s=c.normals,k=s.length,w=e.points,
A=e.normals,x=A.length;c=h.pop().copy(a.pos).add(c.pos);e=h.pop().copy(d.pos).add(e.pos);var l;for(l=0;l<k;l++)if(b(c,e,g,w,s[l],f))return h.push(c),h.push(e),!1;for(l=0;l<x;l++)if(b(c,e,g,w,A[l],f))return h.push(c),h.push(e),!1;f&&(f.a=a,f.b=d,f.overlapV.copy(f.overlapN).scale(f.overlap));h.push(c);h.push(e);return!0};a.testEllipseEllipse=function(a,b,c,d,e){var f=h.pop().copy(c.pos).add(d.pos).sub(a.pos).sub(b.pos);b=b.radius;d=d.radius;var g=b+d,k=g*g,l=f.length2();if(l>k)return h.push(f),!1;e&&
(k=Math.sqrt(l),e.a=a,e.b=c,e.overlap=g-k,e.overlapN.copy(f.normalize()),e.overlapV.copy(f).scale(e.overlap),e.aInB=b<=d&&k<=d-b,e.bInA=d<=b&&k<=b-d);h.push(f);return!0};a.testPolygonEllipse=function(a,b,e,g,k){var p=h.pop().copy(e.pos).add(g.pos).sub(a.pos).sub(b.pos);g=g.radius;for(var s=g*g,l=b.points,w=b.edges,A=w.length,x=h.pop(),z=h.pop(),u=h.pop(),y=0,B=0;B<A;B++){var C=B===A-1?0:B+1,y=0===B?A-1:B-1,E=0,F=null;x.copy(w[B]);u.copy(p).sub(l[B]);k&&u.length2()>s&&(k.aInB=!1);var D=c(x,u),G=!0;
if(D===d){C=null;1<A&&(x.copy(w[y]),C=h.pop().copy(p).sub(l[y]),D=c(x,C),D!==f&&(G=!1));if(G){y=u.length();if(y>g)return h.push(p),h.push(x),h.push(z),h.push(u),C&&h.push(C),!1;k&&(k.bInA=!1,F=u.normalize(),E=g-y)}C&&h.push(C)}else if(D===f){if(1<A&&(x.copy(w[C]),u.copy(p).sub(l[C]),D=c(x,u),D!==d&&(G=!1)),G){y=u.length();if(y>g)return h.push(p),h.push(x),h.push(z),h.push(u),!1;k&&(k.bInA=!1,F=u.normalize(),E=g-y)}}else{z.copy(b.normals[B]);y=u.dotProduct(z);D=Math.abs(y);if((1===A||0<y)&&D>g)return h.push(p),
h.push(x),h.push(z),h.push(u),!1;k&&(F=z,E=g-y,0<=y||E<2*g)&&(k.bInA=!1)}F&&k&&Math.abs(E)<Math.abs(k.overlap)&&(k.overlap=E,k.overlapN.copy(F))}k&&(k.a=a,k.b=e,k.overlapV.copy(k.overlapN).scale(k.overlap));h.push(p);h.push(x);h.push(z);h.push(u);return!0};a.testEllipsePolygon=function(b,c,d,e,f){(b=a.testPolygonEllipse(d,e,b,c,f))&&f&&(c=f.a,d=f.aInB,f.overlapN.reverse(),f.overlapV.reverse(),f.a=f.b,f.b=c,f.aInB=f.bInA,f.bInA=d);return b};return a}()})();
(function(){me.Renderable=me.Rect.extend({init:function(a,b,c,d){this.isRenderable=!0;this.GUID=void 0;this.floating=this.isPersistent=this.updateWhenPaused=this.alwaysUpdate=this.inViewport=!1;this.z=NaN;this.anchorPoint=new me.Vector2d;this.alpha=1;me.Rect.prototype.init.apply(this,[a,b,c,d]);this.anchorPoint.set(0.5,0.5);this.setOpacity(1)},getOpacity:function(){return this.alpha},setOpacity:function(a){"number"===typeof a&&(this.alpha=a.clamp(0,1),this.alpha!==this.alpha&&(this.alpha=1))},update:function(){return!1},
draw:function(){}});me.Renderable.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Renderable.Error"}})})();
(function(){me.Sprite=me.Renderable.extend({init:function(a,b,c,d,e){this._scale=new me.Vector2d;this.lastflipY=this.lastflipX=this.scaleFlag=!1;this.z=0;this.offset=new me.Vector2d;this._sourceAngle=this.angle=0;this.image=null;this.flickering=!1;this.flickerDuration=0;this.flickercb=null;this.flickerState=!1;this.isSprite=!0;me.Renderable.prototype.init.apply(this,[a,b,d||c.width,e||c.height]);this.image=c;this._scale.set(1,1);this.scaleFlag=this.lastflipX=this.lastflipY=!1;this.offset.set(0,0);
this.flickering=this.isPersistent=!1},setTransparency:function(a){a="#"===a.charAt(0)?a.substring(1,7):a;this.image=me.video.renderer.applyRGBFilter(this.image,"transparent",a.toUpperCase()).canvas},isFlickering:function(){return this.flickering},flicker:function(a,b){this.flickerDuration=a;0>=this.flickerDuration?(this.flickering=!1,this.flickercb=null):this.flickering||(this.flickercb=b,this.flickering=!0)},flipX:function(a){a!==this.lastflipX&&(this.lastflipX=a,this._scale.x=-this._scale.x,this.scaleFlag=
1!==this._scale.x||1!==this._scale.y)},flipY:function(a){a!==this.lastflipY&&(this.lastflipY=a,this._scale.y=-this._scale.y,this.scaleFlag=1!==this._scale.x||1!==this._scale.y)},scale:function(a,b){var c="undefined"===typeof b?a:b;0<a&&(this._scale.x=0>this._scale.x?-a:a);0<c&&(this._scale.y=0>this._scale.y?-c:c);this.scaleFlag=1!==this._scale.x||1!==this._scale.y},scaleV:function(a){this.scale(a.x,a.y)},update:function(a){return this.flickering?(this.flickerDuration-=a,0>this.flickerDuration&&(this.flickercb&&
this.flickercb(),this.flicker(-1)),!0):!1},draw:function(a){if(this.flickering&&(this.flickerState=!this.flickerState,!this.flickerState))return;a.save();a.setGlobalAlpha(a.globalAlpha()*this.getOpacity());var b=~~this.pos.x,c=~~this.pos.y,d=this.width,e=this.height,f=this.angle+this._sourceAngle;if(this.scaleFlag||0!==f){var h=d*this.anchorPoint.x,g=e*this.anchorPoint.y;a.translate(b+h,c+g);this.scaleFlag&&a.scale(this._scale.x,this._scale.y);0!==f&&a.rotate(f);0!==this._sourceAngle?(d=this.height,
e=this.width,b=-g,c=-h):(b=-h,c=-g)}a.drawImage(this.image,this.offset.x,this.offset.y,d,e,b,c,d,e);a.restore()},destroy:function(){this.onDestroyEvent.apply(this,arguments)},onDestroyEvent:function(){}})})();
(function(){me.AnimationSheet=me.Sprite.extend({init:function(a,b,c){this.margin=this.spacing=0;this.animationpause=!1;this.animationspeed=100;this.anim={};this.current=this.resetAnim=null;this.animationspeed=100;this.spacing=c.spacing||0;this.margin=c.margin||0;var d=c.region||c.image;me.Sprite.prototype.init.apply(this,[a,b,c.image,c.spritewidth,c.spriteheight,this.spacing,this.margin]);this.atlasIndices=this.textureAtlas=null;this.buildLocalAtlas(c.atlas,c.atlasIndices,d);this.addAnimation("default",
null);this.setCurrentAnimation("default")},buildLocalAtlas:function(a,b,c){if(null===c||"undefined"===typeof c)c=this.image;if("undefined"!==typeof a)this.textureAtlas=a,this.atlasIndices=b;else{this.textureAtlas=[];if(0!==(c.width-this.margin)%(this.width+this.spacing)||0!==(c.height-this.margin)%(this.height+this.spacing))throw new me.Renderable.Error("Animation sheet for image: "+c.src+" is not divisible by "+(this.width+this.spacing)+"x"+(this.height+this.spacing));a=new me.Vector2d(~~((c.width-
this.margin)/(this.width+this.spacing)),~~((c.height-this.margin)/(this.height+this.spacing)));var d=b=0;c.offset&&(b=c.offset.x,d=c.offset.y);c=0;for(var e=a.x*a.y;c<e;c++)this.textureAtlas[c]={name:""+c,offset:new me.Vector2d(this.margin+(this.spacing+this.width)*(c%a.x)+b,this.margin+(this.spacing+this.height)*~~(c/a.x)+d),width:this.width,height:this.height,hWidth:this.width/2,hHeight:this.height/2,angle:0}}},addAnimation:function(a,b,c){this.anim[a]={name:a,frame:[],idx:0,length:0,animationspeed:c||
this.animationspeed,nextFrame:0};if(null==b){b=[];var d=0;this.textureAtlas.forEach(function(){b[d]=d++})}c=0;for(var e=b.length;c<e;c++)if("number"===typeof b[c])this.anim[a].frame[c]=this.textureAtlas[b[c]];else{if(null===this.atlasIndices)throw new me.Renderable.Error("string parameters for addAnimation are only allowed for TextureAtlas");this.anim[a].frame[c]=this.textureAtlas[this.atlasIndices[b[c]]]}this.anim[a].length=this.anim[a].frame.length},setCurrentAnimation:function(a,b){if(this.anim[a])this.current=
this.anim[a],this.resetAnim=b||null,this.setAnimationFrame(this.current.idx),this.current.nextFrame=this.current.animationspeed;else throw new me.Renderable.Error("animation id '"+a+"' not defined");},isCurrentAnimation:function(a){return this.current.name===a},setAnimationFrame:function(a){this.current.idx=(a||0)%this.current.length;a=this.current.frame[this.current.idx];this.offset=a.offset;this.width=a.width;this.height=a.height;this.hWidth=a.hWidth;this.hHeight=a.hHeight;this._sourceAngle=a.angle},
getCurrentAnimationFrame:function(){return this.current.idx},update:function(a){if(!this.animationpause&&1<this.current.length&&(this.current.nextFrame-=a,0>=this.current.nextFrame)){this.setAnimationFrame(++this.current.idx);if(0===this.current.idx&&this.resetAnim)if("string"===typeof this.resetAnim)this.setCurrentAnimation(this.resetAnim);else if("function"===typeof this.resetAnim&&!1===this.resetAnim())return this.current.idx=this.current.length-1,this.setAnimationFrame(this.current.idx),me.Sprite.prototype.update.apply(this,
[a]),!1;this.current.nextFrame=this.current.animationspeed;return me.Sprite.prototype.update.apply(this,[a])||!0}return me.Sprite.prototype.update.apply(this,[a])}})})();
(function(){var a=-(Math.PI/2);me.TextureAtlas=Object.extend({init:function(a,c){this.format=null;this.texture=c||null;this.atlas=a||null;if(a&&a.meta){if(a.meta.app.contains("texturepacker"))if(this.format="texturepacker","undefined"===typeof c){var d=me.utils.getBasename(a.meta.image);this.texture=me.loader.getImage(d);if(null===this.texture)throw new me.TextureAtlas.Error("Atlas texture '"+d+"' not found");}else this.texture=c;if(a.meta.app.contains("ShoeBox")){if(!a.meta.exporter||!a.meta.exporter.contains("melonJS"))throw new me.TextureAtlas.Error("ShoeBox requires the JSON exporter : https://github.com/melonjs/melonJS/tree/master/media/shoebox_JSON_export.sbx");
this.format="ShoeBox";this.texture=c}this.atlas=this.initFromTexturePacker(a)}if(null===this.atlas)throw new me.TextureAtlas.Error("texture atlas format not supported");},initFromTexturePacker:function(a){var c={};a.frames.forEach(function(a){a.hasOwnProperty("filename")&&(c[a.filename]={frame:new me.Rect(a.frame.x,a.frame.y,a.frame.w,a.frame.h),source:new me.Rect(a.spriteSourceSize.x,a.spriteSourceSize.y,a.spriteSourceSize.w,a.spriteSourceSize.h),rotated:!0===a.rotated,trimmed:!0===a.trimmed})});
return c},getTexture:function(){return this.texture},getRegion:function(b){var c=this.atlas[b];return c?{name:b,pos:c.source.pos.clone(),offset:c.frame.pos.clone(),width:c.frame.width,height:c.frame.height,hWidth:c.frame.width/2,hHeight:c.frame.height/2,angle:!0===c.rotated?a:0}:null},createSpriteFromName:function(a){var c=this.getRegion(a);if(c)return a=new me.Sprite(0,0,this.getTexture(),c.width,c.height),a.offset.setV(c.offset),a._sourceAngle=c.angle,a;throw new me.TextureAtlas.Error("TextureAtlas - region for "+
a+" not found");},createAnimationFromName:function(a){for(var c=[],d={},e=0;e<a.length;++e)if(c[e]=this.getRegion(a[e]),d[a[e]]=e,null==c[e])throw new me.TextureAtlas.Error("TextureAtlas - region for "+a[e]+" not found");return new me.AnimationSheet(0,0,{image:this.texture,spritewidth:0,spriteheight:0,margin:0,spacing:0,atlas:c,atlasIndices:d})}});me.TextureAtlas.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.TextureAtlas.Error"}})})();
(function(){var a=Math.min,b=Math.max;me.Viewport=me.Renderable.extend({init:function(a,b,e,f){this.AXIS={NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3};this.target=this.deadzone=this.bounds=null;this.follow_axis=0;this._fadeOut=this._fadeIn=this._shake=null;this.screenY=this.screenX=0;me.Renderable.prototype.init.apply(this,[a,b,e-a,f-b]);this.bounds=new me.Rect(-Infinity,-Infinity,Infinity,Infinity);this.offset=new me.Vector2d;this.target=null;this.follow_axis=this.AXIS.NONE;this._shake={intensity:0,duration:0,
axis:this.AXIS.BOTH,onComplete:null};this._fadeOut={color:null,duration:0,tween:null};this._fadeIn={color:null,duration:0,tween:null};this.setDeadzone(this.width/6,this.height/6)},_followH:function(c){var d=this.pos.x;c.x-this.pos.x>this.deadzone.right?this.pos.x=~~a(c.x-this.deadzone.right,this.bounds.width-this.width):c.x-this.pos.x<this.deadzone.pos.x&&(this.pos.x=~~b(c.x-this.deadzone.pos.x,this.bounds.pos.x));return d!==this.pos.x},_followV:function(c){var d=this.pos.y;c.y-this.pos.y>this.deadzone.bottom?
this.pos.y=~~a(c.y-this.deadzone.bottom,this.bounds.height-this.height):c.y-this.pos.y<this.deadzone.pos.y&&(this.pos.y=~~b(c.y-this.deadzone.pos.y,this.bounds.pos.y));return d!==this.pos.y},reset:function(a,b){this.pos.x=a||0;this.pos.y=b||0;this.follow_axis=this.target=null},setDeadzone:function(a,b){null===this.deadzone&&(this.deadzone=new me.Rect(0,0,0,0));this.deadzone.pos.set(~~((this.width-a)/2),~~((this.height-b)/2-0.25*b));this.deadzone.resize(a,b);this.updateTarget()},setBounds:function(a,
b,e,f){this.bounds.pos.set(a,b);this.bounds.resize(e,f)},follow:function(a,b){if(a instanceof me.Entity)this.target=a.pos;else if(a instanceof me.Vector2d)this.target=a;else throw new me.Renderable.Error("invalid target for viewport.follow");this.follow_axis="undefined"===typeof b?this.AXIS.BOTH:b;this.updateTarget()},move:function(a,b){this.moveTo(~~(this.pos.x+a),~~(this.pos.y+b))},moveTo:function(a,b){this.pos.x=(~~a).clamp(this.bounds.pos.x,this.bounds.width-this.width);this.pos.y=(~~b).clamp(this.bounds.pos.y,
this.bounds.height-this.height);me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos])},updateTarget:function(){var a=!1;if(this.target)switch(this.follow_axis){case this.AXIS.HORIZONTAL:a=this._followH(this.target);break;case this.AXIS.VERTICAL:a=this._followV(this.target);break;case this.AXIS.BOTH:a=this._followH(this.target),a=this._followV(this.target)||a}return a},update:function(a){var b=this.updateTarget();if(0<this._shake.duration){this._shake.duration-=a;if(0>=this._shake.duration){if(this._shake.duration=
0,this.offset.setZero(),"function"===typeof this._shake.onComplete)this._shake.onComplete()}else{if(this._shake.axis===this.AXIS.BOTH||this._shake.axis===this.AXIS.HORIZONTAL)this.offset.x=(Math.random()-0.5)*this._shake.intensity;if(this._shake.axis===this.AXIS.BOTH||this._shake.axis===this.AXIS.VERTICAL)this.offset.y=(Math.random()-0.5)*this._shake.intensity}b=!0}!0===b&&me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos]);if(null!=this._fadeIn.tween||null!=this._fadeOut.tween)b=!0;return b},
shake:function(a,b,e,f){0<this._shake.duration||(this._shake={intensity:a,duration:b,axis:e||this.AXIS.BOTH,onComplete:f})},fadeOut:function(a,b,e){this._fadeOut.color=me.pool.pull("me.Color").copy(a);this._fadeOut.color.alpha=1;this._fadeOut.duration=b||1E3;this._fadeOut.tween=me.pool.pull("me.Tween",this._fadeOut.color).to({alpha:0},this._fadeOut.duration).onComplete(e||null);this._fadeOut.tween.start()},fadeIn:function(a,b,e){this._fadeIn.color=me.pool.pull("me.Color").copy(a);this._fadeIn.color.alpha=
0;this._fadeIn.duration=b||1E3;this._fadeIn.tween=me.pool.pull("me.Tween",this._fadeIn.color).to({alpha:1},this._fadeIn.duration).onComplete(e||null);this._fadeIn.tween.start()},getWidth:function(){return this.width},getHeight:function(){return this.height},focusOn:function(a){var b=a.getBounds();this.moveTo(a.pos.x+b.pos.x+b.width/2,a.pos.y+b.pos.y+b.height/2)},isVisible:function(a){return a.overlaps(this)},localToWorld:function(a,b,e){e=e||new me.Vector2d;return e.set(a,b).add(this.pos).sub(me.game.currentLevel.pos)},
worldToLocal:function(a,b,e){e=e||new me.Vector2d;return e.set(a,b).sub(this.pos).add(me.game.currentLevel.pos)},draw:function(){this._fadeIn.tween&&(me.video.renderer.clearSurface(null,this._fadeIn.color),1===this._fadeIn.color.alpha&&(this._fadeIn.tween=null,me.pool.push(this._fadeIn.color),this._fadeIn.color=null));this._fadeOut.tween&&(me.video.renderer.clearSurface(null,this._fadeOut.color),0===this._fadeOut.color.alpha&&(this._fadeOut.tween=null,me.pool.push(this._fadeOut.color),this._fadeOut.color=
null))}})})();
(function(){me.GUI_Object=me.Sprite.extend({init:function(a,b,c){this.isClickable=!0;this.holdThreshold=250;this.isHoldable=!1;this.holdTimeout=null;this.updated=!1;this.released=!0;me.Sprite.prototype.init.apply(this,[a,b,"string"===typeof c.image?me.loader.getImage(c.image):c.image,c.spritewidth,c.spriteheight]);this.floating=!0;me.input.registerPointerEvent("pointerdown",this,this.clicked.bind(this));me.input.registerPointerEvent("pointerup",this,this.release.bind(this))},update:function(){return this.updated?(this.released||
(this.updated=!1),!0):!1},clicked:function(a){if(this.isClickable)return this.updated=!0,this.isHoldable&&(null!==this.holdTimeout&&me.timer.clearTimeout(this.holdTimeout),this.holdTimeout=me.timer.setTimeout(this.hold.bind(this),this.holdThreshold,!1),this.released=!1),this.onClick(a)},onClick:function(){return!1},release:function(a){this.released=!0;me.timer.clearTimeout(this.holdTimeout);return this.onRelease(a)},onRelease:function(){return!1},hold:function(){me.timer.clearTimeout(this.holdTimeout);
if(!this.released)this.onHold()},onHold:function(){},onDestroyEvent:function(){me.input.releasePointerEvent("pointerdown",this);me.input.releasePointerEvent("pointerup",this);me.timer.clearTimeout(this.holdTimeout)}})})();
(function(){var a=function(a,b){a.ancestor&&a.ancestor.removeChildNow(a,b)},b=new me.Rect(0,0,0,0),c=0;me.Container=me.Renderable.extend({init:function(a,b,c,h){this.pendingSort=null;this.transform=new me.Matrix2d;me.Renderable.prototype.init.apply(this,[a,b,c||Infinity,h||Infinity]);this.bounds=void 0;this.children=[];this.sortOn=me.game.sortOn;this.autoSort=!0;this.transform.identity();this.drawCount=0},addChild:function(a,b){"undefined"!==typeof a.ancestor?a.ancestor.removeChildNow(a):a.isRenderable&&
(a.GUID=me.utils.createGUID());"number"===typeof b&&(a.z=b);if("undefined"===typeof a.z||a.z!==a.z)a.z=this.children.length;a.ancestor=this;this.children.push(a);!0===this.autoSort&&this.sort();if("function"===typeof a.onActivateEvent)a.onActivateEvent();return a},addChildAt:function(a,b){if(0<=b&&b<this.children.length){"undefined"!==typeof a.ancestor?a.ancestor.removeChildNow(a):a.isRenderable&&(a.GUID=me.utils.createGUID());a.ancestor=this;this.children.splice(b,0,a);if("function"===typeof a.onActivateEvent)a.onActivateEvent();
return a}throw new me.Container.Error("Index ("+b+") Out Of Bounds for addChildAt()");},swapChildren:function(a,b){var c=this.getChildIndex(a),h=this.getChildIndex(b);if(-1!==c&&-1!==h){var g=a.z;a.z=b.z;b.z=g;this.children[c]=b;this.children[h]=a}else throw new me.Container.Error(a+" Both the supplied childs must be a child of the caller "+this);},getChildAt:function(a){if(0<=a&&a<this.children.length)return this.children[a];throw new me.Container.Error("Index ("+a+") Out Of Bounds for getChildAt()");
},getChildIndex:function(a){return this.children.indexOf(a)},hasChild:function(a){return this===a.ancestor},getChildByProp:function(a,b){function c(a,d){"string"===typeof a[d]?a[d].match(g)&&h.push(a):a[d]===b&&h.push(a)}for(var h=[],g=RegExp(b,"i"),k=this.children.length-1;0<=k;k--){var l=this.children[k];l instanceof me.Container?(c(l,a),h=h.concat(l.getChildByProp(a,b))):c(l,a)}return h},getChildByName:function(a){return this.getChildByProp("name",a)},getChildByGUID:function(a){a=this.getChildByProp("GUID",
a);return 0<a.length?a[0]:null},getBounds:function(){this.bounds?(this.bounds.pos.set(Infinity,Infinity),this.bounds.resize(-Infinity,-Infinity)):this.bounds=new me.Rect(Infinity,Infinity,-Infinity,-Infinity);for(var a,b=this.children.length;b--,a=this.children[b];)a.isRenderable&&(a=a.getBounds(),null!==a&&this.bounds.union(a));return this.bounds},removeChild:function(b,c){b.ancestor&&a.defer(this,b,c)},removeChildNow:function(a,b){if(this.hasChild(a)){a.ancestor=void 0;if("function"===typeof a.onDeactivateEvent)a.onDeactivateEvent();
b||("function"===typeof a.destroy&&a.destroy(),me.pool.push(a));this.children.splice(this.getChildIndex(a),1)}else throw new me.Container.Error(a+" The supplied child must be a child of the caller "+this);},setChildsProperty:function(a,b,c){for(var h=this.children.length;0<=h;h--){var g=this.children[h];!0===c&&g instanceof me.Container&&g.setChildsProperty(a,b,c);g[a]=b}},moveUp:function(a){var b=this.getChildIndex(a);0<=b-1&&this.swapChildren(a,this.getChildAt(b-1))},moveDown:function(a){var b=
this.getChildIndex(a);b+1<this.children.length&&this.swapChildren(a,this.getChildAt(b+1))},moveToTop:function(a){var b=this.getChildIndex(a);0<b&&(this.children.splice(0,0,this.children.splice(b,1)[0]),a.z=this.children[1].z+1)},moveToBottom:function(a){var b=this.getChildIndex(a);b<this.children.length-1&&(this.children.splice(this.children.length-1,0,this.children.splice(b,1)[0]),a.z=this.children[this.children.length-2].z-1)},sort:function(a){if(null===this.pendingSort){if(!0===a)for(var b=this.children.length,
c;b--,c=this.children[b];)c instanceof me.Container&&c.sort(a);this.pendingSort=function(a){a.children.sort(a["_sort"+a.sortOn.toUpperCase()]);a.pendingSort=null;me.game.repaint()}.defer(this,this)}},_sortZ:function(a,b){return b.z-a.z},_sortX:function(a,b){var c=b.z-a.z;return c?c:(b.pos&&b.pos.x)-(a.pos&&a.pos.x)||0},_sortY:function(a,b){var c=b.z-a.z;return c?c:(b.pos&&b.pos.y)-(a.pos&&a.pos.y)||0},destroy:function(){this.pendingSort&&(clearTimeout(this.pendingSort),this.pendingSort=null);for(var a=
this.children.length,b;a--,b=this.children[a];)b.isPersistent||this.removeChildNow(b);this.transform.identity()},update:function(a){for(var e=!1,f=!1,h=me.state.isPaused(),g=!1,k=!1,l=[],m=0,q=0,r=0,n=me.game.viewport,v=this.children.length,p;v--,p=this.children[v];)if(!h||p.updateWhenPaused)if(p.isRenderable){(f=0<c||p.floating)&&c++;if(g=!f){m=p.pos.x;q=p.pos.y;r=Math.abs(m+q+p.width+p.height);if(r!==r||Infinity===r)k=!0,l.push(b.clone());b.translateV(p.pos);b.resize(p.width,p.height)}p.inViewport=
f||n.isVisible(b);e=(p.inViewport||p.alwaysUpdate)&&p.update(a)||e;g&&(k?(k=!1,b.copy(l.pop())):b.translate(-m,-q));0<c&&c--}else e=p.update(a)||e;return e},draw:function(a,b){var c=me.game.viewport,h=!1;this.drawCount=0;a.save();a.transform.apply(a,this.transform.val);a.setGlobalAlpha(a.globalAlpha()*this.getOpacity());a.translate(this.pos.x,this.pos.y);for(var g=this.children.length,k;g--,k=this.children[g];)h=k.floating,(k.inViewport||h)&&k.isRenderable&&(!0===h&&a.translate(c.screenX-this.pos.x,
c.screenY-this.pos.y),k.draw(a,b),!0===h&&a.translate(this.pos.x-c.screenX,this.pos.y-c.screenY),this.drawCount++);a.restore()}});me.Container.Error=me.Renderable.Error.extend({init:function(a){me.Renderable.Error.prototype.init.apply(this,[a]);this.name="me.Container.Error"}})})();
(function(){me.Entity=me.Renderable.extend({init:function(a,b,c){this.renderable=null;this.bounds=void 0;if("number"!==typeof c.width||"number"!==typeof c.height)throw new me.Entity.Error("height and width properties are mandatory when passing settings parameters to an object entity");me.Renderable.prototype.init.apply(this,[a,b,c.width,c.height]);c.image&&(a="object"===typeof c.image?c.image:me.loader.getImage(c.image),this.renderable=new me.AnimationSheet(0,0,{image:a,spritewidth:~~(c.spritewidth||
c.width),spriteheight:~~(c.spriteheight||c.height),spacing:~~c.spacing,margin:~~c.margin}),c.transparent_color&&this.renderable.setTransparency(c.transparent_color));this.name=c.name?c.name.toLowerCase():"";this.type=c.type;this.alive=!0;this.body=new me.Body(this,"function"===typeof c.getTMXShapes?c.getTMXShapes():[]);this.body.updateBounds();0===this.width&&0===this.height&&this.resize(this.body.width,this.body.height);"undefined"!==typeof c.collisionMask&&this.body.setCollisionMask(c.collisionMask);
if("undefined"!==typeof c.collisionType)if("undefined"!==typeof me.collision.types[c.collisionType])this.body.collisionType=me.collision.types[c.collisionType];else throw new me.Entity.Error("Invalid value for the collisionType property");},getBounds:function(){return this.bounds},updateBounds:function(){this.bounds||(this.bounds=new me.Rect(0,0,0,0));this.bounds.pos.setV(this.pos).add(this.body.pos);this.bounds.resize(this.body.width,this.body.height);return this.bounds},distanceTo:function(a){var b=
this.pos.x+this.width/2-(a.pos.x+a.width/2);a=this.pos.y+this.height/2-(a.pos.y+a.height/2);return Math.sqrt(b*b+a*a)},distanceToPoint:function(a){var b=this.pos.x+this.width/2-a.x;a=this.pos.y+this.height/2-a.y;return Math.sqrt(b*b+a*a)},angleTo:function(a){var b=this.getBounds();a=a.getBounds();return Math.atan2(a.pos.y+a.height/2-(b.pos.y+b.height/2),a.pos.x+a.width/2-(b.pos.x+b.width/2))},angleToPoint:function(a){var b=this.getBounds();return Math.atan2(a.y-(b.pos.y+b.height/2),a.x-(b.pos.x+b.width/
2))},update:function(a){return this.renderable?this.renderable.update(a):!1},draw:function(a){if(this.renderable){var b=this.getBounds(),c=~~(0.5+b.pos.x+this.anchorPoint.x*(b.width-this.renderable.width)),b=~~(0.5+b.pos.y+this.anchorPoint.y*(b.height-this.renderable.height));a.translate(c,b);this.renderable.draw(a);a.translate(-c,-b)}},destroy:function(){this.renderable&&(this.renderable.destroy.apply(this.renderable,arguments),this.renderable=null);this.body.destroy.apply(this.body,arguments);this.body=
null},onDestroyEvent:function(){},onCollision:function(){return!1}});me.CollectableEntity=me.Entity.extend({init:function(a,b,c){me.Entity.prototype.init.apply(this,[a,b,c]);this.body.collisionType=me.collision.types.COLLECTABLE_OBJECT}});me.LevelEntity=me.Entity.extend({init:function(a,b,c){me.Entity.prototype.init.apply(this,[a,b,c]);this.nextlevel=c.to;this.fade=c.fade;this.duration=c.duration;this.fading=!1;this.name="levelEntity";this.gotolevel=c.to;this.body.collisionType=me.collision.types.ACTION_OBJECT},
onFadeComplete:function(){me.levelDirector.loadLevel(this.gotolevel);me.game.viewport.fadeOut(this.fade,this.duration)},goTo:function(a){this.gotolevel=a||this.nextlevel;this.fade&&this.duration?this.fading||(this.fading=!0,me.game.viewport.fadeIn(this.fade,this.duration,this.onFadeComplete.bind(this))):me.levelDirector.loadLevel(this.gotolevel)},onCollision:function(){"levelEntity"===this.name&&this.goTo();return!1}});me.Entity.Error=me.Renderable.Error.extend({init:function(a){me.Renderable.Error.prototype.init.apply(this,
[a]);this.name="me.Entity.Error"}})})();
(function(){me.ScreenObject=Object.extend({init:function(){},reset:function(){me.game.reset();this.onResetEvent.apply(this,arguments)},destroy:function(){this.onDestroyEvent.apply(this,arguments)},onResetEvent:function(){},onDestroyEvent:function(){}});(function(){var a=0,b=1E3/60,c=me.agent.prefixed("requestAnimationFrame"),d=me.agent.prefixed("cancelAnimationFrame")||me.agent.prefixed("cancelRequestAnimationFrame");c&&d||(c=function(c){var d=window.performance.now(),h=Math.max(0,b-(d-a)),g=window.setTimeout(function(){c(d+
h)},h);a=d+h;return g},d=function(a){window.clearTimeout(a)});window.requestAnimationFrame=c;window.cancelAnimationFrame=d})();me.state=function(){function a(){-1===f&&-1!==e&&(me.timer.reset(),f=window.requestAnimationFrame(b))}function b(a){me.game.update(a);me.game.draw();-1!==f&&(f=window.requestAnimationFrame(b))}function c(b){window.cancelAnimationFrame(f);f=-1;g[e]&&g[e].screen.destroy();g[b]&&(e=b,g[e].screen.reset.apply(g[e].screen,q),a(),m&&m(),me.game.repaint())}var d={},e=-1,f=-1,h=!1,
g={},k="",l=0,m=null,q=null,r=0;d.LOADING=0;d.MENU=1;d.READY=2;d.PLAY=3;d.GAMEOVER=4;d.GAME_END=5;d.SCORE=6;d.CREDITS=7;d.SETTINGS=8;d.USER=100;d.onPause=null;d.onResume=null;d.onStop=null;d.onRestart=null;d.init=function(){d.set(d.LOADING,new me.DefaultLoadingScreen)};d.stop=function(a){if(e!==d.LOADING&&d.isRunning()&&(window.cancelAnimationFrame(f),f=-1,!0===a&&me.audio.pauseTrack(),r=window.performance.now(),me.event.publish(me.event.STATE_STOP),"function"===typeof d.onStop))d.onStop()};d.pause=
function(a){if(e!==d.LOADING&&!d.isPaused()&&(h=!0,!0===a&&me.audio.pauseTrack(),r=window.performance.now(),me.event.publish(me.event.STATE_PAUSE),"function"===typeof d.onPause))d.onPause()};d.restart=function(b){if(!d.isRunning()&&(a(),!0===b&&me.audio.resumeTrack(),r=window.performance.now()-r,me.game.repaint(),me.event.publish(me.event.STATE_RESTART,[r]),"function"===typeof d.onRestart))d.onRestart()};d.resume=function(a){if(d.isPaused()&&(h&&-1!==e&&(me.timer.reset(),h=!1),!0===a&&me.audio.resumeTrack(),
r=window.performance.now()-r,me.event.publish(me.event.STATE_RESUME,[r]),"function"===typeof d.onResume))d.onResume()};d.isRunning=function(){return-1!==f};d.isPaused=function(){return h};d.set=function(a,b){g[a]={};g[a].screen=b;g[a].transition=!0};d.current=function(){return g[e].screen};d.transition=function(a,b,c){"fade"===a&&(k=b,l=c)};d.setTransition=function(a,b){g[a].transition=b};d.change=function(a){if("undefined"===typeof g[a])throw new me.Error("Undefined ScreenObject for state '"+a+"'");
q=null;1<arguments.length&&(q=Array.prototype.slice.call(arguments,1));l&&g[a].transition?(m=function(){me.game.viewport.fadeOut(k,l)},me.game.viewport.fadeIn(k,l,function(){c.defer(this,a)})):c.defer(this,a)};d.isCurrent=function(a){return e===a};return d}()})();
(function(){var a=me.Renderable.extend({init:function(a,b,c){me.Renderable.prototype.init.apply(this,[a.x,a.y,b,c]);this.invalidate=!1;this.barHeight=4;this.progress=0},onProgressUpdate:function(a){this.progress=~~(a*this.width);this.invalidate=!0},update:function(){return!0===this.invalidate?(this.invalidate=!1,!0):!1},draw:function(a){a.setColor("#000000");a.fillRect(0,this.height/2-this.barHeight/2,this.width,this.barHeight);a.setColor("#55aa00");a.fillRect(2,this.height/2-this.barHeight/2,this.progress,
this.barHeight)}}),b=me.Renderable.extend({init:function(a,b,c){me.Renderable.prototype.init.apply(this,[b,c,100,85]);this.iconCanvas=a;a=me.CanvasRenderer.getContext2d(this.iconCanvas);a.translate(this.pos.x,this.pos.y);a.beginPath();a.moveTo(0.7,48.9);a.bezierCurveTo(10.8,68.9,38.4,75.8,62.2,64.5);a.bezierCurveTo(86.1,53.1,97.2,27.7,87,7.7);a.lineTo(87,7.7);a.bezierCurveTo(89.9,15.4,73.9,30.2,50.5,41.4);a.bezierCurveTo(27.1,52.5,5.2,55.8,0.7,48.9);a.lineTo(0.7,48.9);a.lineTo(0.7,48.9);a.closePath();
a.fillStyle="rgb(255, 255, 255)";a.fill();a.beginPath();a.moveTo(84,7);a.bezierCurveTo(87.6,14.7,72.5,30.2,50.2,41.6);a.bezierCurveTo(27.9,53,6.9,55.9,3.2,48.2);a.bezierCurveTo(-0.5,40.4,14.6,24.9,36.9,13.5);a.bezierCurveTo(59.2,2.2,80.3,-0.8,84,7);a.lineTo(84,7);a.closePath();a.lineWidth=5.3;a.strokeStyle="rgb(255, 255, 255)";a.lineJoin="miter";a.miterLimit=4;a.stroke()},draw:function(a){a.drawImage(this.iconCanvas,0,0)}}),c=me.Renderable.extend({init:function(a,b){me.Renderable.prototype.init.apply(this,
[0,0,a,b]);this.logo1=new me.Font("century gothic",32,"white","middle");this.logo2=new me.Font("century gothic",32,"#55aa00","middle");this.logo2.bold();this.logo1.textBaseline=this.logo2.textBaseline="alphabetic"},draw:function(a){var b=a.measureText(this.logo1,"melon").width,c=(this.width-b-a.measureText(this.logo2,"JS").width)/2,h=this.height/2+a.measureText(this.logo2,"melon").height;a.drawFont(this.logo1,"melon",c,h);a.drawFont(this.logo2,"JS",c+b,h)}});me.DefaultLoadingScreen=me.ScreenObject.extend({onResetEvent:function(){me.game.reset();
me.game.world.addChild(new me.ColorLayer("background","#202020",0));var d=new a(new me.Vector2d,me.video.renderer.getWidth(),me.video.renderer.getHeight());this.handle=me.event.subscribe(me.event.LOADER_PROGRESS,d.onProgressUpdate.bind(d));me.game.world.addChild(d,1);this.iconCanvas=me.video.createCanvas(me.game.viewport.width,me.game.viewport.height,!1);d=new b(this.iconCanvas,(me.video.renderer.getWidth()-100)/2,me.video.renderer.getHeight()/2-d.barHeight/2-90);me.game.world.addChild(d,1);me.game.world.addChild(new c(me.video.renderer.getWidth(),
me.video.renderer.getHeight()),1)},onDestroyEvent:function(){this.handle&&(me.event.unsubscribe(this.handle),this.handle=null)}})})();
(function(){me.loader=function(){function a(){m===l?e.onload?(clearTimeout(q),setTimeout(function(){e.onload();me.event.publish(me.event.LOADER_COMPLETE)},300)):console.error("no load callback defined"):q=setTimeout(a,100)}function b(a,b,c){function d(b,c){h[a.name]={data:b,isTMX:"tmx"===a.type,format:c}}"tmx"===a.type&&me.levelDirector.addTMXLevel(a.name);if(a.data)d(a.data,a.format),b();else{var f=new XMLHttpRequest,g=me.utils.getFileExtension(a.src).toLowerCase();f.overrideMimeType&&("json"===
g?f.overrideMimeType("application/json"):f.overrideMimeType("text/xml"));f.open("GET",a.src+e.nocache,!0);f.ontimeout=c;f.onreadystatechange=function(){if(4===f.readyState)if(200===f.status||0===f.status&&f.responseText){var a=null;switch(g){case "xml":case "tmx":case "tsx":a=me.device.ua.match(/msie/i)||!f.responseXML?(new DOMParser).parseFromString(f.responseText,"text/xml"):f.responseXML;a=me.TMXUtils.parse(a);"tmx"===g&&(a=a.map);g="json";break;case "json":a=JSON.parse(f.responseText);break;default:throw new e.Error("TMX file format "+
g+"not supported !");}d(a,g);b()}else c()};f.send(null)}}function c(a,b,c){var d=new XMLHttpRequest;d.overrideMimeType&&d.overrideMimeType("application/json");d.open("GET",a.src+e.nocache,!0);d.ontimeout=c;d.onreadystatechange=function(){4===d.readyState&&(200===d.status||0===d.status&&d.responseText?(k[a.name]=JSON.parse(d.responseText),b()):c())};d.send(null)}function d(a,b,c){var d=new XMLHttpRequest;d.open("GET",a.src+e.nocache,!0);d.responseType="arraybuffer";d.onerror=c;d.onload=function(){var c=
d.response;if(c){for(var c=new Uint8Array(c),e=[],f=0;f<c.byteLength;f++)e[f]=String.fromCharCode(c[f]);g[a.name]=e.join("");b()}};d.send()}var e={},f={},h={},g={},k={},l=0,m=0,q=0;e.nocache="";e.onload=void 0;e.onProgress=void 0;e.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.loader.Error"}});e.onResourceLoaded=function(a){m++;var b=e.getLoadProgress();if(e.onProgress)e.onProgress(b,a);me.event.publish(me.event.LOADER_PROGRESS,[b,a])};e.onLoadingError=
function(a){throw new e.Error("Failed loading resource "+a.src);};e.setNocache=function(a){e.nocache=a?"?"+~~(1E7*Math.random()):""};e.preload=function(b){for(var c=0;c<b.length;c++)l+=e.load(b[c],e.onResourceLoaded.bind(e,b[c]),e.onLoadingError.bind(e,b[c]));a()};e.load=function(a,g,h){a.name=a.name.toLowerCase();switch(a.type){case "binary":return d.call(this,a,g,h),1;case "image":return f[a.name]=new Image,f[a.name].onload=g,f[a.name].onerror=h,f[a.name].src=a.src+e.nocache,1;case "json":return c.call(this,
a,g,h),1;case "tmx":case "tsx":return b.call(this,a,g,h),1;case "audio":return me.audio.load(a,g,h),1;default:throw new e.Error("load : unknown or invalid resource type : "+a.type);}};e.unload=function(a){a.name=a.name.toLowerCase();switch(a.type){case "binary":if(!(a.name in g))return!1;delete g[a.name];return!0;case "image":if(!(a.name in f))return!1;"function"===typeof f[a.name].dispose&&f[a.name].dispose();delete f[a.name];return!0;case "json":if(!(a.name in k))return!1;delete k[a.name];return!0;
case "tmx":case "tsx":if(!(a.name in h))return!1;delete h[a.name];return!0;case "audio":return me.audio.unload(a.name);default:throw new e.Error("unload : unknown or invalid resource type : "+a.type);}};e.unloadAll=function(){for(var a in g)g.hasOwnProperty(a)&&e.unload({name:a,type:"binary"});for(a in f)f.hasOwnProperty(a)&&e.unload({name:a,type:"image"});for(a in h)h.hasOwnProperty(a)&&e.unload({name:a,type:"tmx"});for(a in k)k.hasOwnProperty(a)&&e.unload({name:a,type:"json"});me.audio.unloadAll()};
e.getTMX=function(a){a=(""+a).toLowerCase();return a in h?h[a].data:null};e.getBinary=function(a){a=(""+a).toLowerCase();return a in g?g[a]:null};e.getImage=function(a){a=(""+a).toLowerCase();return a in f?f[a]:null};e.getJSON=function(a){a=(""+a).toLowerCase();return a in k?k[a]:null};e.getLoadProgress=function(){return m/l};return e}()})();
(function(){me.Font=me.Renderable.extend({init:function(a,b,c,d){this.fontSize=new me.Vector2d;this.fillStyle=c||"#000000";this.strokeStyle="#000000";this.lineWidth=1;this.textAlign=d||"left";this.textBaseline="top";this.lineHeight=1;this.setFont(a,b,c,d);this.pos=new me.Vector2d(0,0);me.Renderable.prototype.init.apply(this,[this.pos.x,this.pos.y,0,this.fontSize.y]);this.gid||(this.gid=me.utils.createGUID())},bold:function(){this.font="bold "+this.font},italic:function(){this.font="italic "+this.font},
setFont:function(a,b,c,d){a=a.split(",").map(function(a){a=a.trim();return/(^".*"$)|(^'.*'$)/.test(a)?a:'"'+a+'"'});this.fontSize.y=+b;this.height=this.fontSize.y;"number"===typeof b&&(b+="px");this.font=b+" "+a.join(",");this.fillStyle=c;d&&(this.textAlign=d)},measureText:function(a,b){a.font=this.font;a.fillStyle=this.fillStyle;a.textAlign=this.textAlign;a.textBaseline=this.textBaseline;this.height=this.width=0;for(var c=(""+b).split("\n"),d=0;d<c.length;d++)this.width=Math.max(a.measureText(c[d].trimRight()).width,
this.width),this.height+=this.fontSize.y*this.lineHeight;return{width:this.width,height:this.height}},draw:function(a,b,c,d){c=~~c;d=~~d;var e=a.globalAlpha;a.globalAlpha*=this.getOpacity();this.pos.set(c,d);a.font=this.font;a.fillStyle=this.fillStyle;a.textAlign=this.textAlign;a.textBaseline=this.textBaseline;b=(""+b).split("\n");for(var f=0;f<b.length;f++)a.fillText(b[f].trimRight(),c,d),d+=this.fontSize.y*this.lineHeight;a.globalAlpha=e},drawStroke:function(a,b,c,d){c=~~c;d=~~d;var e=a.globalAlpha;
a.globalAlpha*=this.getOpacity();this.pos.set(c,d);a.font=this.font;a.fillStyle=this.fillStyle;a.strokeStyle=this.strokeStyle;a.lineWidth=this.lineWidth;a.textAlign=this.textAlign;a.textBaseline=this.textBaseline;b=(""+b).split("\n");for(var f=0;f<b.length;f++){var h=b[f].trimRight();a.strokeText(h,c,d);a.fillText(h,c,d);d+=this.fontSize.y*this.lineHeight}a.globalAlpha=e}})})();
(function(){me.BitmapFont=me.Font.extend({init:function(a,b,c,d){this.sSize=new me.Vector2d;this.firstChar=32;this.charCount=0;me.Font.prototype.init.apply(this,[a,null,null]);this.firstChar=d||32;this.loadFontMetrics(a,b);this.textAlign="left";this.textBaseline="top";c&&this.resize(c)},loadFontMetrics:function(a,b){this.font=me.loader.getImage(a);this.fontSize.x=b.x||b;this.fontSize.y=b.y||this.font.height;this.sSize.copy(this.fontSize);this.height=this.sSize.y;this.charCount=~~(this.font.width/
this.fontSize.x)},set:function(a,b){this.textAlign=a;b&&this.resize(b)},resize:function(a){this.sSize.setV(this.fontSize);this.sSize.x*=a;this.sSize.y*=a;this.height=this.sSize.y},measureText:function(a,b){for(var c=(""+b).split("\n"),d=this.height=this.width=0;d<c.length;d++)this.width=Math.max(c[d].trimRight().length*this.sSize.x,this.width),this.height+=this.sSize.y*this.lineHeight;return{width:this.width,height:this.height}},draw:function(a,b,c,d){b=(""+b).split("\n");var e=c,f=this.sSize.y*this.lineHeight,
h=a.globalAlpha();a.setGlobalAlpha(h*this.getOpacity());this.pos.set(c,d);for(var g=0;g<b.length;g++){c=e;var k=b[g].trimRight(),l=k.length*this.sSize.x;switch(this.textAlign){case "right":c-=l;break;case "center":c-=0.5*l}switch(this.textBaseline){case "middle":d-=0.5*f;break;case "ideographic":case "alphabetic":case "bottom":d-=f}for(var l=0,m=k.length;l<m;l++){var q=k.charCodeAt(l)-this.firstChar;0<=q&&a.drawImage(this.font,this.fontSize.x*(q%this.charCount),this.fontSize.y*~~(q/this.charCount),
this.fontSize.x,this.fontSize.y,~~c,~~d,this.sSize.x,this.sSize.y);c+=this.sSize.x}d+=f}a.setGlobalAlpha(h)}})})();
(function(){me.audio=function(){function a(a,d){if(3<e++){var g="melonJS: failed loading "+a;if(!1===me.sys.stopOnAudioError)me.audio.disable(),d&&d(),console.log(g+", disabling audio");else throw new b.Error(g);}else c[a].load()}var b={},c={},d=null,e=0;b.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.audio.Error"}});b.init=function(a){if(!me.initialized)throw new b.Error("me.audio.init() called before engine initialization.");this.audioFormats=("string"===
typeof a?a:"mp3").split(",");return!Howler.noAudio};b.enable=function(){this.unmuteAll()};b.disable=function(){this.muteAll()};b.load=function(d,h,g){var k=[];if("undefined"===typeof this.audioFormats||0===this.audioFormats.length)throw new b.Error("target audio extension(s) should be set through me.audio.init() before calling the preloader.");for(var l=0;l<this.audioFormats.length;l++)k.push(d.src+d.name+"."+this.audioFormats[l]+me.loader.nocache);c[d.name]=new Howl({src:k,volume:Howler.volume(),
onloaderror:function(){c[d.name]=this;a.call(me.audio,d.name,g)},onload:function(){c[d.name]=this;e=0;h&&h()}});return 1};b.play=function(a,b,d,e){if((a=c[a.toLowerCase()])&&"undefined"!==typeof a){var l=a.play();"boolean"===typeof b&&a.loop(b,l);a.volume("number"===typeof e?e.clamp(0,1):Howler.volume(),l);if("function"===typeof d)if(!0===b)a.on("end",d,l);else a.once("end",d,l);return l}};b.fade=function(a,b,d,e,l){(a=c[a.toLowerCase()])&&"undefined"!==typeof a&&a.fade(b,d,e,l)};b.stop=function(a,
b){var d=c[a.toLowerCase()];d&&"undefined"!==typeof d&&(d.stop(b),d.off("end",b))};b.pause=function(a,b){var d=c[a.toLowerCase()];d&&"undefined"!==typeof d&&d.pause(b)};b.playTrack=function(a,b){d=a.toLowerCase();return me.audio.play(d,!0,null,b)};b.stopTrack=function(){null!==d&&(c[d].stop(),d=null)};b.pauseTrack=function(){null!==d&&c[d].pause()};b.resumeTrack=function(){null!==d&&c[d].play()};b.getCurrentTrack=function(){return d};b.setVolume=function(a){Howler.volume(a)};b.getVolume=function(){return Howler.volume()};
b.mute=function(a,b,d){d="undefined"===typeof d?!0:!!d;(a=c[a.toLowerCase()])&&"undefined"!==typeof a&&a.mute(d,b)};b.unmute=function(a,c){b.mute(a,c,!1)};b.muteAll=function(){Howler.mute(!0)};b.unmuteAll=function(){Howler.mute(!1)};b.unload=function(a){a=a.toLowerCase();if(!(a in c))return!1;c[a].unload();delete c[a];return!0};b.unloadAll=function(){for(var a in c)c.hasOwnProperty(a)&&b.unload(a)};return b}()})();
(function(){me.CanvasRenderer=function(){var a={},b=null,c=null,d=null,e=null,f=null,h=null,g=[],k=0,l=0;a.init=function(g,q,r,n,v,p){b=g;c=this.getContext2d(b);(d=n)?(e=me.video.createCanvas(q,r,!1),f=this.getContext2d(e)):(e=b,f=c);l=v;k=p;h=new me.Color(255,255,255,1);a.setColor(h);return this};a.applyRGBFilter=function(b,c,d){var e=a.getContext2d(me.video.createCanvas(b.width,b.height,!1));b=me.utils.getPixels(b);var g=b.data;switch(c){case "b&w":c=0;for(d=g.length;c<d;c+=4){var f=3*g[c]+4*g[c+
1]+g[c+2]>>>3;g[c]=f;g[c+1]=f;g[c+2]=f}break;case "brightness":f=Math.abs(d).clamp(0,1);c=0;for(d=g.length;c<d;c+=4)g[c]*=f,g[c+1]*=f,g[c+2]*=f;break;case "transparent":var f=me.pool.pull("me.Color").parseCSS(d),h=me.pool.pull("me.Color");c=0;for(d=g.length;c<d;c+=4)h.setColor(g[c],g[c+1],g[c+2]),h.equals(f)&&(g[c+3]=0);me.pool.push(f);me.pool.push(h);break;default:return null}e.putImageData(b,0,0);return e};a.blitSurface=function(){a.blitSurface=d?function(){c.drawImage(e,0,0,e.width,e.height,0,
0,l,k)}:function(){};a.blitSurface()};a.clearSurface=function(a,b){a||(a=f);var c=a.canvas;a.save();a.setTransform(1,0,0,1,0,0);a.fillStyle=b instanceof me.Color?b.toRGBA():b;a.fillRect(0,0,c.width,c.height);a.restore()};a.drawFont=function(a,b,c,d){a.draw(f,b,c,d)};a.drawLine=function(a,b,c,d){f.translate(a,b);f.beginPath();f.moveTo(0,0);f.lineTo(c,d);f.stroke();f.closePath();f.translate(-a,-b)};a.drawImage=function(){f.drawImage.apply(f,arguments)};a.fillArc=function(a,b,c,d,e,g){f.save();f.beginPath();
f.translate(a+c,b+c);f.arc(0,0,c,d,e,g||!1);f.fill();f.closePath();f.restore()};a.fillRect=function(a,b,c,d){f.fillRect(a,b,c,d)};a.getScreenCanvas=function(){return b};a.getScreenContext=function(){return c};a.getContext2d=function(a){if("undefined"===typeof a||null===a)throw new me.video.Error("You must pass a canvas element in order to create a 2d context");if("undefined"===typeof a.getContext)throw new me.video.Error("Your browser does not support HTML5 canvas.");var b;b=navigator.isCocoonJS?
a.getContext("2d",{antialias:me.sys.scalingInterpolation}):a.getContext("2d");b.canvas||(b.canvas=a);this.setImageSmoothing(b,me.sys.scalingInterpolation);return b};a.getCanvas=function(){return e};a.getColor=function(){return h.clone()};a.getContext=function(){return f};a.getWidth=function(){return e.width};a.getHeight=function(){return e.height};a.globalAlpha=function(){return h.alpha};a.measureText=function(a,b){return a.measureText(f,b)};a.resetTransform=function(){f.setTransform(1,0,0,1,0,0)};
a.resize=function(a,d){b.width=l=e.width*a;b.height=k=e.height*d;1<me.device.getPixelRatio()&&(b.style.width=b.width/me.device.getPixelRatio()+"px",b.style.height=b.height/me.device.getPixelRatio()+"px");this.setImageSmoothing(c,me.sys.scalingInterpolation);this.blitSurface()};a.save=function(){g.push(a.getColor());f.save()};a.restore=function(){var b=g.pop();me.pool.push("me.Color",b);f.restore();a.setColor(b)};a.rotate=function(a){f.rotate(a)};a.scale=function(a,b){f.scale(a,b)};a.setAlpha=function(a){f.globalCompositeOperation=
a?"source-over":"copy"};a.setColor=function(a){h.copy(a);f.strokeStyle=f.fillStyle=h.toRGBA()};a.setGlobalAlpha=function(a){h.setColor(h.r,h.g,h.b,a);f.globalAlpha=a};a.setImageSmoothing=function(a,b){me.agent.setPrefixed("imageSmoothingEnabled",!0===b,a)};a.setLineWidth=function(a){f.lineWidth=a};a.strokeArc=function(a,b,c,d,e,g){f.beginPath();f.translate(a+c,b+c);f.arc(0,0,c,d,e,g||!1);f.stroke();f.closePath()};a.strokeEllipse=function(a,b,d,e){c.beginPath();var g=a-d,h=a+d,k=b-e,l=b+e,w=0.551784*
d;d=0.551784*e;e=a-w;var w=a+w,A=b-d;d=b+d;f.moveTo(a,k);f.bezierCurveTo(w,k,h,A,h,b);f.bezierCurveTo(h,d,w,l,a,l);f.bezierCurveTo(e,l,g,d,g,b);f.bezierCurveTo(g,A,e,k,a,k);f.stroke()};a.strokeLine=function(a,b,d,e){c.beginPath();c.moveTo(a,b);c.lineTo(d,e);c.stroke()};a.strokePolygon=function(a){f.translate(a.pos.x,a.pos.y);f.beginPath();f.moveTo(a.points[0].x,a.points[0].y);for(var b,c=1;c<a.points.length;c++)b=a.points[c],f.lineTo(b.x,b.y);f.lineTo(a.points[0].x,a.points[0].y);f.stroke();f.closePath();
f.translate(-a.pos.x,-a.pos.y)};a.strokeRect=function(a,b,c,d){f.strokeRect(a,b,c,d)};a.drawShape=function(b){b instanceof me.Rect?a.strokeRect(b.left,b.top,b.width,b.height):b instanceof me.Line||b instanceof me.Polygon?(a.save(),a.strokePolygon(b),a.restore()):b instanceof me.Ellipse&&(a.save(),b.radiusV.x===b.radiusV.y?a.strokeArc(b.pos.x-b.radius,b.pos.y-b.radius,b.radius,0,2*Math.PI):a.strokeEllipse(b.pos.x,b.pos.y,b.radiusV.x,b.radiusV.y),a.restore())};a.transform=function(a,b,c,d,e,g){f.transform(a,
b,c,d,e,g)};a.translate=function(a,b){f.translate(a,b)};return a}()})();
(function(){me.video=function(){function a(){try{return me.WebGLRenderer.init.apply(me.WebGLRenderer,arguments)}catch(a){return me.CanvasRenderer.init.apply(me.CanvasRenderer,arguments)}}var b={},c=null,d=null,e=-1,f=!1,h=!1,g=!0,k=Infinity,l=Infinity;b.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.video.Error"}});b.CANVAS=0;b.WEBGL=1;b.AUTO=2;b.init=function(e,k,l,n,v,p,s){if(!me.initialized)throw new b.Error("me.video.init() called before engine initialization.");f=
v||!1;h="auto"===p||!1;g="undefined"!==typeof s?s:!0;p=h?1:+p||1;me.sys.scale=new me.Vector2d(p,p);if(h||1!==p)f=!0;v=l*me.sys.scale.x;p=n*me.sys.scale.y;window.addEventListener("resize",throttle(100,!1,function(a){me.event.publish(me.event.WINDOW_ONRESIZE,[a])}),!1);window.addEventListener("orientationchange",function(a){me.event.publish(me.event.WINDOW_ONORIENTATION_CHANGE,[a])},!1);me.event.subscribe(me.event.WINDOW_ONRESIZE,me.video.onresize.bind(me.video));me.event.subscribe(me.event.WINDOW_ONORIENTATION_CHANGE,
me.video.onresize.bind(me.video));c=b.createCanvas(v,p,!0);e&&(d=document.getElementById(e));d||(d=document.body);d.appendChild(c);if(!c.getContext)return!1;switch(k){case b.WEBGL:this.renderer=me.WebGLRenderer.init(c,l,n);break;case b.AUTO:this.renderer=a(c,l,n,f,v,p);break;default:this.renderer=me.CanvasRenderer.init(c,l,n,f,v,p)}e=me.device.getPixelRatio();1<e&&(c.style.width=c.width/e+"px",c.style.height=c.height/e+"px");window.getComputedStyle&&(e=window.getComputedStyle(c,null),me.video.setMaxSize(parseInt(e.maxWidth,
10),parseInt(e.maxHeight,10)));me.video.onresize();me.game.init();return!0};b.getPos=function(a){a=a||this.renderer.getScreenCanvas();return a.getBoundingClientRect?a.getBoundingClientRect():{left:0,top:0}};b.setMaxSize=function(a,b){k=a||Infinity;l=b||Infinity};b.createCanvas=function(a,d,e){if(0===a||0===d)throw new b.Error("width or height was zero, Canvas could not be initialized !");var g=document.createElement("canvas");!0===e&&navigator.isCocoonJS&&!0!==me.device.android2&&(g.screencanvas=
!0);g.width=a||c.width;g.height=d||c.height;return g};b.getWrapper=function(){return d};b.onresize=function(){var a=1,b=1;me.device.orientation="undefined"!==typeof window.orientation?window.orientation:window.outerWidth>window.outerHeight?90:0;if(h){var c=me.video.renderer.getScreenCanvas().parentNode,a=Math.min(k,c.width||window.innerWidth),c=Math.min(l,c.height||window.innerHeight);if(g)var d=me.video.renderer.getWidth()/me.video.renderer.getHeight(),a=a/c<d?b=a/me.video.renderer.getWidth():b=
c/me.video.renderer.getHeight();else a/=me.video.renderer.getWidth(),b=c/me.video.renderer.getHeight();a*=me.device.getPixelRatio();b*=me.device.getPixelRatio();if(1!==a||1!==b){0<=e&&clearTimeout(e);e=me.video.updateDisplaySize.defer(this,a,b);return}}me.input._offset=me.video.getPos()};b.updateDisplaySize=function(a,b){me.sys.scale.set(a,b);this.renderer.resize(a,b);me.input._offset=me.video.getPos();e=-1};b.setAlpha=function(a){this.renderer.setAlpha(a)};return b}()})();
(function(){me.video.shader=function(){function a(a,b,e){b=a.createShader(b);a.shaderSource(b,e);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))throw new me.video.Error(a.getShaderInfoLog(b));return b}var b={attributes:{},uniforms:{},handle:null,bind:function(){},createShader:function(c){var d=b.handle=c.createProgram();c.attachShader(d,a(c,c.VERTEX_SHADER,"attribute vec2 aPosition;\nattribute vec2 aTexture;\nuniform mat3 uMatrix;\nuniform mat3 pMatrix;\nvarying vec2 vTexCoord;\nvoid main(void) {\n   gl_Position = vec4((pMatrix * (uMatrix * vec3(aPosition, 1))).xy, 0, 1);\n   vTexCoord = aTexture;\n}\n"));
c.attachShader(d,a(c,c.FRAGMENT_SHADER,"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec4 uColor;\nuniform sampler2D texture;\nvoid main(void) {\n    gl_FragColor = texture2D(texture, vec2(vTexCoord.s, vTexCoord.t)) * uColor;\n}\n"));c.linkProgram(d);if(!c.getProgramParameter(d,c.LINK_STATUS))throw new me.video.Error("Could not initialize shaders");c.useProgram(d);var e={},f={};["aPosition","aTexture"].forEach(function(a){f[a]={location:c.getAttribLocation(d,a)};c.enableVertexAttribArray(f[a].location);
e[a]={get:function(a){return function(){return f[a]}}(a)}});Object.defineProperties(b.attributes,e);var h={},g={};["pMatrix","uMatrix","uColor","texture"].forEach(function(a){g[a]={location:c.getUniformLocation(d,a)};h[a]={get:function(a){return function(){return g[a]}}(a),set:function(a){return"uColor"===a?function(b){c.uniform4fv(g[a].location,b)}:"texture"===a?function(){c.uniform1i(g[a].location,0)}:function(b){c.uniformMatrix3fv(g[a].location,!1,b)}}(a)}});Object.defineProperties(b.uniforms,
h);return b},gltexture2d:function(a,b){var e=a.createTexture(),f=me.sys.scalingInterpolation?a.LINEAR:a.NEAREST;e.bind=function(){a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,e);return e};e.bind();a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,f);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,f);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);return e}};
return b}()})();
(function(){me.WebGLRenderer=function(){var a={},b=null,c=[],d=null,e={},f=null,h=null,g=null,k=null,l=new Float32Array(8),m=new Float32Array(8),q=[],r=null,n=null,v=null,p=new Float32Array(12),s=null,t=new Float32Array(12),w=null;a.init=function(a,c,e){b=a;g=this.getContextGL(a);g.FALSE=!1;g.TRUE=!0;d={width:c,height:e};this.uniformMatrix=new me.Matrix3d;this.projection=new me.Matrix3d({val:new Float32Array([2/c,0,0,0,-2/e,0,-1,1,1])});this.createShader();n.bind();g.enableVertexAttribArray(n.attributes.aTexture.location);g.enableVertexAttribArray(n.attributes.aPosition.location);
k=new me.Color(255,255,255,1);f=me.video.createCanvas(c,e,!1);h=me.CanvasRenderer.getContext2d(f);w=g.createTexture();g.bindTexture(g.TEXTURE_2D,w);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,1,1,0,g.RGBA,g.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]));this.createBuffers();g.clearColor(0,0,0,1);g.enable(g.BLEND);g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA);s=g.getUniformLocation(n.handle,"texture");this.resize(1,1);return this};a.applyProjection=function(){n.uniforms.pMatrix=this.projection.val};a.bindTexture=
function(a){var b=a.width,c=a.height;a.texture=me.video.shader.gltexture2d(g,a);a.vb=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,a.vb);g.bufferData(g.ARRAY_BUFFER,new Float32Array([0,0,b,0,0,c,b,c]),g.STATIC_DRAW);a.t={};this.cacheTextureCoords(a,"0,0,"+b+","+c,0,0,b,c);a.ib=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.ib);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,1,3]),g.STATIC_DRAW)};a.bindTextureCoords=function(a,b,c,d,e){var f=b+","+c+","+d+","+e;f in a.t?g.bindBuffer(g.ARRAY_BUFFER,
a.t[f]):this.cacheTextureCoords(a,f,b,c,d,e)};a.cacheTextureCoords=function(a,b,c,d,e,f){e=(c+e)/a.width;f=(d+f)/a.height;c/=a.width;d/=a.height;a.t[b]=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,a.t[b]);g.bufferData(g.ARRAY_BUFFER,new Float32Array([c,d,e,d,c,f,e,f]),g.STATIC_DRAW)};a.blitSurface=function(){};a.clearSurface=function(a,d){c.push(this.getColor());this.setColor(d);this.fillRect(0,0,b.width,b.height);this.setColor(c.pop())};a.createBuffers=function(){v=g.createBuffer();r=g.createBuffer()};
a.createShader=function(){n=me.video.shader.createShader(g)};a.drawFont=function(a,c,d,g){var p=a.gid;if(e[p]){var k=e[p];if(a.font!==k.font||a.fontSize!==k.fontSize||a.fillStyle!==k.fillStyle||a.textAlign!==k.textAlign||a.textBaseline!==k.textBaseline||a.lineHeight!==k.lineHeight||c!==k.text){k.font=a.font;k.fontSize=a.fontSize;k.fillStyle=a.fillStyle;k.textAlign=a.textAlign;k.textBaseline=a.textBaseline;k.lineHeight=a.lineHeight;k.text=c;a.draw(h,c,d,g);c=a.measureText(h,c);k.yOffset=0;switch(k.textBaseline){case "alphabetic":case "ideographic":case "bottom":k.yOffset=
c.height;break;case "middle":k.yOffset=c.height/2}k.width=c.width;k.height=1.2*c.height;k.image=h.getImageData(0,0,f.width,f.height);h.clearRect(0,0,b.width,b.height)}}else{a.draw(h,c,d,g);c=a.measureText(h,c);e[p]={font:a.font,fontSize:a.fontSize,fillStyle:a.fillStyle,textAlign:a.textAlign,textBaseline:a.textBaseline,lineHeight:a.lineHeight,text:a.text,image:h.getImageData(0,0,f.width,f.height),width:c.width,height:1.2*c.height,yOffset:0};switch(a.textBaseline){case "alphabetic":case "ideographic":case "bottom":e[p].yOffset=
c.height;break;case "middle":e[p].yOffset=c.height/2}h.clearRect(0,0,b.width,b.height)}g-=e[p].yOffset;this.drawImage(e[p].image,d,g,e[p].width,e[p].height,d,g,e[p].width,e[p].height)};a.drawLine=function(){};a.drawImage=function(a,b,c,d,e,f,h,p,s){"undefined"===typeof a.texture&&this.bindTexture(a);"undefined"===typeof d?(d=p=a.width,e=s=a.height,f=b,h=c,c=b=0):"undefined"===typeof f&&(f=b,h=c,p=d,s=e,d=a.width,e=a.height,c=b=0);q.push(this.uniformMatrix.clone());this.uniformMatrix.translate(~~f,
~~h);this.uniformMatrix.scale(p/a.width,s/a.height);g.bindBuffer(g.ARRAY_BUFFER,a.vb);g.vertexAttribPointer(n.attributes.aPosition.location,2,g.FLOAT,!1,0,0);this.bindTextureCoords(a,~~b,~~c,~~d,~~e);g.vertexAttribPointer(n.attributes.aTexture.location,2,g.FLOAT,!1,0,0);n.uniforms.texture=a.texture.bind();n.uniforms.uMatrix=this.uniformMatrix.val;n.uniforms.uColor=k.toGL();g.drawElements(g.TRIANGLES,6,g.UNSIGNED_SHORT,0);this.uniformMatrix.copy(q.pop())};a.fillRect=function(a,b,c,d){c=a+c;d=b+d;t[0]=
a;t[1]=b;t[2]=c;t[3]=b;t[4]=a;t[5]=d;t[6]=a;t[7]=d;t[8]=c;t[9]=b;t[10]=c;t[11]=d;g.bindBuffer(g.ARRAY_BUFFER,r);g.bufferData(g.ARRAY_BUFFER,t,g.STATIC_DRAW);g.vertexAttribPointer(n.attributes.aPosition.location,2,g.FLOAT,!1,0,0);p[0]=0;p[1]=0;p[2]=1;p[3]=0;p[4]=0;p[5]=1;p[6]=0;p[7]=1;p[8]=1;p[9]=0;p[10]=1;p[11]=1;g.activeTexture(g.TEXTURE0);g.bindTexture(g.TEXTURE_2D,w);g.bindBuffer(g.ARRAY_BUFFER,v);g.bufferData(g.ARRAY_BUFFER,p,g.STATIC_DRAW);g.vertexAttribPointer(n.attributes.aTexture.location,
2,g.FLOAT,!1,0,0);g.uniform1i(s,0);n.uniforms.uMatrix=this.uniformMatrix.val;n.uniforms.uColor=k.toGL();g.drawArrays(g.TRIANGLES,0,6)};a.getScreenCanvas=function(){return b};a.getScreenContext=function(){return g};a.getContextGL=function(a){if("undefined"===typeof a||null===a)throw new me.video.Error("You must pass a canvas element in order to create a GL context");if("undefined"===typeof a.getContext)throw new me.video.Error("Your browser does not support WebGL.");var b={antialias:me.sys.scalingInterpolation};
return a.getContext("webgl",b)||a.getContext("experimental-webgl",b)};a.getCanvas=function(){return b};a.getColor=function(){return k.clone()};a.getContext=function(){return g};a.getWidth=function(){return g.canvas.width};a.getHeight=function(){return g.canvas.height};a.globalAlpha=function(){return k.alpha};a.measureText=function(a,b){return a.measureText(h,b)};a.resetTransform=function(){this.uniformMatrix.identity()};a.resize=function(a,c){b.width=d.width;b.height=d.height;var e=d.width*a,f=d.height*
c;1<me.device.getPixelRatio()?(b.style.width=e/me.device.getPixelRatio()+"px",b.style.height=f/me.device.getPixelRatio()+"px"):(b.style.width=e+"px",b.style.height=f+"px");g.viewport(0,0,d.width,d.height);this.setProjection();this.applyProjection()};a.restore=function(){var a=c.pop();me.pool.push("me.Color",a);k.copy(a);this.uniformMatrix.copy(q.pop())};a.rotate=function(a){this.uniformMatrix.rotate(a)};a.save=function(){c.push(this.getColor());q.push(this.uniformMatrix.clone())};a.scale=function(a,
b){this.uniformMatrix.scale(a,b)};a.setAlpha=function(){};a.setProjection=function(){this.projection.set(2/b.width,0,0,0,-2/b.height,0,-1,1,1)};a.setImageSmoothing=function(){};a.setGlobalAlpha=function(a){k.setColor(k.r,k.g,k.b,a)};a.setColor=function(a){k.copy(a)};a.setLineWidth=function(){};a.strokeArc=function(){};a.strokeEllipse=function(){};a.strokeLine=function(){};a.strokePolygon=function(){};a.strokeRect=function(a,b,c,d){c=a+c;d=b+d;m[0]=a;m[1]=b;m[2]=c;m[3]=b;m[4]=c;m[5]=d;m[6]=a;m[7]=
d;g.bindBuffer(g.ARRAY_BUFFER,r);g.bufferData(g.ARRAY_BUFFER,m,g.STATIC_DRAW);g.vertexAttribPointer(n.attributes.aPosition.location,2,g.FLOAT,!1,0,0);l[0]=0;l[1]=0;l[2]=1;l[3]=0;l[4]=1;l[5]=1;l[6]=0;l[7]=1;g.activeTexture(g.TEXTURE0);g.bindTexture(g.TEXTURE_2D,w);g.bindBuffer(g.ARRAY_BUFFER,v);g.bufferData(g.ARRAY_BUFFER,l,g.STATIC_DRAW);g.vertexAttribPointer(n.attributes.aTexture.location,2,g.FLOAT,!1,0,0);g.uniform1i(s,0);n.uniforms.uMatrix=this.uniformMatrix.val;n.uniforms.uColor=k.toGL();g.drawArrays(g.LINE_LOOP,
0,4)};a.drawShape=function(b){b instanceof me.Rect?a.strokeRect(b.left,b.top,b.width,b.height):b instanceof me.Line||b instanceof me.Polygon?(a.save(),a.strokePolygon(b),a.restore()):b instanceof me.Ellipse&&(a.save(),b.radiusV.x===b.radiusV.y?a.strokeArc(b.pos.x-b.radius,b.pos.y-b.radius,b.radius,0,2*Math.PI):a.strokeEllipse(b.pos.x,b.pos.y,b.radiusV.x,b.radiusV.y),a.restore())};a.transform=function(a,b,c,d,e,g){var f=new Float32Array(9);f[0]=a;f[1]=b;f[2]=0;f[3]=c;f[4]=d;f[5]=0;f[6]=e;f[7]=g;f[8]=
1;this.uniformMatrix.multiplyArray(f)};a.translate=function(a,b){this.uniformMatrix.translate(a,b)};return a}()})();(function(){me.input=function(){return{_preventDefault:function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0;a.preventDefault?a.preventDefault():a.returnValue=!1;return!1},preventDefault:!0}}()})();
(function(){var a=me.input;a._KeyBinding={};var b={},c={},d={},e={},f={},h=!1;a._enableKeyboardEvent=function(){h||(window.addEventListener("keydown",a._keydown,!1),window.addEventListener("keyup",a._keyup,!1),h=!0)};a._keydown=function(c,h,l){h=h||c.keyCode||c.which;var m=a._KeyBinding[h];me.event.publish(me.event.KEYDOWN,[m,h,m?!d[m]:!0]);return m&&(d[m]||(l=l?l:h,e[m][l]||(b[m]++,e[m][l]=!0)),f[h])?a._preventDefault(c):!0};a._keyup=function(c,h,l){h=h||c.keyCode||c.which;var m=a._KeyBinding[h];
me.event.publish(me.event.KEYUP,[m,h]);return m&&(e[m][l?l:h]=void 0,0<b[m]&&b[m]--,d[m]=!1,f[h])?a._preventDefault(c):!0};a.KEY={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINT_SCREEN:42,INSERT:45,DELETE:46,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,
U:85,V:86,W:87,X:88,Y:89,Z:90,WINDOW_KEY:91,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,FORWAND_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};a.isKeyPressed=
function(a){return b[a]&&!d[a]?(c[a]&&(d[a]=!0),!0):!1};a.keyStatus=function(a){return 0<b[a]};a.triggerKeyEvent=function(b,c){c?a._keydown({},b):a._keyup({},b)};a.bindKey=function(g,h,l,m){a._enableKeyboardEvent();"boolean"!==typeof m&&(m=a.preventDefault);a._KeyBinding[g]=h;f[g]=m;b[h]=0;c[h]=l?l:!1;d[h]=!1;e[h]={}};a.unlockKey=function(a){d[a]=!1};a.unbindKey=function(d){var h=a._KeyBinding[d];b[h]=0;c[h]=!1;e[h]={};a._KeyBinding[d]=null;f[d]=null}})();
(function(){function a(a,b){for(var c=2;c<a.length;++c)"undefined"!==typeof a[c]&&me.video.renderer.getScreenCanvas().addEventListener(a[c],b,!1)}function b(){l||(u.push({x:0,y:0}),g.mouse.pos=new me.Vector2d(0,0),g._offset=me.video.getPos(),window.addEventListener("scroll",throttle(100,!1,function(a){g._offset=me.video.getPos();me.event.publish(me.event.WINDOW_ONSCROLL,[a])}),!1),r=navigator.pointerEnabled?n:navigator.msPointerEnabled?v:me.device.touch?s:p,a(r,h),m="onwheel"in document.createElement("div")?
"wheel":"mousewheel",window.addEventListener(m,e,!1),"undefined"===typeof g.throttlingInterval&&(g.throttlingInterval=~~(1E3/me.sys.fps)),17>g.throttlingInterval?me.video.renderer.getScreenCanvas().addEventListener(r[t],f,!1):me.video.renderer.getScreenCanvas().addEventListener(r[t],throttle(g.throttlingInterval,!1,function(a){f(a)}),!1),l=!0)}function c(a){var b=!1,c=k[a.type];c||(c=r.indexOf(a.type)===x?k[r[A]]:k[a.type]);if(c){me.game.viewport.localToWorld(0,0,z);for(var d=0,e=u.length;d<e;d++){if("undefined"!==
typeof a.timeStamp){if(a.timeStamp<q)continue;q=a.timeStamp}me.device.pointerEnabled||(a.pointerId=u[d].id);a.gameScreenX=u[d].x;a.gameScreenY=u[d].y;a.gameWorldX=a.gameScreenX+z.x;a.gameWorldY=a.gameScreenY+z.y;for(var f=c.length,g;f--,g=c[f];)if(!0===g.floating?(a.gameX=a.gameScreenX,a.gameY=a.gameScreenY):(a.gameX=a.gameWorldX,a.gameY=a.gameWorldY),g.rect.getBounds().containsPoint(a.gameX,a.gameY)&&!1===g.cb(a)){b=!0;break}}}return b}function d(a){var b;u.length=0;if(a.touches)for(var c=0,d=a.changedTouches.length;c<
d;c++){var e=a.changedTouches[c];b=g.globalToLocal(e.clientX,e.clientY);b.id=e.identifier;u.push(b)}else b=g.globalToLocal(a.clientX,a.clientY),b.id=a.pointerId||1,u.push(b);!1!==a.isPrimary&&g.mouse.pos.set(u[0].x,u[0].y)}function e(a){if(a.target===me.video.renderer.getScreenCanvas()){var b={deltaMode:1,type:"mousewheel",deltaX:a.deltaX,deltaY:a.deltaY,deltaZ:a.deltaZ};"mousewheel"===m&&(b.deltaY=-0.025*a.wheelDelta,a.wheelDeltaX&&(b.deltaX=-0.025*a.wheelDeltaX));if(c(b))return g._preventDefault(a)}return!0}
function f(a){d(a);return c(a)?g._preventDefault(a):!0}function h(a){d(a);if(c(a))return g._preventDefault(a);var b=a.button||0,e=g.mouse.bind[b];return e?a.type===r[w]?g._keydown(a,e,b+1):g._keyup(a,e,b+1):!0}var g=me.input,k={},l=!1,m="mousewheel",q=0,r=null,n=["mousewheel","pointermove","pointerdown","pointerup","pointercancel",void 0,void 0],v=["mousewheel","MSPointerMove","MSPointerDown","MSPointerUp","MSPointerCancel",void 0,void 0],p=["mousewheel","mousemove","mousedown","mouseup",void 0,void 0,
void 0],s=[void 0,"touchmove","touchstart","touchend","touchcancel",void 0,void 0],t=1,w=2,A=3,x=4,z=new me.Vector2d,u=[];g._offset=null;g.mouse={pos:null,LEFT:0,MIDDLE:1,RIGHT:2,bind:[0,0,0]};g.throttlingInterval=void 0;g.globalToLocal=function(a,b){var c=g._offset,d=me.device.getPixelRatio();a-=c.left;b-=c.top;c=me.sys.scale;if(1!==c.x||1!==c.y)a/=c.x,b/=c.y;return new me.Vector2d(a*d,b*d)};g.bindPointer=function(){var a=2>arguments.length?g.mouse.LEFT:arguments[0],c=2>arguments.length?arguments[0]:
arguments[1];b();if(!g._KeyBinding[c])throw new me.Error("no action defined for keycode "+c);g.mouse.bind[a]=c};g.unbindPointer=function(a){g.mouse.bind["undefined"===typeof a?me.input.mouse.LEFT:a]=null};g.registerPointerEvent=function(a,c,d,e){b();if(-1===n.indexOf(a))throw new me.Error("invalid event type : "+a);n!==r&&(a=r[n.indexOf(a)]);k[a]||(k[a]=[]);var f=!0===c.floating?!0:!1;e&&(f=!0===e?!0:!1);k[a].push({rect:c,cb:d,floating:f})};g.releasePointerEvent=function(a,b){if(-1===n.indexOf(a))throw new me.Error("invalid event type : "+
a);n!==r&&(a=r[n.indexOf(a)]);k[a]||(k[a]=[]);var c=k[a];if(c)for(var d=c.length,e;d--,e=c[d];)e.rect===b&&(e.rect=e.cb=e.floating=null,k[a].splice(d,1))};g._translatePointerEvents=function(){g.registerPointerEvent("pointermove",me.game.viewport,function(a){me.event.publish(me.event.MOUSEMOVE,[a]);return!1})}})();
(function(){var a=function(){return{decode:function(a){a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");if(me.device.nativeBase64)return window.atob(a);for(var c=[],d,e,f,h,g,k=0;k<a.length;)d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(k++)),e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(k++)),h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(k++)),g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(k++)),
d=d<<2|e>>4,e=(e&15)<<4|h>>2,f=(h&3)<<6|g,c.push(String.fromCharCode(d)),64!==h&&c.push(String.fromCharCode(e)),64!==g&&c.push(String.fromCharCode(f));return c=c.join("")},encode:function(a){a=a.replace(/\r\n/g,"\n");if(me.device.nativeBase64)return window.btoa(a);for(var c=[],d,e,f,h,g,k,l=0;l<a.length;)d=a.charCodeAt(l++),e=a.charCodeAt(l++),f=a.charCodeAt(l++),h=d>>2,d=(d&3)<<4|e>>4,g=(e&15)<<2|f>>6,k=f&63,isNaN(e)?g=k=64:isNaN(f)&&(k=64),c.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)),
c.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)),c.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)),c.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(k));return c=c.join("")}}}();me.utils=function(){var b={},c="",d=0,e=/^.*(\\|\/|\:)/,f=/\.[^\.]*$/;b.decodeBase64=function(b){return a.decode(b)};b.encodeBase64=function(b){return a.encode(b)};b.decodeBase64AsArray=function(b,c){c=c||1;var d=a.decode(b),
e,f,q,r=new Uint32Array(d.length/c);e=0;for(q=d.length/c;e<q;e++)for(r[e]=0,f=c-1;0<=f;--f)r[e]+=d.charCodeAt(e*c+f)<<(f<<3);return r};b.decompress=function(){throw new me.Error("GZIP/ZLIB compressed TMX Tile Map not supported!");};b.decodeCSV=function(a,b){a=a.trim().split("\n");for(var c=[],d=0;d<a.length;d++)for(var e=a[d].split(",",b),f=0;f<e.length;f++)c.push(+e[f]);return c};b.getBasename=function(a){return a.replace(e,"").replace(f,"")};b.getFileExtension=function(a){return a.substring(a.lastIndexOf(".")+
1,a.length)};b.getPixels=function(a){if(a instanceof HTMLImageElement){var b=me.CanvasRenderer.getContext2d(me.video.createCanvas(a.width,a.height));b.drawImage(a,0,0);return b.getImageData(0,0,a.width,a.height)}return a.getContext("2d").getImageData(0,0,a.width,a.height)};b.resetGUID=function(a){c=a.toString().toUpperCase().toHex();d=0};b.createGUID=function(){return c+"-"+d++};b.applyFriction=function(a,b){return 0>a+b?a+b*me.timer.tick:0<a-b?a-b*me.timer.tick:0};return b}()})();
(function(){var a={black:[0,0,0],silver:[192,192,129],gray:[128,128,128],white:[255,255,255],maroon:[128,0,0],red:[255,0,0],purple:[128,0,128],fuchsia:[255,0,255],green:[0,128,0],lime:[0,255,0],olive:[128,128,0],yellow:[255,255,0],navy:[0,0,128],blue:[0,0,255],teal:[0,128,128],aqua:[0,255,255],orange:[255,165,0],aliceblue:[240,248,245],antiquewhite:[250,235,215],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],blanchedalmond:[255,235,205],blueviolet:[138,43,226],
brown:[165,42,42],burlywood:[222,184,35],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],"darkgray[*]":[169,169,169],darkgreen:[0,100,0],"darkgrey[*]":[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,
122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,
105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],
lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],limegreen:[50,205,50],linen:[250,240,230],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],oldlace:[253,
245,230],olivedrab:[107,142,35],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],skyblue:[135,
206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],whitesmoke:[245,245,245],yellowgreen:[154,205,50]};me.Color=Object.extend({init:function(a,c,d,e){this.b=this.g=this.r=0;this.alpha=1;this.glArray=new Float32Array([0,0,0,1]);return this.setColor(a,c,d,e)},onResetEvent:function(a,c,
d,e){return this.setColor(a,c,d,e)},setColor:function(a,c,d,e){this.r=(~~a||0).clamp(0,255);this.g=(~~c||0).clamp(0,255);this.b=(~~d||0).clamp(0,255);this.alpha="undefined"===typeof e?1:(+e).clamp(0,1);this.glArray[0]=this.r/255;this.glArray[1]=this.g/255;this.glArray[2]=this.b/255;this.glArray[3]=this.alpha;return this},clone:function(){return me.pool.pull("me.Color",this.r,this.g,this.b,this.alpha)},copy:function(a){return a instanceof me.Color?this.setColor(a.r,a.g,a.b,a.alpha):this.parseCSS(a)},
add:function(a){return this.setColor(this.r+a.r,this.g+a.g,this.b+a.b,(this.alpha+a.alpha)/2)},darken:function(a){a=a.clamp(0,1);return this.setColor(this.r*a,this.g*a,this.b*a,this.alpha)},lighten:function(a){a=a.clamp(0,1);return this.setColor(this.r+(255-this.r)*a,this.g+(255-this.g)*a,this.b+(255-this.b)*a,this.alpha)},random:function(){return this.setColor(256*Math.random(),256*Math.random(),256*Math.random(),this.alpha)},equals:function(a){return this.r===a.r&&this.g===a.g&&this.b===a.b&&this.alpha===
a.alpha},parseCSS:function(b){return b in a?this.setColor.apply(this,a[b]):this.parseRGB(b)},parseRGB:function(a){if("string"===typeof a){var c;if("rgba"===a.substring(0,4))c=5;else if("rgb"===a.substring(0,3))c=4;else return this.parseHex(a);a=a.slice(c,-1).split(/\s*,\s*/);return this.setColor.apply(this,a)}throw new me.Color.Error("invalid parameter (not a string)");},parseHex:function(a){if("string"===typeof a){"#"===a.charAt(0)&&(a=a.substring(1,a.length));var c,d;6>a.length?(c=parseInt(a.charAt(0)+
a.charAt(0),16),d=parseInt(a.charAt(1)+a.charAt(1),16),a=parseInt(a.charAt(2)+a.charAt(2),16)):(c=parseInt(a.substring(0,2),16),d=parseInt(a.substring(2,4),16),a=parseInt(a.substring(4,6),16));return this.setColor(c,d,a)}throw new me.Color.Error("invalid parameter (not a string)");},toGL:function(){return this.glArray},toHex:function(){return"#"+this.r.toHex()+this.g.toHex()+this.b.toHex()},toRGB:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},toRGBA:function(){return"rgba("+this.r+","+
this.g+","+this.b+","+this.alpha+")"}});me.Color.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Color.Error"}})})();
(function(){me.save=function(){var a={},b={_init:function(){!0===me.device.localStorage&&(JSON.parse(localStorage.getItem("me.save"))||[]).forEach(function(b){a[b]=JSON.parse(localStorage.getItem("me.save."+b))})},add:function(c){Object.keys(c).forEach(function(d){"add"!==d&&"remove"!==d&&(function(c){Object.defineProperty(b,c,{configurable:!0,enumerable:!0,get:function(){return a[c]},set:function(b){a[c]=b;!0===me.device.localStorage&&localStorage.setItem("me.save."+c,JSON.stringify(b))}})}(d),d in
a||(b[d]=c[d]))});!0===me.device.localStorage&&localStorage.setItem("me.save",JSON.stringify(Object.keys(a)))},remove:function(b){"add"!==b&&"remove"!==b&&"undefined"!==typeof a[b]&&(delete a[b],!0===me.device.localStorage&&(localStorage.removeItem("me.save."+b),localStorage.setItem("me.save",JSON.stringify(Object.keys(a)))))}};return b}()})();
(function(){me.TMXConstants={COLLISION_GROUP:"collision",TMX_TAG_MAP:"map",TMX_TAG_NAME:"name",TMX_TAG_VALUE:"value",TMX_TAG_VERSION:"version",TMX_TAG_ORIENTATION:"orientation",TMX_TAG_WIDTH:"width",TMX_TAG_HEIGHT:"height",TMX_TAG_TYPE:"type",TMX_TAG_OPACITY:"opacity",TMX_TAG_TRANS:"trans",TMX_TAG_TILEWIDTH:"tilewidth",TMX_TAG_TILEHEIGHT:"tileheight",TMX_TAG_TILEOFFSET:"tileoffset",TMX_TAG_FIRSTGID:"firstgid",TMX_TAG_GID:"gid",TMX_TAG_TILE:"tile",TMX_TAG_ID:"id",TMX_TAG_DATA:"data",TMX_TAG_COMPRESSION:"compression",
TMX_TAG_GZIP:"gzip",TMX_TAG_ZLIB:"zlib",TMX_TAG_ENCODING:"encoding",TMX_TAG_ATTR_BASE64:"base64",TMX_TAG_CSV:"csv",TMX_TAG_SPACING:"spacing",TMX_TAG_MARGIN:"margin",TMX_TAG_PROPERTIES:"properties",TMX_TAG_PROPERTY:"property",TMX_TAG_IMAGE:"image",TMX_TAG_SOURCE:"source",TMX_TAG_VISIBLE:"visible",TMX_TAG_TILESET:"tileset",TMX_TAG_LAYER:"layer",TMX_TAG_TILE_LAYER:"tilelayer",TMX_TAG_IMAGE_LAYER:"imagelayer",TMX_TAG_OBJECTGROUP:"objectgroup",TMX_TAG_OBJECT:"object",TMX_TAG_X:"x",TMX_TAG_Y:"y",TMX_TAG_POLYGON:"polygon",
TMX_TAG_POLYLINE:"polyline",TMX_TAG_ELLIPSE:"ellipse",TMX_TAG_POINTS:"points",TMX_BACKGROUND_COLOR:"backgroundcolor",TMX_ROTATION:"rotation"}})();
(function(a){me.TMXUtils=function(){function b(a){if(!a||a.isBoolean())a=a?"true"===a:!0;else if(a.isNumeric())a=Number(a);else if(a.match(/^json:/i)){var b=a.split(/^json:/i)[1];try{a=JSON.parse(b)}catch(e){throw new me.Error("Unable to parse JSON: "+b);}}return a}return{parse:function(a,d){var e={},f="";d=d||1;if(1===a.nodeType&&a.attributes&&0<a.attributes.length)for(var h=0;h<a.attributes.length;h++){var g=a.attributes.item(h);"undefined"!==typeof g.name?e[g.name]=b(g.value):e[g.nodeName]=b(g.nodeValue)}if(a.hasChildNodes()){for(h=
0;h<a.childNodes.length;h++){var g=a.childNodes.item(h),k=g.nodeName;"undefined"===typeof e[k]?3===g.nodeType?(g=g.nodeValue.trim())&&0<g.length&&(f+=g):1===g.nodeType&&(e[k]=me.TMXUtils.parse(g,d),e[k]._draworder=d++):(!1===Array.isArray(e[k])&&(e[k]=[e[k]]),e[k].push(me.TMXUtils.parse(g,d)),e[k][e[k].length-1]._draworder=d++)}0<f.length&&(e.value=f)}return e},applyTMXProperties:function(c,d){var e=d[a.TMX_TAG_PROPERTIES];if("undefined"!==typeof e)if("undefined"!==typeof e.property)e=e.property,
!0===Array.isArray(e)?e.forEach(function(a){c[a.name]=a.value}):c[e.name]=e.value;else for(var f in e)e.hasOwnProperty(f)&&(c[f]=b(e[f]))}}}()})(me.TMXConstants);
(function(a){me.TMXObjectGroup=Object.extend({init:function(b,c,d,e,f){this.name=b;this.width=c[a.TMX_TAG_WIDTH];this.height=c[a.TMX_TAG_HEIGHT];this.z=f;this.objects=[];this.opacity=!0===("undefined"!==typeof c[a.TMX_TAG_VISIBLE]?c[a.TMX_TAG_VISIBLE]:!0)?(+c[a.TMX_TAG_OPACITY]||1).clamp(0,1):0;me.TMXUtils.applyTMXProperties(this,c);b=c.objects||c.object;var h=this;!0===Array.isArray(b)?b.forEach(function(a){h.objects.push(new me.TMXObject(a,d,e,f))}):b&&h.objects.push(new me.TMXObject(b,d,e,f))},
destroy:function(){this.objects=null},getObjectCount:function(){return this.objects.length},getObjectByIndex:function(a){return this.objects[a]}});me.TMXObject=Object.extend({init:function(b,c,d,e){this.points=void 0;this.name=b[a.TMX_TAG_NAME];this.x=+b[a.TMX_TAG_X];this.y=+b[a.TMX_TAG_Y];this.z=+e;this.width=+b[a.TMX_TAG_WIDTH]||0;this.height=+b[a.TMX_TAG_HEIGHT]||0;this.gid=+b[a.TMX_TAG_GID]||null;this.type=b[a.TMX_TAG_TYPE];this.rotation=Number.prototype.degToRad(+(b[a.TMX_ROTATION]||0));this.orientation=
c;this.isPolyLine=this.isPolygon=this.isEllipse=!1;if("number"===typeof this.gid)this.setImage(this.gid,d);else if("undefined"!==typeof b[a.TMX_TAG_ELLIPSE])this.isEllipse=!0;else if(c=b[a.TMX_TAG_POLYGON],"undefined"!==typeof c?this.isPolygon=!0:(c=b[a.TMX_TAG_POLYLINE],"undefined"!==typeof c&&(this.isPolyLine=!0)),"undefined"!==typeof c)if(this.points=[],"undefined"!==typeof c.points)for(c=c.points.split(" "),d=0;d<c.length;d++)e=c[d].split(","),this.points.push(new me.Vector2d(+e[0],+e[1]));else{var f=
this;c.forEach(function(a){f.points.push(new me.Vector2d(+a.x,+a.y))})}me.game.tmxRenderer.adjustPosition(this);me.TMXUtils.applyTMXProperties(this,b)},setImage:function(a,c){var d=c.getTilesetByGid(this.gid);this.width=d.tilewidth;this.height=d.tileheight;this.spritewidth=this.width;var e=new me.Tile(this.x,this.y,d.tilewidth,d.tileheight,this.gid);this.image=d.getTileImage(e);"undefined"===typeof this.name&&(this.name="TileObject")},getTMXShapes:function(){var a=0,c=[];if(!0===this.isEllipse)c.push((new me.Ellipse(this.width/
2,this.height/2,this.width,this.height)).rotate(this.rotation));else if(!0===this.isPolygon)c.push((new me.Polygon(0,0,this.points)).rotate(this.rotation));else if(!0===this.isPolyLine)for(var d=this.points,e,f,h=d.length-1,a=0;a<h;a++)e=d[a],f=d[a+1].clone(),0!==this.rotation&&(e=e.rotate(this.rotation),f=f.rotate(this.rotation)),c.push(new me.Line(0,0,[e,f]));else c.push((new me.Polygon(0,0,[new me.Vector2d,new me.Vector2d(this.width,0),new me.Vector2d(this.width,this.height),new me.Vector2d(0,
this.height)])).rotate(this.rotation));if("isometric"===this.orientation)for(a=0;a<c.length;a++)c[a].rotate(Math.PI/4).scale(Math.SQRT2,Math.SQRT1_2);return c},getObjectPropertyByName:function(a){return this[a]}})})(me.TMXConstants);
(function(a){me.Tile=me.Rect.extend({init:function(a,c,d,e,f){this.transform=this.tileset=null;me.Rect.prototype.init.apply(this,[a*d,c*e,d,e]);this.col=a;this.row=c;this.tileId=f;this.flippedX=0!==(this.tileId&2147483648);this.flippedY=0!==(this.tileId&1073741824);this.flippedAD=0!==(this.tileId&536870912);this.flipped=this.flippedX||this.flippedY||this.flippedAD;!0===this.flipped&&this.createTransform();this.tileId&=536870911},createTransform:function(){null===this.transform&&(this.transform=new me.Matrix2d);
this.transform.identity();var a=this.transform.val;this.flippedAD&&(this.transform.set(0,1,1,0,a[4],a[5]),this.transform.translate(0,this.height-this.width));this.flippedX&&(a[0]*=-1,a[2]*=-1,this.transform.translate(this.flippedAD?this.height:this.width,0));this.flippedY&&(a[1]*=-1,a[3]*=-1,this.transform.translate(0,this.flippedAD?this.width:this.height))}});me.TMXTileset=Object.extend({init:function(b){var c=0;this.TileProperties=[];this.tileXOffset=[];this.tileYOffset=[];this.firstgid=this.lastgid=
+b[a.TMX_TAG_FIRSTGID];var d=b[a.TMX_TAG_SOURCE];if(d&&"tsx"===me.utils.getFileExtension(d).toLowerCase()&&(d=me.utils.getBasename(d),b=me.loader.getTMX(d).tileset,!b))throw new me.Error(d+" TSX tileset not found");this.name=b[a.TMX_TAG_NAME];this.tilewidth=+b[a.TMX_TAG_TILEWIDTH];this.tileheight=+b[a.TMX_TAG_TILEHEIGHT];this.spacing=+b[a.TMX_TAG_SPACING]||0;this.margin=+b[a.TMX_TAG_MARGIN]||0;this.tileoffset=new me.Vector2d(0,0);this.isAnimated=!1;this.animations={};d=b.tiles;if("undefined"!==typeof d)for(c in d)d.hasOwnProperty(c)&&
"animation"in d[c]&&(this.isAnimated=!0,this.animations[+c+this.firstgid]={dt:0,idx:0,frames:d[c].animation,cur:d[c].animation[0]});if(d=b[a.TMX_TAG_TILEOFFSET])this.tileoffset.x=+d[a.TMX_TAG_X],this.tileoffset.y=+d[a.TMX_TAG_Y];if(d=b.tileproperties)for(c in d)d.hasOwnProperty(c)&&this.setTileProperty(c+this.firstgid,d[c]);else if(b[a.TMX_TAG_TILE])for(d=b[a.TMX_TAG_TILE],Array.isArray(d)||(d=[d]),c=0;c<d.length;c++){var e=+d[c][a.TMX_TAG_ID]+this.firstgid,f={};me.TMXUtils.applyTMXProperties(f,d[c]);
this.setTileProperty(e,f);"animation"in d[c]&&(this.isAnimated=!0,this.animations[e]={dt:0,idx:0,frames:d[c].animation.frame,cur:d[c].animation.frame[0]})}c="string"===typeof b[a.TMX_TAG_IMAGE]?b[a.TMX_TAG_IMAGE]:b[a.TMX_TAG_IMAGE].source;(this.image=(c=me.utils.getBasename(c))?me.loader.getImage(c):null)?(this.hTileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing)),this.vTileCount=~~((this.image.height-this.margin)/(this.tileheight+this.spacing)),this.lastgid=this.firstgid+(this.hTileCount*
this.vTileCount-1||0),b=b[a.TMX_TAG_TRANS]||b[a.TMX_TAG_IMAGE][a.TMX_TAG_TRANS],"undefined"!==typeof b&&(this.image=me.video.renderer.applyRGBFilter(this.image,"transparent",b.toUpperCase()).canvas)):console.log("melonJS: '"+c+"' file for tileset '"+this.name+"' not found!")},setTileProperty:function(a,c){this.TileProperties[a]=c},contains:function(a){return a>=this.firstgid&&a<=this.lastgid},getTileImage:function(a){var c=me.CanvasRenderer.getContext2d(me.video.createCanvas(this.tilewidth,this.tileheight));
this.drawTile(c,0,0,a);return c.canvas},getTileProperties:function(a){return this.TileProperties[a]},getTileOffsetX:function(a){var c=this.tileXOffset[a];"undefined"===typeof c&&(c=this.tileXOffset[a]=this.margin+(this.spacing+this.tilewidth)*(a%this.hTileCount));return c},getTileOffsetY:function(a){var c=this.tileYOffset[a];"undefined"===typeof c&&(c=this.tileYOffset[a]=this.margin+(this.spacing+this.tileheight)*~~(a/this.hTileCount));return c},update:function(a){var c=null,d=0,e=!1,f;for(f in this.animations)this.animations.hasOwnProperty(f)&&
(c=this.animations[f],c.dt+=a,d=c.cur.duration,c.dt>=d&&(c.dt-=d,c.idx=(c.idx+1)%c.frames.length,c.cur=c.frames[c.idx],e=!0));return e},drawTile:function(a,c,d,e){var f=e.tileId;if(e.flipped){a.save();var h=e.transform.val;a.transform(h[0],h[1],h[2],h[3],h[4]+c,h[5]+d);c=d=0}f=f in this.animations?this.animations[f].cur.tileid:f-this.firstgid;a.drawImage(this.image,this.getTileOffsetX(f),this.getTileOffsetY(f),this.tilewidth,this.tileheight,c,d,this.tilewidth,this.tileheight);e.flipped&&a.restore()}});
me.TMXTilesetGroup=Object.extend({init:function(){this.tilesets=[]},add:function(a){this.tilesets.push(a)},getTilesetByIndex:function(a){return this.tilesets[a]},getTilesetByGid:function(a){for(var c=-1,d=0,e=this.tilesets.length;d<e;d++){if(this.tilesets[d].contains(a))return this.tilesets[d];this.tilesets[d].firstgid===this.tilesets[d].lastgid&&a>=this.tilesets[d].firstgid&&(c=d)}if(-1!==c)return this.tilesets[c];throw new me.Error("no matching tileset found for gid "+a);}})})(me.TMXConstants);
(function(){me.TMXOrthogonalRenderer=Object.extend({init:function(a,b,c,d){this.cols=a;this.rows=b;this.tilewidth=c;this.tileheight=d},canRender:function(a){return"orthogonal"===a.orientation&&this.cols===a.cols&&this.rows===a.rows&&this.tilewidth===a.tilewidth&&this.tileheight===a.tileheight},pixelToTileCoords:function(a,b){return new me.Vector2d(this.pixelToTileX(a),this.pixelToTileY(b))},pixelToTileX:function(a){return a/this.tilewidth},pixelToTileY:function(a){return a/this.tileheight},tileToPixelCoords:function(a,
b){return new me.Vector2d(a*this.tilewidth,b*this.tileheight)},adjustPosition:function(a){"number"===typeof a.gid&&(a.y-=a.height)},drawTile:function(a,b,c,d,e){e.drawTile(a,e.tileoffset.x+b*this.tilewidth,e.tileoffset.y+(c+1)*this.tileheight-e.tileheight,d)},drawTileLayer:function(a,b,c){var d=this.pixelToTileCoords(c.pos.x,c.pos.y).floorSelf();c=this.pixelToTileCoords(c.pos.x+c.width+this.tilewidth,c.pos.y+c.height+this.tileheight).ceilSelf();c.x=c.x>this.cols?this.cols:c.x;c.y=c.y>this.rows?this.rows:
c.y;for(var e=d.y;e<c.y;e++)for(var f=d.x;f<c.x;f++){var h=b.layerData[f][e];h&&this.drawTile(a,f,e,h,h.tileset)}}});me.TMXIsometricRenderer=Object.extend({init:function(a,b,c,d){this.cols=a;this.rows=b;this.tilewidth=c;this.tileheight=d;this.hTilewidth=c/2;this.hTileheight=d/2;this.originX=this.rows*this.hTilewidth},canRender:function(a){return"isometric"===a.orientation&&this.cols===a.cols&&this.rows===a.rows&&this.tilewidth===a.tilewidth&&this.tileheight===a.tileheight},pixelToTileCoords:function(a,
b){return new me.Vector2d(this.pixelToTileX(a,b),this.pixelToTileY(b,a))},pixelToTileX:function(a,b){return b/this.tileheight+(a-this.originX)/this.tilewidth},pixelToTileY:function(a,b){return a/this.tileheight-(b-this.originX)/this.tilewidth},tileToPixelCoords:function(a,b){return new me.Vector2d((a-b)*this.hTilewidth+this.originX,(a+b)*this.hTileheight)},adjustPosition:function(a){var b=this.tileToPixelCoords(a.x/this.hTilewidth,a.y/this.tileheight);a.x=b.x;a.y=b.y},drawTile:function(a,b,c,d,e){e.drawTile(a,
(this.cols-1)*e.tilewidth+(b-c)*e.tilewidth>>1,-e.tilewidth+(b+c)*e.tileheight>>2,d)},drawTileLayer:function(a,b,c){var d=b.tileset,e=d.tileoffset,f=this.pixelToTileCoords(c.pos.x-d.tilewidth,c.pos.y-d.tileheight).floorSelf(),h=this.pixelToTileCoords(c.pos.x+c.width+d.tilewidth,c.pos.y+c.height+d.tileheight).ceilSelf(),h=this.tileToPixelCoords(h.x,h.y),g=this.tileToPixelCoords(f.x,f.y);g.x-=this.hTilewidth;g.y+=this.tileheight;d=g.y-c.pos.y>this.hTileheight;e=c.pos.x-g.x<this.hTilewidth;d&&(e?(f.x--,
g.x-=this.hTilewidth):(f.y--,g.x+=this.hTilewidth),g.y-=this.hTileheight);c=d^e;for(var k=f.clone(),l=g.y;l-this.tileheight<h.y;l+=this.hTileheight){k.setV(f);for(var m=g.x;m<h.x;m+=this.tilewidth){if(0<=k.x&&0<=k.y&&k.x<this.cols&&k.y<this.rows){var q=b.layerData[k.x][k.y];q&&(d=q.tileset,e=d.tileoffset,d.drawTile(a,e.x+m,e.y+l-d.tileheight,q))}k.x++;k.y--}c?(f.y++,g.x-=this.hTilewidth,c=!1):(f.x++,g.x+=this.hTilewidth,c=!0)}}})})();
(function(a){me.ColorLayer=me.Renderable.extend({init:function(a,c,d){me.Renderable.prototype.init.apply(this,[0,0,Infinity,Infinity]);this.name=a;this.color=c;this.z=d;this.floating=!0},draw:function(a,c){var d=a.globalAlpha();a.setGlobalAlpha(d*this.getOpacity());var e=me.game.viewport.pos,f=a.getColor();a.setColor(this.color);a.fillRect(c.left-e.x,c.top-e.y,c.width,c.height);a.setColor(f);a.setGlobalAlpha(d)}});me.ImageLayer=me.Renderable.extend({init:function(a,c,d,e,f,h){this.name=a;this.image=
e?me.loader.getImage(me.utils.getBasename(e)):null;if(!this.image)throw new me.Error("'"+e+"' file for Image Layer '"+this.name+"' not found!");this.imagewidth=this.image.width;this.imageheight=this.image.height;a=me.game.viewport;c=c?Math.min(a.width,c):a.width;d=d?Math.min(a.height,d):a.height;me.Renderable.prototype.init.apply(this,[0,0,c,d]);this.z=f;this.ratio=new me.Vector2d(1,1);"undefined"!==typeof h&&("number"===typeof h?this.ratio.set(h,h):this.ratio.setV(h));this.lastpos=a.pos.clone();
this.floating=!0;this._repeat="repeat";this.repeatY=this.repeatX=!0;Object.defineProperty(this,"repeat",{get:function(){return this._repeat},set:function(a){this._repeat=a;switch(this._repeat){case "no-repeat":this.repeatY=this.repeatX=!1;break;case "repeat-x":this.repeatX=!0;this.repeatY=!1;break;case "repeat-y":this.repeatX=!1;this.repeatY=!0;break;default:this.repeatY=this.repeatX=!0}}});this.anchorPoint.set(0,0);this.handle=me.event.subscribe(me.event.VIEWPORT_ONCHANGE,this.updateLayer.bind(this))},
updateLayer:function(a){if(0!==this.ratio.x||0!==this.ratio.y)this.repeatX||this.repeatY?(this.pos.x+=(a.x-this.lastpos.x)*this.ratio.x%this.imagewidth,this.pos.x=(this.imagewidth+this.pos.x)%this.imagewidth,this.pos.y+=(a.y-this.lastpos.y)*this.ratio.y%this.imageheight,this.pos.y=(this.imageheight+this.pos.y)%this.imageheight):(this.pos.x+=(a.x-this.lastpos.x)*this.ratio.x,this.pos.y+=(a.y-this.lastpos.y)*this.ratio.y),this.lastpos.setV(a)},draw:function(a,c){var d=me.game.viewport,e=0!==this.anchorPoint.y||
0!==this.anchorPoint.x,f=~~(this.anchorPoint.x*(d.width-this.imagewidth)),d=~~(this.anchorPoint.y*(d.height-this.imageheight));e&&a.translate(f,d);a.setGlobalAlpha(a.globalAlpha()*this.getOpacity());var h,g;if(0===this.ratio.x&&0===this.ratio.y)h=Math.min(c.width,this.imagewidth),g=Math.min(c.height,this.imageheight),a.drawImage(this.image,c.left,c.top,h,g,c.left,c.top,h,g);else{var k=~~this.pos.x,l=~~this.pos.y,m=0,q=0;h=Math.min(this.imagewidth-k,this.width);g=Math.min(this.imageheight-l,this.height);
do{do a.drawImage(this.image,k,l,h,g,m,q,h,g),l=0,q+=g,g=Math.min(this.imageheight,this.height-q);while(this.repeatY&&q<this.height);m+=h;if(!this.repeatX||m>=this.width)break;k=0;h=Math.min(this.imagewidth,this.width-m);l=~~this.pos.y;q=0;g=Math.min(this.imageheight-~~this.pos.y,this.height)}while(1)}e&&a.translate(-f,-d)},destroy:function(){this.handle&&(me.event.unsubscribe(this.handle),this.handle=null);this.lastpos=this.image=null}});me.TMXLayer=me.Renderable.extend({init:function(a,c,d,e,f){me.Renderable.prototype.init.apply(this,
[0,0,0,0]);this.tilewidth=a;this.tileheight=c;this.orientation=d;this.tileset=(this.tilesets=e)?this.tilesets.getTilesetByIndex(0):null;this.animatedTilesets=[];if(this.tilesets)for(a=this.tilesets.tilesets,c=0;c<a.length;c++)a[c].isAnimated&&(a[c].isAnimated=!1,this.animatedTilesets.push(a[c]));if(this.isAnimated=0<this.animatedTilesets.length)this.preRender=!1;this.z=f},initFromJSON:function(b){this.name=b[a.TMX_TAG_NAME];this.cols=+b[a.TMX_TAG_WIDTH];this.rows=+b[a.TMX_TAG_HEIGHT];this.setOpacity(("undefined"!==
typeof b[a.TMX_TAG_VISIBLE]?b[a.TMX_TAG_VISIBLE]:1)?+b[a.TMX_TAG_OPACITY]:0);"isometric"===this.orientation?(this.width=(this.cols+this.rows)*(this.tilewidth/2),this.height=(this.cols+this.rows)*(this.tileheight/2)):(this.width=this.cols*this.tilewidth,this.height=this.rows*this.tileheight);me.TMXUtils.applyTMXProperties(this,b);"undefined"===typeof this.preRender&&(this.preRender=me.sys.preRender);!0===this.preRender&&(this.layerCanvas=me.video.createCanvas(this.cols*this.tilewidth,this.rows*this.tileheight),
this.layerSurface=me.CanvasRenderer.getContext2d(this.layerCanvas));this.initArray(this.cols,this.rows)},destroy:function(){this.preRender&&(this.layerSurface=this.layerCanvas=null);this.animatedTilesets=this.tilesets=this.tileset=this.layerData=this.renderer=null},setRenderer:function(a){this.renderer=a},initArray:function(a,c){this.layerData=[];for(var d=0;d<a;d++){this.layerData[d]=[];for(var e=0;e<c;e++)this.layerData[d][e]=null}},getTileId:function(a,c){var d=this.getTile(a,c);return d?d.tileId:
null},getTile:function(a,c){return this.layerData[~~this.renderer.pixelToTileX(a,c)][~~this.renderer.pixelToTileY(c,a)]},setTile:function(a,c,d){d=new me.Tile(a,c,this.tilewidth,this.tileheight,d);this.tileset.contains(d.tileId)?d.tileset=this.tileset:d.tileset=this.tileset=this.tilesets.getTilesetByGid(d.tileId);return this.layerData[a][c]=d},clearTile:function(a,c){this.layerData[a][c]=null;this.preRender&&this.layerSurface.clearRect(a*this.tilewidth,c*this.tileheight,this.tilewidth,this.tileheight)},
update:function(a){if(this.isAnimated){for(var c=!1,d=0;d<this.animatedTilesets.length;d++)c=this.animatedTilesets[d].update(a)||c;return c}return!1},draw:function(a,c){if(this.preRender){var d=Math.min(c.width,this.width),e=Math.min(c.height,this.height);this.layerSurface.globalAlpha=a.globalAlpha()*this.getOpacity();0<this.layerSurface.globalAlpha&&a.drawImage(this.layerCanvas,c.pos.x,c.pos.y,d,e,c.pos.x,c.pos.y,d,e)}else d=a.globalAlpha(),a.setGlobalAlpha(a.globalAlpha()*this.getOpacity()),0<a.globalAlpha()&&
this.renderer.drawTileLayer(a,this,c),a.setGlobalAlpha(d)}})})(me.TMXConstants);
(function(){me.TMXTileMap=me.Renderable.extend({init:function(a){this.levelId=a;this.z=0;this.name=null;this.tileheight=this.tilewidth=this.rows=this.cols=0;this.tilesets=null;this.mapLayers=[];this.objectGroups=[];this.orientation=this.version="";this.tilesets=null;this.initialized=!1;me.Renderable.prototype.init.apply(this,[0,0,0,0])},setDefaultPosition:function(a,b){if(this.width<a||this.height<b){var c=~~((a-this.width)/2),d=~~((b-this.height)/2);this.pos.set(0<c?c:0,0<d?d:0)}},getObjectGroupByName:function(a){var b=
null;a=a.trim().toLowerCase();for(var c=this.objectGroups.length;c--;)if(this.objectGroups[c].name.toLowerCase().contains(a)){b=this.objectGroups[c];break}return b},getObjectGroups:function(){return this.objectGroups},getLayers:function(){return this.mapLayers},getLayerByName:function(a){var b=null;a=a.trim().toLowerCase();for(var c=this.mapLayers.length;c--;)if(this.mapLayers[c].name.toLowerCase().contains(a)){b=this.mapLayers[c];break}return b},clearTile:function(a,b){for(var c=this.mapLayers.length;c--;)this.mapLayers[c]instanceof
me.TMXLayer&&this.mapLayers[c].clearTile(a,b)},destroy:function(){var a;if(!0===this.initialized){for(a=this.mapLayers.length;a--;)this.mapLayers[a]=null;for(a=this.objectGroups.length;a--;)this.objectGroups[a].destroy(),this.objectGroups[a]=null;this.tilesets=null;this.mapLayers.length=0;this.objectGroups.length=0;this.pos.set(0,0);this.initialized=!1}}})})();
(function(a){me.TMXMapReader=Object.extend({init:function(){},readMap:function(b,c){if(!0!==b.initialized){var d=0,e=this;b.version=c[a.TMX_TAG_VERSION];b.orientation=c[a.TMX_TAG_ORIENTATION];b.cols=+c[a.TMX_TAG_WIDTH];b.rows=+c[a.TMX_TAG_HEIGHT];b.tilewidth=+c[a.TMX_TAG_TILEWIDTH];b.tileheight=+c[a.TMX_TAG_TILEHEIGHT];"isometric"===b.orientation?(b.width=(b.cols+b.rows)*(b.tilewidth/2),b.height=(b.cols+b.rows)*(b.tileheight/2)):(b.width=b.cols*b.tilewidth,b.height=b.rows*b.tileheight);b.backgroundcolor=
c[a.TMX_BACKGROUND_COLOR];b.z=d++;me.TMXUtils.applyTMXProperties(b,c);b.backgroundcolor&&b.mapLayers.push(new me.ColorLayer("background_color",b.backgroundcolor,d++));b.background_image&&b.mapLayers.push(new me.ImageLayer("background_image",b.width,b.height,b.background_image,d++));null!==me.game.tmxRenderer&&me.game.tmxRenderer.canRender(b)||(me.game.tmxRenderer=this.getNewDefaultRenderer(b));b.tilesets||(b.tilesets=new me.TMXTilesetGroup);var f=c.tilesets||c.tileset;!0===Array.isArray(f)?f.forEach(function(a){b.tilesets.add(e.readTileset(a))}):
b.tilesets.add(e.readTileset(f));"undefined"!==typeof c.layers?c.layers.forEach(function(c){switch(c.type){case a.TMX_TAG_IMAGE_LAYER:b.mapLayers.push(e.readImageLayer(b,c,d++));break;case a.TMX_TAG_TILE_LAYER:b.mapLayers.push(e.readLayer(b,c,d++));break;case a.TMX_TAG_OBJECTGROUP:b.objectGroups.push(e.readObjectGroup(b,c,d++))}}):"undefined"!==typeof c.layer&&(f=c.layer,!0===Array.isArray(f)?f.forEach(function(a){b.mapLayers.push(e.readLayer(b,a,a._draworder))}):b.mapLayers.push(e.readLayer(b,f,
f._draworder)),"undefined"!==typeof c[a.TMX_TAG_OBJECTGROUP]&&(f=c[a.TMX_TAG_OBJECTGROUP],!0===Array.isArray(f)?f.forEach(function(a){b.objectGroups.push(e.readObjectGroup(b,a,a._draworder))}):b.objectGroups.push(e.readObjectGroup(b,f,f._draworder))),"undefined"!==typeof c[a.TMX_TAG_IMAGE_LAYER]&&(f=c[a.TMX_TAG_IMAGE_LAYER],!0===Array.isArray(f)?f.forEach(function(a){b.mapLayers.push(e.readImageLayer(b,a,a._draworder))}):b.mapLayers.push(e.readImageLayer(b,f,f._draworder))));b.initialized=!0}},getNewDefaultRenderer:function(a){switch(a.orientation){case "orthogonal":return new me.TMXOrthogonalRenderer(a.cols,
a.rows,a.tilewidth,a.tileheight);case "isometric":return new me.TMXIsometricRenderer(a.cols,a.rows,a.tilewidth,a.tileheight);default:throw new me.Error(a.orientation+" type TMX Tile Map not supported!");}},setLayerData:function(b,c,d,e){var f=!0===Array.isArray(c)?c:c.value;switch(d){case "json":f=c;break;case a.TMX_TAG_CSV:case a.TMX_TAG_ATTR_BASE64:d===a.TMX_TAG_CSV?f=me.utils.decodeCSV(f,b.cols):(f=me.utils.decodeBase64AsArray(f,4),null!==e&&(f=me.utils.decompress(f,e)));break;default:throw new me.Error("TMX Tile Map "+
d+" encoding not supported!");}for(e=c=0;e<b.rows;e++)for(var h=0;h<b.cols;h++){var g=null==d?this.TMXParser.getIntAttribute(f[c++],a.TMX_TAG_GID):f[c++];0!==g&&(g=b.setTile(h,e,g),b.preRender&&b.renderer.drawTile(b.layerSurface,h,e,g,g.tileset))}},readLayer:function(b,c,d){b=new me.TMXLayer(b.tilewidth,b.tileheight,b.orientation,b.tilesets,d);b.initFromJSON(c);me.game.tmxRenderer.canRender(b)?b.setRenderer(me.game.tmxRenderer):b.setRenderer(me.mapReader.getNewDefaultRenderer(b));d=Array.isArray(c[a.TMX_TAG_DATA])?
c[a.TMX_TAG_ENCODING]:c[a.TMX_TAG_DATA][a.TMX_TAG_ENCODING];this.setLayerData(b,c[a.TMX_TAG_DATA],d||"json",null);return b},readImageLayer:function(b,c,d){b=new me.ImageLayer(c[a.TMX_TAG_NAME],+c[a.TMX_TAG_WIDTH]*b.tilewidth,+c[a.TMX_TAG_HEIGHT]*b.tileheight,"string"!==typeof c[a.TMX_TAG_IMAGE]?c[a.TMX_TAG_IMAGE].source:c[a.TMX_TAG_IMAGE],d);b.setOpacity(!0===("undefined"!==typeof c[a.TMX_TAG_VISIBLE]?c[a.TMX_TAG_VISIBLE]:!0)?(+c[a.TMX_TAG_OPACITY]||1).clamp(0,1):0);me.TMXUtils.applyTMXProperties(b,
c);"number"===typeof b.ratio&&(c=b.ratio,b.ratio=new me.Vector2d(c,c));return b},readTileset:function(a){return new me.TMXTileset(a)},readObjectGroup:function(b,c,d){return new me.TMXObjectGroup(c[a.TMX_TAG_NAME],c,b.orientation,b.tilesets,d)}})})(me.TMXConstants);
(function(){me.levelDirector=function(){var a={},b={},c=[],d=0;a.reset=function(){};a.addLevel=function(){throw new me.Error("no level loader defined");};a.addTMXLevel=function(a,d){if(null==b[a])b[a]=new me.TMXTileMap(a),b[a].name=a,c.push(a);else return!1;d&&d();return!0};a.loadLevel=function(e){e=e.toString().toLowerCase();if("undefined"===typeof b[e])throw new me.Error("level "+e+" not found");if(b[e]instanceof me.TMXTileMap){var f=me.state.isRunning();f&&me.state.stop();me.game.reset();me.utils.resetGUID(e);
b[a.getCurrentLevelId()]&&b[a.getCurrentLevelId()].destroy();me.mapReader.readMap(b[e],me.loader.getTMX(e));d=c.indexOf(e);e=b[e];var h=me.game.world;h.autoSort=!1;me.game.currentLevel=e;me.game.viewport.setBounds(0,0,Math.max(e.width,me.game.viewport.width),Math.max(e.height,me.game.viewport.height));e.setDefaultPosition(me.game.viewport.width,me.game.viewport.height);for(var g=e.getLayers(),k=g.length;k--;)h.addChild(g[k]);for(var g=h,k=!1,l=e.getObjectGroups(),m=0;m<l.length;m++){var q=l[m],k=
q.name.toLowerCase().contains(me.TMXConstants.COLLISION_GROUP);!1===me.game.mergeGroup&&(g=new me.Container,g.name=q.name,g.z=q.z,g.setOpacity(q.opacity),g.autoSort=!1);for(var r=0;r<q.objects.length;r++){var n=q.objects[r];!1===k?n=me.pool.pull(n.name,n.x,n.y,"TileObject"===n.name?n.image:n):(n=me.pool.pull("me.Entity",n.x,n.y,n),n.body.collisionType=me.collision.types.WORLD_SHAPE);n&&(n.z=q.z,!0===me.game.mergeGroup&&!0===n.isRenderable&&(n.setOpacity(n.getOpacity()*q.opacity),n.renderable instanceof
me.Renderable&&n.renderable.setOpacity(n.renderable.getOpacity()*q.opacity)),g.addChild(n))}!1===me.game.mergeGroup&&(h.addChild(g),g.autoSort=!0)}h.sort(!0);h.autoSort=!0;me.game.world.transform.translateV(me.game.currentLevel.pos);me.game.world.resize(me.game.currentLevel.width,me.game.currentLevel.height);me.game.onLevelLoaded&&me.game.onLevelLoaded.call(me.game.onLevelLoaded,e.name);me.event.publish(me.event.LEVEL_LOADED,[e.name]);f&&me.state.restart.defer(this)}else throw new me.Error("no level loader defined");
return!0};a.getCurrentLevelId=function(){return c[d]};a.reloadLevel=function(){return a.loadLevel(a.getCurrentLevelId())};a.nextLevel=function(){return d+1<c.length?a.loadLevel(c[d+1]):!1};a.previousLevel=function(){return 0<=d-1?a.loadLevel(c[d-1]):!1};a.levelCount=function(){return c.length};return a}()})();
(function(){me.Tween=function(a){var b=a,c={},d={},e={},f=1E3,h=0,g=!1,k=0,l=null,m=me.Tween.Easing.Linear.None,q=me.Tween.Interpolation.Linear,r=[],n=null,v=!1,p=null,s=null,t;for(t in a)"object"!==typeof a&&(c[t]=parseFloat(a[t],10));this.onResetEvent=function(a){b=a;c={};d={};e={};m=me.Tween.Easing.Linear.None;q=me.Tween.Interpolation.Linear;g=!1;f=1E3;k=0;n=null;v=!1;s=p=null};this.to=function(a,b){void 0!==b&&(f=b);d=a;return this};this.start=function(a){v=!1;me.game.world.addChild(this);l=("undefined"===
typeof a?me.timer.getTime():a)+k;for(var f in d){if(d[f]instanceof Array){if(0===d[f].length)continue;d[f]=[b[f]].concat(d[f])}c[f]=b[f];!1===c[f]instanceof Array&&(c[f]*=1);e[f]=c[f]||0}return this};this.stop=function(){me.game.world.hasChild(this)&&me.game.world.removeChildNow(this);return this};this.delay=function(a){k=a;return this};me.event.subscribe(me.event.STATE_RESUME,function(a){l&&(l+=a)});this.repeat=function(a){h=a;return this};this.yoyo=function(a){g=a;return this};this.easing=function(a){if("function"!==
typeof a)throw new me.Tween.Error("invalid easing function for me.Tween.easing()");m=a;return this};this.interpolation=function(a){q=a;return this};this.chain=function(){r=arguments;return this};this.onStart=function(a){n=a;return this};this.onUpdate=function(a){p=a;return this};this.onComplete=function(a){s=a;return this};this.update=function(a){a=me.timer.getTime();var t;if(a<l)return!0;!1===v&&(null!==n&&n.call(b),v=!0);var x=(a-l)/f,x=1<x?1:x,z=m(x);for(t in d){var u=c[t]||0,y=d[t];y instanceof
Array?b[t]=q(y,z):("string"===typeof y&&(y=u+parseFloat(y,10)),"number"===typeof y&&(b[t]=u+(y-u)*z))}null!==p&&p.call(b,z);if(1===x)if(0<h){isFinite(h)&&h--;for(t in e)"string"===typeof d[t]&&(e[t]+=parseFloat(d[t],10)),g&&(x=e[t],e[t]=d[t],d[t]=x),c[t]=e[t];l=a+k}else{me.game.world.removeChildNow(this);null!==s&&s.call(b);t=0;for(x=r.length;t<x;t++)r[t].start(a);return!1}return!0}};me.Tween.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*
(2-a)},InOut:function(a){return 1>(a*=2)?0.5*a*a:-0.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a:-0.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)}},
Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return 0.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?0.5*Math.pow(1024,a-1):0.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>
(a*=2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){var b,c=0.1;if(0===a)return 0;if(1===a)return 1;!c||1>c?(c=1,b=0.1):b=0.4*Math.asin(1/c)/(2*Math.PI);return-(c*Math.pow(2,10*(a-=1))*Math.sin(2*(a-b)*Math.PI/0.4))},Out:function(a){var b,c=0.1;if(0===a)return 0;if(1===a)return 1;!c||1>c?(c=1,b=0.1):b=0.4*Math.asin(1/c)/(2*Math.PI);return c*Math.pow(2,-10*a)*Math.sin(2*(a-b)*Math.PI/0.4)+1},InOut:function(a){var b,c=0.1;if(0===a)return 0;if(1===a)return 1;!c||
1>c?(c=1,b=0.1):b=0.4*Math.asin(1/c)/(2*Math.PI);return 1>(a*=2)?-0.5*c*Math.pow(2,10*(a-=1))*Math.sin(2*(a-b)*Math.PI/0.4):0.5*c*Math.pow(2,-10*(a-=1))*Math.sin(2*(a-b)*Math.PI/0.4)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?0.5*a*a*(3.5949095*a-2.5949095):0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-me.Tween.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*
a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},InOut:function(a){return 0.5>a?0.5*me.Tween.Easing.Bounce.In(2*a):0.5*me.Tween.Easing.Bounce.Out(2*a-1)+0.5}}};me.Tween.Interpolation={Linear:function(a,b){var c=a.length-1,d=c*b,e=Math.floor(d),f=me.Tween.Interpolation.Utils.Linear;return 0>b?f(a[0],a[1],d):1<b?f(a[c],a[c-1],c-d):f(a[e],a[e+1>c?c:e+1],d-e)},Bezier:function(a,b){var c=0,d=a.length-1,e=Math.pow,f=me.Tween.Interpolation.Utils.Bernstein,
h;for(h=0;h<=d;h++)c+=e(1-b,d-h)*e(b,h)*a[h]*f(d,h);return c},CatmullRom:function(a,b){var c=a.length-1,d=c*b,e=Math.floor(d),f=me.Tween.Interpolation.Utils.CatmullRom;return a[0]===a[c]?(0>b&&(e=Math.floor(d=c*(1+b))),f(a[(e-1+c)%c],a[e],a[(e+1)%c],a[(e+2)%c],d-e)):0>b?a[0]-(f(a[0],a[0],a[1],a[1],-d)-a[0]):1<b?a[c]-(f(a[c],a[c],a[c-1],a[c-1],d-c)-a[c]):f(a[e?e-1:0],a[e],a[c<e+1?c:e+1],a[c<e+2?c:e+2],d-e)},Utils:{Linear:function(a,b,c){return(b-a)*c+a},Bernstein:function(a,b){var c=me.Tween.Interpolation.Utils.Factorial;
return c(a)/c(b)/c(a-b)},Factorial:function(){var a=[1];return function(b){var c=1,d;if(a[b])return a[b];for(d=b;1<d;d--)c*=d;return a[b]=c}}(),CatmullRom:function(a,b,c,d,e){a=0.5*(c-a);d=0.5*(d-b);var f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b}}};me.Tween.Error=me.Error.extend({init:function(a){me.Error.prototype.init.apply(this,[a]);this.name="me.Tween.Error"}})})();
(function(){me.event=function(){var a={},b={};a.STATE_PAUSE="me.state.onPause";a.STATE_RESUME="me.state.onResume";a.STATE_STOP="me.state.onStop";a.STATE_RESTART="me.state.onRestart";a.GAME_INIT="me.game.onInit";a.LEVEL_LOADED="me.game.onLevelLoaded";a.LOADER_COMPLETE="me.loader.onload";a.LOADER_PROGRESS="me.loader.onProgress";a.KEYDOWN="me.input.keydown";a.KEYUP="me.input.keyup";a.MOUSEMOVE="me.game.pointermove";a.DRAGSTART="me.game.dragstart";a.DRAGEND="me.game.dragend";a.WINDOW_ONRESIZE="window.onresize";
a.WINDOW_ONORIENTATION_CHANGE="window.orientationchange";a.WINDOW_ONSCROLL="window.onscroll";a.VIEWPORT_ONCHANGE="viewport.onchange";a.publish=function(a,d){for(var e=b[a],f=e?e.length:0;f--;)e[f].apply(window,d||[])};a.subscribe=function(a,d){b[a]||(b[a]=[]);b[a].push(d);return[a,d]};a.unsubscribe=function(a,d){var e=b[d?a:a[0]],f=e?e.length:0;for(d=d||a[1];f--;)e[f]===d&&e.splice(f,1)};return a}()})();
(function(){var a=null,b=!0,c=!1;try{"undefined"!==typeof AudioContext?a=new AudioContext:"undefined"!==typeof webkitAudioContext?a=new webkitAudioContext:b=!1}catch(d){b=!1}if(!b)if("undefined"!==typeof Audio)try{new Audio}catch(e){c=!0}else c=!0;if(b){var f="undefined"===typeof a.createGain?a.createGainNode():a.createGain();f.gain.value=1;f.connect(a.destination)}var h=function(){this.init()};h.prototype={init:function(){var d=this||g;d._codecs={};d._howls=[];d._muted=!1;d._volume=1;d.iOSAutoEnable=
!0;d.noAudio=c;d.usingWebAudio=b;d.ctx=a;c||d._setupCodecs();return d},volume:function(a){var c=this||g;a=parseFloat(a);if("undefined"!==typeof a&&0<=a&&1>=a){c._volume=a;b&&(f.gain.value=a);for(var d=0;d<c._howls.length;d++)if(!c._howls[d]._webAudio)for(var e=c._howls[d]._getSoundIds(),h=0;h<e.length;h++){var k=c._howls[d]._soundById(e[h]);k&&k._node&&(k._node.volume=k._volume*a)}return c}return c._volume},mute:function(a){var c=this||g;c._muted=a;b&&(f.gain.value=a?0:c._volume);for(var d=0;d<c._howls.length;d++)if(!c._howls[d]._webAudio)for(var e=
c._howls[d]._getSoundIds(),h=0;h<e.length;h++){var k=c._howls[d]._soundById(e[h]);k&&k._node&&(k._node.muted=a?!0:k._muted)}return c},codecs:function(a){return(this||g)._codecs[a]},_setupCodecs:function(){var a=this||g,b=new Audio;a._codecs={mp3:!!b.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!b.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!b.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!b.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!b.canPlayType("audio/aac;").replace(/^no$/,
""),m4a:!!(b.canPlayType("audio/x-m4a;")||b.canPlayType("audio/m4a;")||b.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(b.canPlayType("audio/x-mp4;")||b.canPlayType("audio/mp4;")||b.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!b.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!b.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")};return a},_enableiOSAudio:function(){var b=this||g;if(!a||!b._iOSEnabled&&/iPhone|iPad|iPod/i.test(navigator.userAgent)){b._iOSEnabled=
!1;var c=function(){var d=a.createBuffer(1,1,22050),e=a.createBufferSource();e.buffer=d;e.connect(a.destination);"undefined"===typeof e.start?e.noteOn(0):e.start(0);setTimeout(function(){if(e.playbackState===e.PLAYING_STATE||e.playbackState===e.FINISHED_STATE)b._iOSEnabled=!0,b.iOSAutoEnable=!1,window.removeEventListener("touchstart",c,!1)},0)};window.addEventListener("touchstart",c,!1);return b}}};var g=new h,k=function(a){a.src?this.init(a):console.error("An array of source files must be passed with any new Howl.")};
k.prototype={init:function(c){this._autoplay=c.autoplay||!1;this._ext=c.ext||null;this._html5=c.html5||!1;this._muted=c.mute||!1;this._loop=c.loop||!1;this._pool=c.pool||5;this._preload="boolean"===typeof c.preload?c.preload:!0;this._rate=c.rate||1;this._sprite=c.sprite||{};this._src="string"!==typeof c.src?c.src:[c.src];this._volume=void 0!==c.volume?c.volume:1;this._duration=0;this._loaded=!1;this._sounds=[];this._endTimers={};this._onend=c.onend?[{fn:c.onend}]:[];this._onfaded=c.onfaded?[{fn:c.onfaded}]:
[];this._onload=c.onload?[{fn:c.onload}]:[];this._onloaderror=c.onloaderror?[{fn:c.onloaderror}]:[];this._onpause=c.onpause?[{fn:c.onpause}]:[];this._onplay=c.onplay?[{fn:c.onplay}]:[];this._webAudio=b&&!this._html5;"undefined"!==typeof a&&a&&g.iOSAutoEnable&&g._enableiOSAudio();g._howls.push(this);this._preload&&this.load();return this},load:function(){var a=null;if(!c){"string"===typeof this._src&&(this._src=[this._src]);for(var b=0;b<this._src.length;b++){var d,e;this._ext&&this._ext[b]?d=this._ext[b]:
(e=this._src[b],(d=/^data:audio\/([^;,]+);/i.exec(e))||(d=/\.([^.]+)$/.exec(e.split("?",1)[0])),d&&(d=d[1].toLowerCase()));if(g.codecs(d)){a=this._src[b];break}}if(a)return this._src=a,new l(this),this._webAudio&&q(this),this}this._emit("loaderror")},play:function(b){var c=this,d=null;if("number"===typeof b)d=b,b=null;else if("undefined"===typeof b){b="__default";for(var e=0,f=0;f<c._sounds.length;f++)c._sounds[f]._paused&&!c._sounds[f]._ended&&(e++,d=c._sounds[f]._id);1===e?b=null:d=null}var h=d?
c._soundById(d):c._inactiveSound();d&&!b&&(b=h._sprite||"__default");if(!h)return null;if(!c._loaded&&!c._sprite[b])return c.once("load",function(){c.play(c._soundById(h._id)?h._id:void 0)}),h._id;if(d&&!h._paused)return h._id;var k=0<h._seek?h._seek:c._sprite[b][0]/1E3,l=(c._sprite[b][0]+c._sprite[b][1])/1E3-k,m=function(){var d=!(!h._loop&&!c._sprite[b][2]);c._emit("end",h._id);!c._webAudio&&d&&c.stop(h._id).play(h._id);c._webAudio&&d&&(c._emit("play",h._id),h._seek=h._start||0,h._playStart=a.currentTime,
c._endTimers[h._id]=setTimeout(m,1E3*(h._stop-h._start)/Math.abs(c._rate)));c._webAudio&&!d&&(h._paused=!0,h._ended=!0,h._seek=h._start||0,c._clearTimer(h._id),h._node.bufferSource=null);c._webAudio||d||c.stop(h._id)};c._endTimers[h._id]=setTimeout(m,1E3*l/Math.abs(c._rate));h._paused=!1;h._ended=!1;h._sprite=b;h._seek=k;h._start=c._sprite[b][0]/1E3;h._stop=(c._sprite[b][0]+c._sprite[b][1])/1E3;h._loop=!(!h._loop&&!c._sprite[b][2]);var n=h._node;if(c._webAudio)d=function(){c._refreshBuffer(h);var b=
h._muted||c._muted?0:h._volume*g.volume();n.gain.setValueAtTime(b,a.currentTime);h._playStart=a.currentTime;"undefined"===typeof n.bufferSource.start?n.bufferSource.noteGrainOn(0,k,l):n.bufferSource.start(0,k,l);c._endTimers[h._id]||(c._endTimers[h._id]=setTimeout(m,1E3*l/Math.abs(c._rate)));setTimeout(function(){c._emit("play",h._id)},0)},c._loaded?d():(c.once("load",d),c._clearTimer(h._id));else{var q=function(){n.currentTime=k;n.muted=h._muted||c._muted||g._muted||n.muted;n.volume=h._volume*g.volume();
n.playbackRate=c._rate;setTimeout(function(){n.play();c._emit("play",h._id)},0)};if(4===n.readyState||!n.readyState&&navigator.isCocoonJS)q();else{var r=function(){c._endTimers[h._id]=setTimeout(m,1E3*l/Math.abs(c._rate));q();n.removeEventListener("canplaythrough",r,!1)};n.addEventListener("canplaythrough",r,!1);c._clearTimer(h._id)}}return h._id},pause:function(a,b){var c=this;if(!c._loaded)return c.once("play",function(){c.pause(a)}),c;for(var d=c._getSoundIds(a),e=0;e<d.length;e++){c._clearTimer(d[e]);
var f=c._soundById(d[e]);if(f&&!f._paused){f._seek=c.seek(d[e]);f._paused=!0;if(c._webAudio){if(!f._node.bufferSource)break;"undefined"===typeof f._node.bufferSource.stop?f._node.bufferSource.noteOff(0):f._node.bufferSource.stop(0);f._node.bufferSource=null}else isNaN(f._node.duration)||f._node.pause();b||c._emit("pause",f._id)}}return c},stop:function(a){var b=this;if(!b._loaded){if("undefined"!==typeof b._sounds[0]._sprite)b.once("play",function(){b.stop(a)});return b}for(var c=b._getSoundIds(a),
d=0;d<c.length;d++){b._clearTimer(c[d]);var e=b._soundById(c[d]);if(e&&!e._paused)if(e._seek=e._start||0,e._paused=!0,e._ended=!0,b._webAudio){if(!e._node.bufferSource)break;"undefined"===typeof e._node.bufferSource.stop?e._node.bufferSource.noteOff(0):e._node.bufferSource.stop(0);e._node.bufferSource=null}else isNaN(e._node.duration)||(e._node.pause(),e._node.currentTime=e._start||0)}return b},mute:function(b,c){var d=this;if(!d._loaded)return d.once("play",function(){d.mute(b,c)}),d;if("undefined"===
typeof c)if("boolean"===typeof b)d._muted=b;else return d._muted;for(var e=d._getSoundIds(c),f=0;f<e.length;f++){var h=d._soundById(e[f]);h&&(h._muted=b,d._webAudio&&h._node?h._node.gain.setValueAtTime(b?0:h._volume*g.volume(),a.currentTime):h._node&&(h._node.muted=g._muted?!0:b))}return d},volume:function(){var b=this,c=arguments,d,e;if(0===c.length)return b._volume;1===c.length?0<=b._getSoundIds().indexOf(c[0])?e=parseInt(c[0],10):d=parseFloat(c[0]):2===c.length&&(d=parseFloat(c[0]),e=parseInt(c[1],
10));var f;if("undefined"!==typeof d&&0<=d&&1>=d){if(!b._loaded)return b.once("play",function(){b.volume.apply(b,c)}),b;"undefined"===typeof e&&(b._volume=d);e=b._getSoundIds(e);for(var h=0;h<e.length;h++)if(f=b._soundById(e[h]))f._volume=d,b._webAudio&&f._node?f._node.gain.setValueAtTime(d*g.volume(),a.currentTime):f._node&&(f._node.volume=d*g.volume())}else return(f=e?b._soundById(e):b._sounds[0])?f._volume:0;return b},fade:function(b,c,d,e){var f=this;if(!f._loaded)return f.once("play",function(){f.fade(b,
c,d,e)}),f;f.volume(b,e);for(var g=f._getSoundIds(e),h=0;h<g.length;h++){var k=f._soundById(g[h]);if(k)if(f._webAudio){var l=a.currentTime,m=l+d/1E3;k._volume=b;k._node.gain.setValueAtTime(b,l);k._node.gain.linearRampToValueAtTime(c,m);setTimeout(function(b,d){setTimeout(function(){d._volume=c;f._emit("faded",b)},0<m-a.currentTime?Math.ceil(1E3*(m-a.currentTime)):0)}.bind(f,g[h],k),d)}else{var k=Math.abs(b-c),n=b>c?"out":"in",q=d/(k/0.01);(function(){var a=b,d=setInterval(function(b){a+="in"===n?
0.01:-0.01;a=Math.max(0,a);a=Math.min(1,a);a=Math.round(100*a)/100;f.volume(a,b);a===c&&(clearInterval(d),f._emit("faded",b))}.bind(f,g[h]),q)})()}}return f},loop:function(){var a=arguments,b,c;if(0===a.length)return this._loop;if(1===a.length)if("boolean"===typeof a[0])this._loop=b=a[0];else return(a=this._soundById(parseInt(a[0],10)))?a._loop:!1;else 2===a.length&&(b=a[0],c=parseInt(a[1],10));c=this._getSoundIds(c);for(var d=0;d<c.length;d++)if(a=this._soundById(c[d]))a._loop=b,this._webAudio&&
a._node&&(a._node.bufferSource.loop=b);return this},seek:function(){var b=this,c=arguments,d,e;0===c.length?e=b._sounds[0]._id:1===c.length?0<=b._getSoundIds().indexOf(c[0])?e=parseInt(c[0],10):(e=b._sounds[0]._id,d=parseFloat(c[0])):2===c.length&&(d=parseFloat(c[0]),e=parseInt(c[1],10));if("undefined"===typeof e)return b;if(!b._loaded)return b.once("load",function(){b.seek.apply(b,c)}),b;var f=b._soundById(e);if(f)if(0<=d){var g=b.playing(e);g&&b.pause(e,!0);f._seek=d;b._clearTimer(e);g&&b.play(e)}else return b._webAudio?
f._seek+(a.currentTime-f._playStart):f._node.currentTime;return b},playing:function(a){return(a=this._soundById(a)||this._sounds[0])?!a._paused:!1},duration:function(){return this._duration},unload:function(){for(var a=this._sounds,b=0;b<a.length;b++){a[b]._paused||(this.stop(a[b]._id),this._emit("end",a[b]._id));this._webAudio||(a[b]._node.src="",a[b]._node.removeEventListener("error",a[b]._errorFn,!1),a[b]._node.removeEventListener("canplaythrough",a[b]._loadFn,!1));delete a[b]._node;this._clearTimer(a[b]._id);
var c=g._howls.indexOf(this);0<=c&&g._howls.splice(c,1)}m&&delete m[this._src];return null},on:function(a,b,c){a=this["_on"+a];"function"===typeof b&&a.push({id:c,fn:b});return this},off:function(a,b,c){a=this["_on"+a];if(b)for(var d=0;d<a.length;d++)if(b===a[d].fn&&c===a[d].id){a.splice(d,1);break}return this},once:function(a,b,c){var d=this,e=function(){b.apply(d,arguments);d.off(a,e,c)};d.on(a,e,c);return d},_emit:function(a,b,c){a=this["_on"+a];for(var d=0;d<a.length;d++)a[d].id&&a[d].id!==b||
setTimeout(function(a){a.call(this,b,c)}.bind(this,a[d].fn),0);return this},_clearTimer:function(a){this._endTimers[a]&&(clearTimeout(this._endTimers[a]),delete this._endTimers[a]);return this},_soundById:function(a){for(var b=0;b<this._sounds.length;b++)if(a===this._sounds[b]._id)return this._sounds[b];return null},_inactiveSound:function(){this._drain();for(var a=0;a<this._sounds.length;a++)if(this._sounds[a]._ended)return this._sounds[a].reset();return new l(this)},_drain:function(){var a=this._pool,
b=0,c=0;if(!(this._sounds.length<a)){for(c=0;c<this._sounds.length;c++)this._sounds[c]._ended&&b++;for(c=this._sounds.length-1;0<=c&&!(b<=a);c--)this._sounds[c]._ended&&(this._webAudio&&this._sounds[c]._node&&this._sounds[c]._node.disconnect(0),this._sounds.splice(c,1),b--)}},_getSoundIds:function(a){if("undefined"===typeof a){a=[];for(var b=0;b<this._sounds.length;b++)a.push(this._sounds[b]._id);return a}return[a]},_refreshBuffer:function(b){b._node.bufferSource=a.createBufferSource();b._node.bufferSource.buffer=
m[this._src];b._panner?b._node.bufferSource.connect(b._panner):b._node.bufferSource.connect(b._node);if(b._node.bufferSource.loop=b._loop)b._node.bufferSource.loopStart=b._start||0,b._node.bufferSource.loopEnd=b._stop;b._node.bufferSource.playbackRate.value=this._rate;return this}};var l=function(a){this._parent=a;this.init()};l.prototype={init:function(){var a=this._parent;this._muted=a._muted;this._loop=a._loop;this._volume=a._volume;this._muted=a._muted;this._seek=0;this._ended=this._paused=!0;
this._id=Math.round(Date.now()*Math.random());a._sounds.push(this);this.create();return this},create:function(){var b=this._parent,c=g._muted||this._muted||this._parent._muted?0:this._volume*g.volume();b._webAudio?(this._node="undefined"===typeof a.createGain?a.createGainNode():a.createGain(),this._node.gain.setValueAtTime(c,a.currentTime),this._node.paused=!0,this._node.connect(f)):(this._node=new Audio,this._errorFn=this._errorListener.bind(this),this._node.addEventListener("error",this._errorFn,
!1),this._loadFn=this._loadListener.bind(this),this._node.addEventListener("canplaythrough",this._loadFn,!1),this._node.src=b._src,this._node.preload="auto",this._node.volume=c,this._node.load());return this},reset:function(){var a=this._parent;this._muted=a._muted;this._loop=a._loop;this._volume=a._volume;this._muted=a._muted;this._seek=0;this._ended=this._paused=!0;this._sprite=null;this._id=Math.round(Date.now()*Math.random());return this},_errorListener:function(){this._node.error&&4===this._node.error.code&&
(g.noAudio=!0);this._parent._emit("loaderror",this._id,this._node.error?this._node.error.code:0);this._node.removeEventListener("error",this._errorListener,!1)},_loadListener:function(){var a=this._parent;a._duration=Math.ceil(10*this._node.duration)/10;0===Object.keys(a._sprite).length&&(a._sprite={__default:[0,1E3*a._duration]});a._loaded||(a._loaded=!0,a._emit("load"));a._autoplay&&a.play();this._node.removeEventListener("canplaythrough",this._loadListener,!1)}};if(b)var m={},q=function(a){var b=
a._src;if(m[b])a._duration=m[b].duration,v(a);else if(/^data:[^;]+;base64,/.test(b)){for(var c=atob(b.split(",")[1]),d=new Uint8Array(c.length),e=0;e<c.length;++e)d[e]=c.charCodeAt(e);n(d.buffer,a)}else{var f=new XMLHttpRequest;f.open("GET",b,!0);f.responseType="arraybuffer";f.onload=function(){n(f.response,a)};f.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete m[b],a.load())};r(f)}},r=function(a){try{a.send()}catch(b){a.onerror()}},n=function(b,c){a.decodeAudioData(b,
function(a){a&&(m[c._src]=a,v(c,a))},function(){c._emit("loaderror")})},v=function(a,b){b&&!a._duration&&(a._duration=b.duration);0===Object.keys(a._sprite).length&&(a._sprite={__default:[0,1E3*a._duration]});a._loaded||(a._loaded=!0,a._emit("load"));a._autoplay&&a.play()};"function"===typeof define&&define.amd&&define("howler",function(){return{Howler:g,Howl:k}});"undefined"!==typeof exports&&(exports.Howler=g,exports.Howl=k);"undefined"!==typeof window&&(window.HowlerGlobal=h,window.Howler=g,window.Howl=
k,window.Sound=l)})();
(function(){me.plugin=function(){var a={};a.Base=Object.extend({init:function(){this.version="2.0.2"}});a.patch=function(a,c,d){"undefined"!==typeof a.prototype&&(a=a.prototype);if("function"===typeof a[c]){var e=a[c];Object.defineProperty(a,c,{configurable:!0,value:function(a,b){return function(){this._patched=e;var a=b.apply(this,arguments);this._patched=null;return a}}(c,d)})}else console.error(c+" is not an existing function")};a.register=function(a,c){me.plugin[c]&&console.error("plugin "+c+
" already registered");var d=[];2<arguments.length&&(d=Array.prototype.slice.call(arguments,1));d[0]=a;me.plugin[c]=new (a.bind.apply(a,d));if(!(me.plugin[c]&&me.plugin[c]instanceof me.plugin.Base))throw new me.Error("Plugin should extend the me.plugin.Base Class !");if(0<me.sys.checkVersion(me.plugin[c].version))throw new me.Error("Plugin version mismatch, expected: "+me.plugin[c].version+", got: "+me.version);};return a}()})();
me.DraggableEntity=function(a,b,c,d){return a.extend({init:function(c,f,h){a.prototype.init.apply(this,[c,f,h]);this.dragging=!1;this.dragId=null;this.grabOffset=new d(0,0);this.onPointerEvent=b.registerPointerEvent;this.removePointerEvent=b.releasePointerEvent;this.initEvents()},initEvents:function(){var a=this;this.mouseDown=function(a){this.translatePointerEvent(a,c.DRAGSTART)};this.mouseUp=function(a){this.translatePointerEvent(a,c.DRAGEND)};this.onPointerEvent("pointerdown",this,this.mouseDown.bind(this));
this.onPointerEvent("pointerup",this,this.mouseUp.bind(this));c.subscribe(c.MOUSEMOVE,this.dragMove.bind(this));c.subscribe(c.DRAGSTART,function(b,c){c===a&&a.dragStart(b)});c.subscribe(c.DRAGEND,function(b,c){c===a&&a.dragEnd(b)})},translatePointerEvent:function(a,b){c.publish(b,[a,this])},dragStart:function(a){if(!1===this.dragging)return this.dragging=!0,this.dragId=a.pointerId,this.grabOffset.set(a.gameX,a.gameY),this.grabOffset.sub(this.pos),!1},dragMove:function(a){!0===this.dragging&&this.dragId===
a.pointerId&&(this.pos.set(a.gameX,a.gameY),this.pos.sub(this.grabOffset))},dragEnd:function(){if(!0===this.dragging)return this.pointerId=void 0,this.dragging=!1},destroy:function(){c.unsubscribe(c.MOUSEMOVE,this.dragMove);c.unsubscribe(c.DRAGSTART,this.dragStart);c.unsubscribe(c.DRAGEND,this.dragEnd);this.removePointerEvent("pointerdown",this);this.removePointerEvent("pointerup",this)}})}(me.Entity,me.input,me.event,me.Vector2d);
me.DroptargetEntity=function(a,b){return a.extend({init:function(c,d,e){this.CHECKMETHOD_OVERLAP="overlaps";this.CHECKMETHOD_CONTAINS="contains";this.checkMethod=null;a.prototype.init.apply(this,[c,d,e]);b.subscribe(b.DRAGEND,this.checkOnMe.bind(this));this.checkMethod=this[this.CHECKMETHOD_OVERLAP]},setCheckMethod:function(a){"undefined"!==typeof this[a]&&(this.checkMethod=this[a])},checkOnMe:function(a,b){b&&this.checkMethod(b.getBounds().translateV(b.pos))&&this.drop(b)},drop:function(){},destroy:function(){b.unsubscribe(b.DRAGEND,
this.checkOnMe)}})}(me.Entity,me.event);
(function(){var a=function(){var a=me.video.createCanvas(1,1),c=me.CanvasRenderer.getContext2d(a);c.fillStyle="#fff";c.fillRect(0,0,1,1);return a}();me.ParticleEmitterSettings={width:0,height:0,image:a,totalParticles:50,angle:Math.PI/2,angleVariation:0,minLife:1E3,maxLife:3E3,speed:2,speedVariation:1,minRotation:0,maxRotation:0,minStartScale:1,maxStartScale:1,minEndScale:0,maxEndScale:0,gravity:0,wind:0,followTrajectory:!1,textureAdditive:!1,onlyInViewport:!0,floating:!1,maxParticles:10,frequency:100,
duration:Infinity,framesToSkip:0};me.ParticleEmitter=me.Rect.extend({init:function(a,c,d){this._stream=!1;this._durationTimer=this._frequencyTimer=0;this.isRenderable=this._enabled=!1;me.Rect.prototype.init.apply(this,[a,c,Infinity,Infinity]);this.autoSort=!1;this.container=new me.ParticleContainer(this);Object.defineProperty(this,"z",{get:function(){return this.container.z},set:function(a){this.container.z=a},enumerable:!0,configurable:!0});Object.defineProperty(this,"floating",{get:function(){return this.container.floating},
set:function(a){this.container.floating=a},enumerable:!0,configurable:!0});this.reset(d)},destroy:function(){this.reset()},getRandomPoint:function(){var a=this.pos.clone();a.x+=(0).randomFloat(this.width);a.y+=(0).randomFloat(this.height);return a},reset:function(a){a=a||{};var c=me.ParticleEmitterSettings;this.resize("number"===typeof a.width?a.width:c.width,"number"===typeof a.height?a.height:c.height);this.image=a.image||c.image;this.totalParticles="number"===typeof a.totalParticles?a.totalParticles:
c.totalParticles;this.angle="number"===typeof a.angle?a.angle:c.angle;this.angleVariation="number"===typeof a.angleVariation?a.angleVariation:c.angleVariation;this.minLife="number"===typeof a.minLife?a.minLife:c.minLife;this.maxLife="number"===typeof a.maxLife?a.maxLife:c.maxLife;this.speed="number"===typeof a.speed?a.speed:c.speed;this.speedVariation="number"===typeof a.speedVariation?a.speedVariation:c.speedVariation;this.minRotation="number"===typeof a.minRotation?a.minRotation:c.minRotation;this.maxRotation=
"number"===typeof a.maxRotation?a.maxRotation:c.maxRotation;this.minStartScale="number"===typeof a.minStartScale?a.minStartScale:c.minStartScale;this.maxStartScale="number"===typeof a.maxStartScale?a.maxStartScale:c.maxStartScale;this.minEndScale="number"===typeof a.minEndScale?a.minEndScale:c.minEndScale;this.maxEndScale="number"===typeof a.maxEndScale?a.maxEndScale:c.maxEndScale;this.gravity="number"===typeof a.gravity?a.gravity:c.gravity;this.wind="number"===typeof a.wind?a.wind:c.wind;this.followTrajectory=
"boolean"===typeof a.followTrajectory?a.followTrajectory:c.followTrajectory;this.textureAdditive="boolean"===typeof a.textureAdditive?a.textureAdditive:c.textureAdditive;this.onlyInViewport="boolean"===typeof a.onlyInViewport?a.onlyInViewport:c.onlyInViewport;this.floating="boolean"===typeof a.floating?a.floating:c.floating;this.maxParticles="number"===typeof a.maxParticles?a.maxParticles:c.maxParticles;this.frequency="number"===typeof a.frequency?a.frequency:c.frequency;this.duration="number"===
typeof a.duration?a.duration:c.duration;this.framesToSkip="number"===typeof a.framesToSkip?a.framesToSkip:c.framesToSkip;this.container.destroy()},addParticles:function(a){for(var c=0;c<~~a;c++){var d=me.pool.pull("me.Particle",this);this.container.addChild(d)}},isRunning:function(){return this._enabled&&this._stream},streamParticles:function(a){this._stream=this._enabled=!0;this.frequency=Math.max(this.frequency,1);this._durationTimer="number"===typeof a?a:this.duration},stopStream:function(){this._enabled=
!1},burstParticles:function(a){this._enabled=!0;this._stream=!1;this.addParticles("number"===typeof a?a:this.totalParticles);this._enabled=!1},update:function(a){if(this._enabled&&this._stream){if(Infinity!==this._durationTimer&&(this._durationTimer-=a,0>=this._durationTimer))return this.stopStream(),!1;this._frequencyTimer+=a;a=this.container.children.length;a<this.totalParticles&&this._frequencyTimer>=this.frequency&&(a+this.maxParticles<=this.totalParticles?this.addParticles(this.maxParticles):
this.addParticles(this.totalParticles-a),this._frequencyTimer=0)}return!0}})})();
(function(){me.ParticleContainer=me.Container.extend({init:function(a){me.Container.prototype.init.apply(this);this.autoSort=!1;this._dt=this._updateCount=0;this._emitter=a;this.bounds=me.game.viewport},getBounds:function(){return this.bounds},update:function(a){++this._updateCount>this._emitter.framesToSkip&&(this._updateCount=0);if(0<this._updateCount)return this._dt+=a,!1;a+=this._dt;this._dt=0;for(var b=me.game.viewport,c=this.children.length-1;0<=c;--c){var d=this.children[c];d.isRenderable=
!0;d.inViewport=this.floating||d.pos.x<b.pos.x+b.width&&b.pos.x<d.pos.x+d.width&&d.pos.y<b.pos.y+b.height&&b.pos.y<d.pos.y+d.height;d.update(a)||this.removeChildNow(d)}return!0},draw:function(a,b){if(0<this.children.length){var c;this._emitter.textureAdditive&&(c=a.globalCompositeOperation,a.globalCompositeOperation="lighter");me.Container.prototype.draw.apply(this,[a,b]);this._emitter.textureAdditive&&(a.globalCompositeOperation=c)}}})})();
(function(){me.Particle=me.Renderable.extend({init:function(a){var b=a.getRandomPoint();me.Renderable.prototype.init.apply(this,[b.x,b.y,a.image.width,a.image.height]);this.alwaysUpdate=!0;this.isRenderable=!1;this.image=a.image;var b=a.angle+(0<a.angleVariation?(-1).random(2)*a.angleVariation:0),c=a.speed+(0<a.speedVariation?(-1).random(2)*a.speedVariation:0);this.vel=new me.Vector2d(c*Math.cos(b),-c*Math.sin(b));this.startLife=this.life=a.minLife.random(a.maxLife);this.startScale=a.minStartScale.randomFloat(a.maxStartScale).clamp(a.minStartScale,
a.maxStartScale);this.endScale=a.minEndScale.randomFloat(a.maxEndScale).clamp(a.minEndScale,a.maxEndScale);this.gravity=a.gravity;this.wind=a.wind;this.followTrajectory=a.followTrajectory;this.onlyInViewport=a.onlyInViewport;this.z=a.z;this._deltaInv=me.sys.fps/1E3;this.transform=new me.Matrix2d;a.followTrajectory||(this.angle=a.minRotation.randomFloat(a.maxRotation))},update:function(a){var b=a*this._deltaInv;this.life=this.life>a?this.life-a:0;var c=this.life/this.startLife;a=this.startScale;this.startScale>
this.endScale?(a*=c,a=a<this.endScale?this.endScale:a):this.startScale<this.endScale&&(a/=c,a=a>this.endScale?this.endScale:a);this.alpha=c;this.vel.x+=this.wind*b;this.vel.y+=this.gravity*b;c=this.followTrajectory?Math.atan2(this.vel.y,this.vel.x):this.angle;this.transform.set(a,0,0,a,0,0).rotate(c);this.pos.x+=this.vel.x*b;this.pos.y+=this.vel.y*b;return(this.inViewport||!this.onlyInViewport)&&0<this.life},draw:function(a){a.save();a.setGlobalAlpha(a.globalAlpha()*this.alpha);var b=this.transform.val;
a.transform(b[0],b[1],b[2],b[3],~~this.pos.x,~~this.pos.y);var b=this.width,c=this.height;a.drawImage(this.image,0,0,b,c,-b/2,-c/2,b,c);a.restore()}})})(window);
